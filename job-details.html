<!-- 
  path: /job-details.html
  version: 10.7 (Enhanced Modal Title Contrast)
  date: 2025-09-05
  time: 22:40:00
  description: Fixed modal title contrast with darker text and enhanced header styling
-->
<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>รายละเอียดงาน - Light Measurement System</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/choices.js/public/assets/styles/choices.min.css"/>

    <link rel="stylesheet" href="assets/css/main-styles.css">
    <link rel="stylesheet" href="assets/css/sidebar.css">
    <link rel="stylesheet" href="assets/css/components.css">
    
    <style>
        /* Modern Button Styles */
        .modern-btn {
            position: relative;
            background: linear-gradient(135deg, var(--bs-btn-bg), calc(var(--bs-btn-bg) + 10%)) !important;
            border: none !important;
            border-radius: 8px !important;
            font-weight: 500;
            letter-spacing: 0.3px;
            text-transform: none;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1), 0 1px 2px rgba(0,0,0,0.05);
            overflow: hidden;
        }
        
        .modern-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, rgba(255,255,255,0.2), transparent);
            opacity: 0;
            transition: opacity 0.2s ease;
        }
        
        .modern-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15), 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .modern-btn:hover::before {
            opacity: 1;
        }
        
        .modern-btn:active {
            transform: translateY(0);
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        /* Specific color enhancements */
        .btn-primary.modern-btn {
            background: linear-gradient(135deg, #007bff, #0056b3) !important;
            color: white !important;
        }
        
        .btn-success.modern-btn {
            background: linear-gradient(135deg, #28a745, #1e7e34) !important;
            color: white !important;
        }
        
        .btn-warning.modern-btn {
            background: linear-gradient(135deg, #ffc107, #e0a800) !important;
            color: #212529 !important;
        }
        
        .btn-info.modern-btn {
            background: linear-gradient(135deg, #17a2b8, #117a8b) !important;
            color: white !important;
        }
        
        .btn-secondary.modern-btn {
            background: linear-gradient(135deg, #6c757d, #545b62) !important;
            color: white !important;
        }
        
        .btn-outline-secondary.modern-btn {
            background: linear-gradient(135deg, #ffffff, #f8f9fa) !important;
            border: 2px solid #6c757d !important;
            color: #495057 !important;
            font-weight: 600;
        }
        
        .btn-outline-secondary.modern-btn:hover {
            background: linear-gradient(135deg, #6c757d, #545b62) !important;
            color: white !important;
        }
        
        .btn-outline-primary.modern-btn {
            background: linear-gradient(135deg, #ffffff, #f8f9fa) !important;
            border: 2px solid #007bff !important;
            color: #0056b3 !important;
            font-weight: 600;
        }
        
        .btn-outline-primary.modern-btn:hover {
            background: linear-gradient(135deg, #007bff, #0056b3) !important;
            color: white !important;
        }
        
        .btn-outline-success.modern-btn {
            background: linear-gradient(135deg, #ffffff, #f8f9fa) !important;
            border: 2px solid #28a745 !important;
            color: #1e7e34 !important;
            font-weight: 600;
        }
        
        .btn-outline-success.modern-btn:hover {
            background: linear-gradient(135deg, #28a745, #1e7e34) !important;
            color: white !important;
        }
        
        .btn-outline-danger.modern-btn {
            background: linear-gradient(135deg, #ffffff, #f8f9fa) !important;
            border: 2px solid #dc3545 !important;
            color: #c82333 !important;
            font-weight: 600;
        }
        
        .btn-outline-danger.modern-btn:hover {
            background: linear-gradient(135deg, #dc3545, #c82333) !important;
            color: white !important;
        }
        
        .btn-outline-warning.modern-btn {
            background: linear-gradient(135deg, #ffffff, #f8f9fa) !important;
            border: 2px solid #ffc107 !important;
            color: #d39e00 !important;
            font-weight: 600;
        }
        
        .btn-outline-warning.modern-btn:hover {
            background: linear-gradient(135deg, #ffc107, #e0a800) !important;
            color: #212529 !important;
        }
        
        .btn-outline-info.modern-btn {
            background: linear-gradient(135deg, #ffffff, #f8f9fa) !important;
            border: 2px solid #17a2b8 !important;
            color: #117a8b !important;
            font-weight: 600;
        }
        
        .btn-outline-info.modern-btn:hover {
            background: linear-gradient(135deg, #17a2b8, #117a8b) !important;
            color: white !important;
        }
        
        /* Icon spacing improvements */
        .modern-btn i {
            vertical-align: middle;
        }
        
        /* Small button adjustments */
        .modern-btn.btn-sm {
            padding: 0.375rem 0.75rem;
            font-size: 0.875rem;
            border-radius: 6px !important;
        }
        
        /* Modal improvements */
        .modal-title {
            color: #000000 !important;
            font-weight: 700;
            font-size: 1.125rem;
            text-shadow: 0 0 1px rgba(0,0,0,0.5);
        }
        
        .modal-header {
            background: linear-gradient(135deg, #ffffff, #f1f3f5) !important;
            border-bottom: 3px solid #dee2e6;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
    </style>
</head>
<body>
    
    <div id="wrapper">

        <!-- Sidebar -->
        <div id="sidebar-wrapper">
            <div class="sidebar-heading">
                <div class="sidebar-brand-icon">
                    <i class="fas fa-lightbulb"></i>
                </div>
                <div class="sidebar-brand-text logo-text">
                    <div>Light Meter</div>
                    <small style="font-size: 0.7rem; opacity: 0.8;">System</small>
                </div>
            </div>
            <div class="list-group list-group-flush">
                <a href="main.html" class="list-group-item list-group-item-action active">
                    <i class="fas fa-home fa-fw me-3"></i>
                    <span class="menu-text">หน้าแรก</span>
                </a>
                <a href="new-job.html" class="list-group-item list-group-item-action">
                    <i class="fas fa-plus-circle fa-fw me-3"></i>
                    <span class="menu-text">สร้างงานใหม่</span>
                </a>
                <a href="master-data-manager.html" class="list-group-item list-group-item-action">
                    <i class="fas fa-database fa-fw me-3"></i>
                    <span class="menu-text">จัดการข้อมูลหลัก</span>
                </a>
                <a href="template-manager.html" class="list-group-item list-group-item-action">
                    <i class="fas fa-file-alt fa-fw me-3"></i>
                    <span class="menu-text">จัดการ Template</span>
                </a>
            </div>
        </div>

        <!-- Page Content -->
        <div id="page-content-wrapper">
            <nav class="navbar navbar-expand-lg navbar-light bg-white border-bottom sticky-top">
                <div class="container-fluid">
                    <button class="btn btn-outline-primary me-2" id="sidebarToggle">
                        <i class="fas fa-bars"></i>
                    </button>
                    <ul class="navbar-nav ms-auto d-flex flex-row">
                        <li class="nav-item dropdown">
                            <a class="nav-link dropdown-toggle d-flex align-items-center" href="#" id="userDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                                <i class="fas fa-user-circle fa-2x text-muted"></i>
                            </a>
                            <ul class="dropdown-menu dropdown-menu-end">
                                <li><h6 class="dropdown-header">User Profile</h6></li>
                                <li><a class="dropdown-item" href="#"><span id="user-display">Connecting...</span></a></li>
                            </ul>
                        </li>
                    </ul>
                </div>
            </nav>

            <main class="container-fluid p-2">
                <div id="alert-placeholder"></div>
                
                <!-- Compact Header Section -->
                <div class="d-flex justify-content-between align-items-center mb-2 py-2 border-bottom">
                    <div>
                        <h4 class="mb-1 fs-6">
                            งาน: <span id="job-id-display" class="text-primary fw-bold">Loading...</span>
                        </h4>
                        <div class="d-flex align-items-center small text-muted">
                            <span id="job-customer">Loading...</span>
                            <span class="mx-2">•</span>
                            <span id="job-date">Loading...</span>
                        </div>
                    </div>
                    <div class="d-flex gap-1">
                        <a href="main.html" class="btn btn-outline-secondary btn-sm modern-btn">
                            <i class="fas fa-arrow-left me-1"></i>กลับ
                        </a>
                        <a href="#" id="edit-job-btn" class="btn btn-warning btn-sm modern-btn">
                            <i class="fas fa-edit me-1"></i>แก้ไข
                        </a>
                        <button id="save-data-btn" class="btn btn-success btn-sm modern-btn">
                            <i class="fas fa-save me-1"></i>บันทึก
                        </button>
                        <a href="#" id="generate-report-btn" class="btn btn-primary btn-sm modern-btn">
                            <i class="fas fa-file-pdf me-1"></i>รายงาน
                        </a>
                    </div>
                </div>

                <!-- Compact Template & Tools Section -->
                <div class="card mb-2">
                    <div class="card-body p-2">
                        <div class="row g-2 align-items-center">
                            <div class="col-md-3">
                                <select id="template-selector" class="form-select form-select-sm">
                                    <option value="">เลือก Template</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <input type="text" id="template-name-input" class="form-control form-control-sm" placeholder="ชื่อ Template ใหม่...">
                            </div>
                            <div class="col-md-6 d-flex gap-1">
                                <button id="load-template-btn" class="btn btn-info btn-sm modern-btn">
                                    <i class="fas fa-download me-1"></i>โหลด
                                </button>
                                <button id="save-template-btn" class="btn btn-success btn-sm modern-btn">
                                    <i class="fas fa-save me-1"></i>บันทึก
                                </button>
                                <!-- Tools moved here -->
                                <button id="default-values-btn" class="btn btn-secondary btn-sm modern-btn" data-bs-toggle="modal" data-bs-target="#defaultValuesModal">
                                    <i class="fas fa-cogs me-1"></i>ค่าเริ่มต้น
                                </button>
                                <button id="create-rows-btn" class="btn btn-info btn-sm modern-btn" data-bs-toggle="modal" data-bs-target="#createRowsModal">
                                    <i class="fas fa-plus me-1"></i>สร้างแถว
                                </button>
                                <button id="bulk-edit-btn" class="btn btn-warning btn-sm modern-btn" data-bs-toggle="modal" data-bs-target="#bulkEditModal">
                                    <i class="fas fa-edit me-1"></i>แก้ไขหลายแถว
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Quick Add Buttons -->
                <div class="d-flex gap-1 mb-2">
                    <button id="add-spot-row-btn" class="btn btn-primary btn-sm modern-btn">
                        <i class="fas fa-plus me-1"></i>จุด
                    </button>
                    <button id="add-area-row-btn" class="btn btn-primary btn-sm modern-btn">
                        <i class="fas fa-plus me-1"></i>พื้นที่
                    </button>
                    <div class="ms-auto small text-muted">
                        <i class="fas fa-info-circle"></i> Enter/Tab: ช่องถัดไป | Ctrl+S: บันทึก
                    </div>
                </div>

                <!-- Compact Results Table Section -->
                <div class="card">
                    <div class="card-header p-2">
                        <div class="row align-items-center g-2">
                            <div class="col-md-6">
                                <h6 class="mb-0">
                                    <i class="fas fa-table"></i> ผลการตรวจวัด
                                    <span id="result-count" class="badge bg-secondary ms-1">0</span>
                                </h6>
                            </div>
                            <div class="col-md-6">
                                <div class="d-flex gap-2">
                                    <div class="flex-grow-1">
                                        <input type="text" id="table-search" class="form-control form-control-sm" 
                                               placeholder="🔍 ค้นหา (Layout, พื้นที่, หมายเหตุ...)">
                                    </div>
                                    <select id="table-filter-worktype" class="form-select form-select-sm" style="width: 200px; padding: 0.375rem 0.75rem; font-size: 0.875rem;">
                                        <option value="">ลักษณะงานทั้งหมด</option>
                                    </select>
                                    <select id="table-filter-result" class="form-select form-select-sm" style="width: 120px; padding: 0.375rem 0.75rem; font-size: 0.875rem;">
                                        <option value="">ผลทั้งหมด</option>
                                        <option value="ผ่าน">ผ่าน</option>
                                        <option value="ไม่ผ่าน">ไม่ผ่าน</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="card-body p-1">
                        <div class="table-responsive">
                            <table class="table table-hover table-bordered table-sm mb-0" style="font-size: 0.85rem;">
                                <thead class="table-light">
                                    <tr class="text-center">
                                        <th style="width: 3%;">#</th>
                                        <th style="width: 10%;">Layout</th>
                                        <th style="width: 13%;">พื้นที่</th>
                                        <th style="width: 11%;">ลักษณะงาน</th>
                                        <th style="width: 5%;">ประเภท</th>
                                        <th style="width: 8%;">มาตรฐาน</th>
                                        <th style="width: 10%;">ผลวัด</th>
                                        <th style="width: 6%;">ผล</th>
                                        <th style="width: 15%;">หมายเหตุ</th>
                                        <th style="width: 3%;">ลบ</th>
                                    </tr>
                                </thead>
                                <tbody id="results-table-body">
                                    <tr id="no-data-row">
                                        <td colspan="10" class="text-center p-3">
                                            <i class="fas fa-clipboard-list fa-2x text-muted mb-2"></i>
                                            <p class="text-muted mb-0 small">ยังไม่มีข้อมูลการตรวจวัด - คลิกปุ่มด้านบนเพื่อเริ่มต้น</p>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Recommendations Section -->
                <div class="card">
                    <div class="card-header">
                        <h6 class="mb-0"><i class="fas fa-lightbulb me-2"></i>ข้อเสนอแนะและข้อสังเกต</h6>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label for="recommendations" class="form-label">ข้อเสนอแนะสำหรับจุดที่ไม่ผ่านเกณฑ์</label>
                            <textarea id="recommendations" class="form-control" rows="4" placeholder="ข้อเสนอแนะสำหรับการปรับปรุงระดับแสงสว่าง เช่น &#10;- เพิ่มจำนวนหลอดไฟในพื้นที่ที่มีค่าแสงสว่างไม่เพียงพอ&#10;- เปลี่ยนหลอดไฟเป็นแบบให้แสงสว่างมากกว่าเดิม&#10;- ตรวจสอบและทำความสะอาดหลอดไฟเป็นประจำ&#10;- ปรับตำแหน่งการจัดวางโต๊ะทำงานให้รับแสงได้ดีขึ้น"></textarea>
                        </div>
                        <div class="mb-3">
                            <label for="observations" class="form-label">ข้อสังเกตและหมายเหตุ</label>
                            <textarea id="observations" class="form-control" rows="3" placeholder="ข้อสังเกตเพิ่มเติม เช่น สภาพแวดล้อม สภาพอุปกรณ์ หรือข้อจำกัดในการตรวจวัด"></textarea>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Modal: Default Values -->
    <div class="modal fade" id="defaultValuesModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-wrench me-2"></i>ตั้งค่าเริ่มต้น
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="default-values-form">
                        <div class="mb-3">
                            <label for="default-area" class="form-label">พื้นที่ตรวจวัด (เริ่มต้น)</label>
                            <input type="text" id="default-area" class="form-control form-control-sm" placeholder="เช่น โต๊ะทำงาน, ห้องประชุม">
                        </div>
                        <div class="mb-3">
                            <label for="default-work-type" class="form-label">ลักษณะงาน (เริ่มต้น)</label>
                            <select id="default-work-type" class="form-select form-select-sm">
                                <option value="">-- เลือกลักษณะงาน --</option>
                            </select>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary btn-sm modern-btn" data-bs-dismiss="modal">ปิด</button>
                    <button type="button" id="apply-defaults-btn" class="btn btn-primary btn-sm modern-btn">
                        <i class="fas fa-check me-2"></i>ตั้งค่า
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal: Bulk Edit -->
    <div class="modal fade" id="bulkEditModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-edit me-2"></i>แก้ไขแถวทั้งหมด
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        เลือกช่องที่ต้องการแก้ไข จะใช้กับแถวที่ถูกเลือกทั้งหมด
                    </div>
                    <form id="bulk-edit-form">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="bulk-edit-area-check">
                                        <label class="form-check-label" for="bulk-edit-area-check">
                                            พื้นที่ตรวจวัด
                                        </label>
                                    </div>
                                    <input type="text" id="bulk-edit-area" class="form-control mt-2" 
                                           placeholder="พื้นที่ใหม่..." disabled>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="bulk-edit-worktype-check">
                                        <label class="form-check-label" for="bulk-edit-worktype-check">
                                            ลักษณะงาน
                                        </label>
                                    </div>
                                    <select id="bulk-edit-worktype" class="form-select mt-2" disabled>
                                        <option value="">-- เลือกลักษณะงาน --</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="bulk-edit-measurement-check">
                                        <label class="form-check-label" for="bulk-edit-measurement-check">
                                            ประเภทการวัด
                                        </label>
                                    </div>
                                    <select id="bulk-edit-measurement" class="form-select mt-2" disabled>
                                        <option value="spot">จุด</option>
                                        <option value="area">พื้นที่</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="bulk-edit-remark-check">
                                        <label class="form-check-label" for="bulk-edit-remark-check">
                                            หมายเหตุ
                                        </label>
                                    </div>
                                    <input type="text" id="bulk-edit-remark" class="form-control mt-2" 
                                           placeholder="หมายเหตุใหม่..." disabled>
                                </div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">แถวที่จะแก้ไข:</label>
                            <div id="bulk-edit-row-selection" class="border p-2 rounded" style="max-height: 200px; overflow-y: auto;">
                                <!-- Rows will be populated here -->
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary btn-sm modern-btn" data-bs-dismiss="modal">ยกเลิก</button>
                    <button type="button" id="apply-bulk-edit-btn" class="btn btn-primary btn-sm modern-btn">
                        <i class="fas fa-check me-2"></i>แก้ไขแถวที่เลือก
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal: Create Rows -->
    <div class="modal fade" id="createRowsModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-plus me-2"></i>สร้างแถวหลายแถว
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="bulk-add-form">
                        <div class="mb-3">
                            <label for="row-count-input" class="form-label">จำนวนแถวที่ต้องการสร้าง</label>
                            <input type="number" id="row-count-input" class="form-control form-control-sm" value="10" min="1" max="100">
                        </div>
                        <div class="mb-3">
                            <label for="layout-pattern" class="form-label">รูปแบบ Lay Out</label>
                            <input type="text" id="layout-pattern" class="form-control form-control-sm" value="Lay Out จุดที่ {x}">
                            <div class="form-text">ใช้ <strong>{x}</strong> แทน Running Number</div>
                        </div>
                        <div class="mb-3">
                            <label for="start-number" class="form-label">เริ่มนับที่</label>
                            <input type="number" id="start-number" class="form-control form-control-sm" value="1" min="1">
                        </div>
                        <div class="mb-3">
                            <label for="bulk-area" class="form-label">พื้นที่ตรวจวัด (เริ่มต้น)</label>
                            <input type="text" id="bulk-area" class="form-control form-control-sm">
                        </div>
                        <div class="mb-3">
                            <label for="bulk-work-type" class="form-label">ลักษณะงาน (เริ่มต้น)</label>
                            <select id="bulk-work-type" class="form-select form-select-sm">
                                <option value="">-- เลือกลักษณะงาน --</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="bulk-measurement-type" class="form-label">ประเภทการตรวจวัด</label>
                            <select id="bulk-measurement-type" class="form-select form-select-sm">
                                <option value="spot">แบบจุด (Spot)</option>
                                <option value="area">แบบพื้นที่ (Area)</option>
                            </select>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary btn-sm modern-btn" data-bs-dismiss="modal">ยกเลิก</button>
                    <button type="button" id="execute-create-rows" class="btn btn-primary btn-sm modern-btn">
                        <i class="fas fa-plus-circle me-2"></i>สร้างแถว
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/choices.js/public/assets/scripts/choices.min.js"></script>
    <script src="firebase-config.js"></script>
    <script type="module">
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'light-measuring-app';
        let workTypes = [];
        let choicesInstances = new Map();
        let jobId = null;
        let defaultValues = { area: '', workType: '' };
        let autoSaveTimer = null;
        let isDataChanged = false;

        import { firebaseManager, onSnapshot, addDoc } from './assets/js/firebase-init.js?v=1.1';
        import { showAlert, formatDate, showLoading, hideLoading } from './assets/js/ui-helpers.js?v=1.1';

        // Global variables - will be initialized after DOM loads
        let tbody;

        // Create table row
        const createTableRow = (data = {}) => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td class="text-center row-number">1</td>
                <td>
                    <input type="text" class="form-control form-control-sm" data-field="layout" value="${data.layout || ''}" 
                           placeholder="Lay Out จุดที่...">
                </td>
                <td>
                    <input type="text" class="form-control form-control-sm" data-field="area" 
                           value="${data.area || defaultValues.area}" placeholder="พื้นที่ตรวจวัด">
                </td>
                <td>
                    <select class="work-type-select form-select form-select-sm" data-field="workType">
                        <option value="">-- เลือกลักษณะงาน --</option>
                        ${workTypes.map(w => {
                            const selectedValue = data.workType || defaultValues.workType;
                            return `<option value="${w.id}" ${selectedValue === w.id ? 'selected' : ''}>${w.workTypeName}</option>`;
                        }).join('')}
                    </select>
                </td>
                <td>
                    <select class="form-select form-select-sm" data-field="measurementType">
                        <option value="spot" ${(!data.measurementType || data.measurementType === 'spot') ? 'selected' : ''}>จุด</option>
                        <option value="area" ${data.measurementType === 'area' ? 'selected' : ''}>พื้นที่</option>
                    </select>
                </td>
                <td class="text-center standard-display">-</td>
                <td class="result-inputs"></td>
                <td class="text-center result-evaluation">-</td>
                <td>
                    <input type="text" class="form-control form-control-sm" data-field="remark" 
                           value="${data.remark || ''}" placeholder="หมายเหตุ...">
                </td>
                <td class="text-center">
                    <i class="fas fa-trash-alt action-icon delete-row-btn" title="ลบแถวนี้"></i>
                </td>
            `;
            
            updateRowDisplays(row);
            // Add auto-save listeners to the new row
            setupAutoSaveListeners(row);
            return row;
        };
        
        // Auto-save functionality
        const setupAutoSaveListeners = (row) => {
            const inputs = row.querySelectorAll('input, select');
            inputs.forEach(input => {
                input.addEventListener('input', () => {
                    isDataChanged = true;
                    clearTimeout(autoSaveTimer);
                    autoSaveTimer = setTimeout(autoSaveData, 3000); // Auto-save after 3 seconds
                });
                input.addEventListener('change', () => {
                    isDataChanged = true;
                    clearTimeout(autoSaveTimer);
                    autoSaveTimer = setTimeout(autoSaveData, 1000); // Faster save on change
                });
            });
        };
        
        const autoSaveData = async () => {
            if (!isDataChanged || !jobId) return;
            
            try {
                // Using global tbody
                const results = [];
                const rows = tbody.querySelectorAll('tr:not(#no-data-row)');
                
                rows.forEach(row => {
                    const result = {
                        layout: row.querySelector('[data-field="layout"]').value,
                        area: row.querySelector('[data-field="area"]').value,
                        workType: row.querySelector('[data-field="workType"]').value,
                        measurementType: row.querySelector('[data-field="measurementType"]').value,
                        standard: row.querySelector('.standard-display').textContent,
                        evaluation: row.querySelector('.result-evaluation').textContent,
                        remark: row.querySelector('[data-field="remark"]').value || ''
                    };
                    
                    // Add measurement values
                    if (result.measurementType === 'spot') {
                        const spotInput = row.querySelector('[data-field="spotValue"]');
                        result.spotValue = spotInput ? spotInput.value : null;
                    } else {
                        const avgInput = row.querySelector('[data-field="areaAvgValue"]');
                        const minInput = row.querySelector('[data-field="areaMinValue"]');
                        result.areaAvgValue = avgInput ? avgInput.value : null;
                        result.areaMinValue = minInput ? minInput.value : null;
                    }
                    
                    results.push(result);
                });
                
                // Include recommendations data
                const recommendations = document.getElementById('recommendations').value || '';
                const observations = document.getElementById('observations').value || '';
                
                await firebaseManager.updateDocument('jobs', jobId, {
                    results: results,
                    recommendations: recommendations,
                    observations: observations,
                    lastUpdated: new Date().toISOString(),
                    status: results.length > 0 ? 'in-progress' : 'new'
                });
                
                // Show subtle save indicator
                const saveIndicator = document.createElement('div');
                saveIndicator.innerHTML = '<i class="fas fa-check-circle text-success"></i> บันทึกอัตโนมัติแล้ว';
                saveIndicator.className = 'position-fixed top-0 end-0 m-3 alert alert-success alert-dismissible fade show';
                saveIndicator.style.zIndex = '9999';
                document.body.appendChild(saveIndicator);
                
                setTimeout(() => {
                    if (saveIndicator.parentNode) {
                        saveIndicator.remove();
                    }
                }, 2000);
                
                isDataChanged = false;
            } catch (error) {
                console.error('Auto-save failed:', error);
            }
        };
        
        // LUX value validation
        const validateLuxValue = (input, showError = true) => {
            const value = input.value.trim();
            let isValid = true;
            let errorMessage = '';
            
            // Remove existing error styling
            input.classList.remove('is-invalid');
            const existingError = input.parentNode.querySelector('.invalid-feedback');
            if (existingError) {
                existingError.remove();
            }
            
            if (value === '') {
                return true; // Empty is okay, not required
            }
            
            // Check if it's a valid number
            const numValue = parseFloat(value);
            if (isNaN(numValue)) {
                isValid = false;
                errorMessage = 'กรุณาใส่ตัวเลขเท่านั้น';
            } else if (numValue < 0) {
                isValid = false;
                errorMessage = 'ค่าแสงต้องไม่ติดลบ';
            } else if (numValue > 100000) {
                isValid = false;
                errorMessage = 'ค่าแสงสูงเกินไป (> 100,000 LUX)';
            } else if (value.includes('.') && value.split('.')[1].length > 1) {
                // Allow max 1 decimal place
                isValid = false;
                errorMessage = 'ทศนิยมได้ไม่เกิน 1 ตำแหน่ง';
            }
            
            if (!isValid && showError) {
                input.classList.add('is-invalid');
                const errorDiv = document.createElement('div');
                errorDiv.className = 'invalid-feedback';
                errorDiv.textContent = errorMessage;
                input.parentNode.appendChild(errorDiv);
            }
            
            return isValid;
        };
        
        // Format LUX value (add commas for thousands)
        const formatLuxValue = (input) => {
            const value = input.value.trim();
            if (value && !isNaN(parseFloat(value))) {
                const num = parseFloat(value);
                input.value = num.toLocaleString('en-US', {
                    minimumFractionDigits: 0,
                    maximumFractionDigits: 1
                });
            }
        };

        // Update row displays based on work type and measurement type
        const updateRowDisplays = (row) => {
            const workTypeSelect = row.querySelector('[data-field="workType"]');
            const measurementTypeSelect = row.querySelector('[data-field="measurementType"]');
            const standardDisplay = row.querySelector('.standard-display');
            const resultInputs = row.querySelector('.result-inputs');
            
            const selectedWorkType = workTypes.find(w => w.id === workTypeSelect.value);
            const measurementType = measurementTypeSelect.value;
            
            if (!selectedWorkType) {
                standardDisplay.textContent = '-';
                resultInputs.innerHTML = '';
                updateResultEvaluation(row);
                return;
            }
            
            if (measurementType === 'spot') {
                const min = selectedWorkType.stdSpotMin || 'N/A';
                const max = selectedWorkType.stdSpotMax || 'N/A';
                standardDisplay.textContent = `${min}-${max}`;
                resultInputs.innerHTML = `
                    <input type="number" class="form-control form-control-sm text-center lux-input" 
                           data-field="spotValue" placeholder="LUX" min="0" step="0.1">
                `;
            } else {
                const avgMin = selectedWorkType.stdAreaAvg || 'N/A';
                const minMin = selectedWorkType.stdAreaMin || 'N/A';
                standardDisplay.innerHTML = `Avg≥${avgMin}<br>Min≥${minMin}`;
                resultInputs.innerHTML = `
                    <div class="d-flex gap-1">
                        <input type="number" class="form-control form-control-sm text-center lux-input" 
                               data-field="areaAvgValue" placeholder="เฉลี่ย" min="0" step="0.1">
                        <input type="number" class="form-control form-control-sm text-center lux-input" 
                               data-field="areaMinValue" placeholder="ต่ำสุด" min="0" step="0.1">
                    </div>
                `;
            }
            
            // Add validation listeners to LUX inputs
            const luxInputs = row.querySelectorAll('.lux-input');
            luxInputs.forEach(input => {
                // Validate on input (real-time)
                input.addEventListener('input', () => {
                    validateLuxValue(input);
                });
                
                // Format on blur (when user leaves the field)
                input.addEventListener('blur', () => {
                    if (validateLuxValue(input)) {
                        formatLuxValue(input);
                    }
                });
                
                // Prevent invalid characters
                input.addEventListener('keydown', (e) => {
                    // Allow: backspace, delete, tab, escape, enter
                    if ([8, 9, 27, 13, 46].includes(e.keyCode) ||
                        // Allow: Ctrl+A, Ctrl+C, Ctrl+V, Ctrl+X
                        (e.keyCode === 65 && e.ctrlKey) ||
                        (e.keyCode === 67 && e.ctrlKey) ||
                        (e.keyCode === 86 && e.ctrlKey) ||
                        (e.keyCode === 88 && e.ctrlKey) ||
                        // Allow: home, end, left, right
                        (e.keyCode >= 35 && e.keyCode <= 39)) {
                        return;
                    }
                    // Ensure that it's a number or decimal point
                    if ((e.shiftKey || (e.keyCode < 48 || e.keyCode > 57)) && 
                        (e.keyCode < 96 || e.keyCode > 105) && 
                        e.keyCode !== 190 && e.keyCode !== 110) {
                        e.preventDefault();
                    }
                    // Only allow one decimal point
                    if ((e.keyCode === 190 || e.keyCode === 110) && 
                        input.value.indexOf('.') !== -1) {
                        e.preventDefault();
                    }
                });
            });
            
            updateResultEvaluation(row);
        };

        // Update result evaluation
        const updateResultEvaluation = (row) => {
            const workTypeSelect = row.querySelector('[data-field="workType"]');
            const measurementTypeSelect = row.querySelector('[data-field="measurementType"]');
            const resultEvaluation = row.querySelector('.result-evaluation');
            
            const selectedWorkType = workTypes.find(w => w.id === workTypeSelect.value);
            const measurementType = measurementTypeSelect.value;
            
            if (!selectedWorkType) {
                resultEvaluation.textContent = '-';
                return;
            }
            
            let passed = false;
            let hasValue = false;
            
            if (measurementType === 'spot') {
                const spotInput = row.querySelector('[data-field="spotValue"]');
                if (spotInput && spotInput.value) {
                    hasValue = true;
                    const value = parseFloat(spotInput.value);
                    const min = selectedWorkType.stdSpotMin || -Infinity;
                    const max = selectedWorkType.stdSpotMax || Infinity;
                    passed = value >= min && value <= max;
                }
            } else {
                const avgInput = row.querySelector('[data-field="areaAvgValue"]');
                const minInput = row.querySelector('[data-field="areaMinValue"]');
                if (avgInput && avgInput.value && minInput && minInput.value) {
                    hasValue = true;
                    const avgValue = parseFloat(avgInput.value);
                    const minValue = parseFloat(minInput.value);
                    const avgStandard = selectedWorkType.stdAreaAvg || -Infinity;
                    const minStandard = selectedWorkType.stdAreaMin || -Infinity;
                    passed = avgValue >= avgStandard && minValue >= minStandard;
                }
            }
            
            if (hasValue) {
                resultEvaluation.innerHTML = passed ? 
                    '<span class="result-pass">ผ่าน</span>' : 
                    '<span class="result-fail">ไม่ผ่าน</span>';
            } else {
                resultEvaluation.textContent = '-';
            }
        };

        // Renumber table rows
        const renumberRows = () => {
            // Using global tbody
            const rows = tbody.querySelectorAll('tr:not(#no-data-row)');
            rows.forEach((row, index) => {
                const numberCell = row.querySelector('.row-number');
                if (numberCell) {
                    numberCell.textContent = index + 1;
                }
            });
            
            // Update result count
            const resultCount = document.getElementById('result-count');
            resultCount.textContent = `${rows.length} รายการ`;
        };

        // Remove no data row if exists
        const removeNoDataRow = () => {
            const noDataRow = document.getElementById('no-data-row');
            if (noDataRow) {
                noDataRow.remove();
            }
        };

        // Add no data row if table is empty
        const addNoDataRowIfEmpty = () => {
            // Using global tbody
            const rows = tbody.querySelectorAll('tr:not(#no-data-row)');
            if (rows.length === 0) {
                tbody.innerHTML = `
                    <tr id="no-data-row">
                        <td colspan="9" class="text-center p-4">
                            <i class="fas fa-clipboard-list fa-3x text-muted mb-3"></i>
                            <p class="text-muted mb-0">ยังไม่มีข้อมูลการตรวจวัด</p>
                            <p class="text-muted small">เริ่มต้นด้วยการคลิก "เพิ่มแถว" ด้านบน</p>
                        </td>
                    </tr>
                `;
            }
        };

        // Main initialization  
        async function main() {
            if (!await firebaseManager.initialize()) {
                showAlert('ไม่สามารถเชื่อมต่อ Firebase ได้', 'danger');
                return;
            }
            
            document.getElementById('user-display').textContent = `UID: ${firebaseManager.getCurrentUserId().substring(0, 8)}...`;
            
            try {
                // Get job ID from URL
                const params = new URLSearchParams(window.location.search);
                jobId = params.get('id');
                
                if (!jobId) {
                    showAlert('ไม่พบ Job ID ใน URL', 'danger');
                    return;
                }
                
                document.getElementById('job-id-display').textContent = jobId;
                document.getElementById('edit-job-btn').href = `new-job.html?id=${jobId}&from=job-details`;
                document.getElementById('generate-report-btn').href = `report-finalizer.html?id=${jobId}`;
                
                // Load work types
                const workTypesRef = firebaseManager.getCollection('work_types');
                onSnapshot(workTypesRef, (snapshot) => {
                    workTypes = snapshot.docs.map(doc => ({
                        id: doc.id,
                        ...doc.data()
                    }));
                    
                    // Populate dropdowns
                    const defaultWorkTypeSelect = document.getElementById('default-work-type');
                    const bulkWorkTypeSelect = document.getElementById('bulk-work-type');
                    
                    const workTypeOptions = workTypes.map(w => 
                        `<option value="${w.id}">${w.workTypeName}</option>`
                    ).join('');
                    
                    defaultWorkTypeSelect.innerHTML = '<option value="">-- เลือกลักษณะงาน --</option>' + workTypeOptions;
                    bulkWorkTypeSelect.innerHTML = '<option value="">-- เลือกลักษณะงาน --</option>' + workTypeOptions;
                });
                
                // Load job data
                const jobResult = await firebaseManager.getDocument('jobs', jobId);
                
                if (jobResult && jobResult.data) {
                    const jobData = jobResult.data;
                    console.log('Job data loaded:', jobData);
                    
                    // Update job info display
                    document.getElementById('job-customer').textContent = jobData.customerName || 'ไม่ระบุลูกค้า';
                    document.getElementById('job-date').textContent = jobData.date || 'ไม่ระบุวันที่';
                    
                    // Load existing results
                    // Using global tbody
                    if (jobData.results && jobData.results.length > 0) {
                        removeNoDataRow();
                        jobData.results.forEach(result => {
                            const row = createTableRow(result);
                            tbody.appendChild(row);
                            
                            // Set values for existing data
                            if (result.spotValue) {
                                const spotInput = row.querySelector('[data-field="spotValue"]');
                                if (spotInput) spotInput.value = result.spotValue;
                            }
                            if (result.areaAvgValue) {
                                const avgInput = row.querySelector('[data-field="areaAvgValue"]');
                                if (avgInput) avgInput.value = result.areaAvgValue;
                            }
                            if (result.areaMinValue) {
                                const minInput = row.querySelector('[data-field="areaMinValue"]');
                                if (minInput) minInput.value = result.areaMinValue;
                            }
                            if (result.remark) {
                                const remarkInput = row.querySelector('[data-field="remark"]');
                                if (remarkInput) remarkInput.value = result.remark;
                            }
                            
                            updateResultEvaluation(row);
                        });
                        renumberRows();
                    }
                    
                    // Load recommendations data
                    if (jobData.recommendations) {
                        document.getElementById('recommendations').value = jobData.recommendations;
                    }
                    if (jobData.observations) {
                        document.getElementById('observations').value = jobData.observations;
                    }
                } else {
                    showAlert('ไม่พบข้อมูลงานในระบบ', 'danger');
                }
                
                // Load templates
                const templatesRef = firebaseManager.getCollection('measurement_templates');
                onSnapshot(templatesRef, (snapshot) => {
                    const templateSelector = document.getElementById('template-selector');
                    templateSelector.innerHTML = '<option value="">-- เลือก Template --</option>';
                    
                    snapshot.docs.forEach(doc => {
                        const template = doc.data();
                        const option = document.createElement('option');
                        option.value = doc.id;
                        option.textContent = template.name;
                        templateSelector.appendChild(option);
                    });
                });
                
                // Event listeners
                setupEventListeners();
                setupSearchAndFilter();
                
            } catch (error) {
                showAlert(`เกิดข้อผิดพลาดในการเชื่อมต่อ: ${error.message}`, 'danger');
            }
        }
        
        // Search and Filter functionality
        const setupSearchAndFilter = () => {
            const searchInput = document.getElementById('table-search');
            const worktypeFilter = document.getElementById('table-filter-worktype');
            const resultFilter = document.getElementById('table-filter-result');
            
            // Populate worktype filter options when workTypes are available
            const updateWorktypeFilter = () => {
                worktypeFilter.innerHTML = '<option value="">ลักษณะงานทั้งหมด</option>';
                workTypes.forEach(w => {
                    const option = document.createElement('option');
                    option.value = w.id;
                    option.textContent = w.workTypeName;
                    worktypeFilter.appendChild(option);
                });
            };
            
            // Filter function
            const filterTable = () => {
                const searchTerm = searchInput.value.toLowerCase().trim();
                const selectedWorkType = worktypeFilter.value;
                const selectedResult = resultFilter.value;
                // Using global tbody
                const rows = tbody.querySelectorAll('tr:not(#no-data-row)');
                
                let visibleCount = 0;
                
                rows.forEach(row => {
                    let isVisible = true;
                    
                    // Search filter
                    if (searchTerm) {
                        const layout = row.querySelector('[data-field="layout"]').value.toLowerCase();
                        const area = row.querySelector('[data-field="area"]').value.toLowerCase();
                        const remark = row.querySelector('[data-field="remark"]').value.toLowerCase();
                        
                        const searchableText = `${layout} ${area} ${remark}`;
                        if (!searchableText.includes(searchTerm)) {
                            isVisible = false;
                        }
                    }
                    
                    // Work type filter
                    if (selectedWorkType) {
                        const rowWorkType = row.querySelector('[data-field="workType"]').value;
                        if (rowWorkType !== selectedWorkType) {
                            isVisible = false;
                        }
                    }
                    
                    // Result filter
                    if (selectedResult) {
                        const resultEvaluation = row.querySelector('.result-evaluation').textContent.trim();
                        if (resultEvaluation !== selectedResult) {
                            isVisible = false;
                        }
                    }
                    
                    // Show/hide row
                    if (isVisible) {
                        row.style.display = '';
                        visibleCount++;
                    } else {
                        row.style.display = 'none';
                    }
                });
                
                // Update result count
                const totalCount = rows.length;
                const resultCountBadge = document.getElementById('result-count');
                if (visibleCount === totalCount) {
                    resultCountBadge.textContent = `${totalCount} รายการ`;
                    resultCountBadge.className = 'badge bg-secondary ms-2';
                } else {
                    resultCountBadge.textContent = `${visibleCount}/${totalCount} รายการ`;
                    resultCountBadge.className = 'badge bg-warning ms-2';
                }
                
                // Show/hide no-data message when filtered
                const noDataRow = document.getElementById('no-data-row');
                if (totalCount === 0) {
                    noDataRow.style.display = '';
                } else if (visibleCount === 0 && totalCount > 0) {
                    // Show "no results found" message
                    if (!document.getElementById('no-results-row')) {
                        const noResultsRow = document.createElement('tr');
                        noResultsRow.id = 'no-results-row';
                        noResultsRow.innerHTML = `
                            <td colspan="10" class="text-center p-4">
                                <i class="fas fa-search fa-2x text-muted mb-2"></i>
                                <p class="text-muted mb-0">ไม่พบรายการที่ตรงกับเงื่อนไขการค้นหา</p>
                                <p class="text-muted small">ลองเปลี่ยนคำค้นหาหรือเงื่อนไขกรอง</p>
                            </td>
                        `;
                        tbody.appendChild(noResultsRow);
                    }
                    document.getElementById('no-results-row').style.display = '';
                    noDataRow.style.display = 'none';
                } else {
                    const noResultsRow = document.getElementById('no-results-row');
                    if (noResultsRow) {
                        noResultsRow.style.display = 'none';
                    }
                    noDataRow.style.display = 'none';
                }
            };
            
            // Add event listeners
            searchInput.addEventListener('input', filterTable);
            worktypeFilter.addEventListener('change', filterTable);
            resultFilter.addEventListener('change', filterTable);
            
            // Update worktype filter when data is loaded
            setTimeout(updateWorktypeFilter, 1000);
        };
        
        // Setup event listeners
        function setupEventListeners() {
            // Using global tbody
            
            // Add row buttons
            document.getElementById('add-spot-row-btn').addEventListener('click', () => {
                removeNoDataRow();
                const row = createTableRow({ measurementType: 'spot' });
                tbody.appendChild(row);
                renumberRows();
                
                // Focus on first input
                const firstInput = row.querySelector('input');
                if (firstInput) firstInput.focus();
            });
            
            document.getElementById('add-area-row-btn').addEventListener('click', () => {
                removeNoDataRow();
                const row = createTableRow({ measurementType: 'area' });
                tbody.appendChild(row);
                renumberRows();
                
                // Focus on first input
                const firstInput = row.querySelector('input');
                if (firstInput) firstInput.focus();
            });
            
            // Table event delegation
            tbody.addEventListener('change', (e) => {
                const row = e.target.closest('tr');
                if (!row) return;
                
                if (e.target.matches('[data-field="workType"], [data-field="measurementType"]')) {
                    updateRowDisplays(row);
                }
                updateResultEvaluation(row);
            });
            
            tbody.addEventListener('input', (e) => {
                const row = e.target.closest('tr');
                if (row) {
                    updateResultEvaluation(row);
                }
            });
            
            tbody.addEventListener('click', (e) => {
                if (e.target.closest('.delete-row-btn')) {
                    const row = e.target.closest('tr');
                    if (row) {
                        if (confirm('ต้องการลบแถวนี้หรือไม่?')) {
                            row.remove();
                            renumberRows();
                            addNoDataRowIfEmpty();
                        }
                    }
                }
            });
            
            // Keyboard shortcuts
            document.addEventListener('keydown', (e) => {
                if (e.ctrlKey && e.key === 's') {
                    e.preventDefault();
                    document.getElementById('save-data-btn').click();
                }
            });
            
            // Enhanced keyboard navigation
            tbody.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' || e.key === 'Tab') {
                    const currentInput = e.target;
                    const currentRow = currentInput.closest('tr');
                    const allInputs = currentRow.querySelectorAll('input, select');
                    const currentIndex = Array.from(allInputs).indexOf(currentInput);
                    
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        
                        if (currentIndex < allInputs.length - 1) {
                            // Move to next input in same row
                            allInputs[currentIndex + 1].focus();
                        } else {
                            // Move to first input of next row or create new row
                            const nextRow = currentRow.nextElementSibling;
                            if (nextRow && !nextRow.id) {
                                const firstInput = nextRow.querySelector('input, select');
                                if (firstInput) firstInput.focus();
                            } else {
                                // Create new row
                                removeNoDataRow();
                                const newRow = createTableRow({ measurementType: 'spot' });
                                tbody.appendChild(newRow);
                                renumberRows();
                                const firstInput = newRow.querySelector('input');
                                if (firstInput) firstInput.focus();
                            }
                        }
                    }
                }
            });
            
            // Default values modal
            document.getElementById('default-values-btn').addEventListener('click', () => {
                const modal = new bootstrap.Modal(document.getElementById('defaultValuesModal'));
                document.getElementById('default-area').value = defaultValues.area;
                document.getElementById('default-work-type').value = defaultValues.workType;
                modal.show();
            });
            
            document.getElementById('apply-defaults-btn').addEventListener('click', () => {
                defaultValues.area = document.getElementById('default-area').value;
                defaultValues.workType = document.getElementById('default-work-type').value;
                
                // Immediate modal cleanup
                const modal = bootstrap.Modal.getInstance(document.getElementById('defaultValuesModal'));
                if (modal) {
                    modal.hide();
                    // Immediate cleanup
                    document.body.classList.remove('modal-open');
                    const backdrop = document.querySelector('.modal-backdrop');
                    if (backdrop) backdrop.remove();
                    document.body.style.overflow = '';
                    document.body.style.paddingRight = '';
                }
                
                showAlert('ตั้งค่าเริ่มต้นสำเร็จ');
            });
            
            // Create rows modal (moved to toolbar)
            document.getElementById('create-rows-btn').addEventListener('click', () => {
                const modal = new bootstrap.Modal(document.getElementById('createRowsModal'));
                const currentRowCount = tbody.querySelectorAll('tr:not(#no-data-row)').length;
                document.getElementById('start-number').value = currentRowCount + 1;
                modal.show();
            });
            
            document.getElementById('execute-create-rows').addEventListener('click', () => {
                const rowCount = parseInt(document.getElementById('row-count-input').value);
                const layoutPattern = document.getElementById('layout-pattern').value;
                const startNumber = parseInt(document.getElementById('start-number').value);
                const bulkArea = document.getElementById('bulk-area').value;
                const bulkWorkType = document.getElementById('bulk-work-type').value;
                const bulkMeasurementType = document.getElementById('bulk-measurement-type').value;
                
                removeNoDataRow();
                
                for (let i = 0; i < rowCount; i++) {
                    const rowData = {
                        layout: layoutPattern.replace('{x}', startNumber + i),
                        area: bulkArea,
                        workType: bulkWorkType,
                        measurementType: bulkMeasurementType
                    };
                    const row = createTableRow(rowData);
                    tbody.appendChild(row);
                }
                
                renumberRows();
                // Immediate modal cleanup
                const modal = bootstrap.Modal.getInstance(document.getElementById('createRowsModal'));
                if (modal) {
                    modal.hide();
                    // Immediate cleanup
                    document.body.classList.remove('modal-open');
                    const backdrop = document.querySelector('.modal-backdrop');
                    if (backdrop) backdrop.remove();
                    document.body.style.overflow = '';
                    document.body.style.paddingRight = '';
                }
                showAlert(`สร้าง ${rowCount} แถวสำเร็จ`);
            });
            
            // Bulk Edit functionality
            document.getElementById('bulk-edit-btn').addEventListener('click', () => {
                const rows = tbody.querySelectorAll('tr:not(#no-data-row)');
                if (rows.length === 0) {
                    showAlert('ไม่มีแถวให้แก้ไข', 'warning');
                    return;
                }
                
                // Populate work type options
                const bulkEditWorkType = document.getElementById('bulk-edit-worktype');
                bulkEditWorkType.innerHTML = '<option value="">-- เลือกลักษณะงาน --</option>';
                workTypes.forEach(w => {
                    const option = document.createElement('option');
                    option.value = w.id;
                    option.textContent = w.workTypeName;
                    bulkEditWorkType.appendChild(option);
                });
                
                // Populate row selection checkboxes
                const rowSelection = document.getElementById('bulk-edit-row-selection');
                rowSelection.innerHTML = '';
                
                rows.forEach((row, index) => {
                    const layout = row.querySelector('[data-field="layout"]').value || `แถวที่ ${index + 1}`;
                    const area = row.querySelector('[data-field="area"]').value || 'ไม่ระบุ';
                    
                    const checkDiv = document.createElement('div');
                    checkDiv.className = 'form-check';
                    checkDiv.innerHTML = `
                        <input class="form-check-input bulk-edit-row-check" type="checkbox" 
                               value="${index}" id="row-check-${index}" checked>
                        <label class="form-check-label" for="row-check-${index}">
                            ${layout} - ${area}
                        </label>
                    `;
                    rowSelection.appendChild(checkDiv);
                });
                
                const modal = new bootstrap.Modal(document.getElementById('bulkEditModal'));
                modal.show();
            });
            
            // Bulk edit checkbox handlers
            document.getElementById('bulk-edit-area-check').addEventListener('change', function() {
                document.getElementById('bulk-edit-area').disabled = !this.checked;
            });
            document.getElementById('bulk-edit-worktype-check').addEventListener('change', function() {
                document.getElementById('bulk-edit-worktype').disabled = !this.checked;
            });
            document.getElementById('bulk-edit-measurement-check').addEventListener('change', function() {
                document.getElementById('bulk-edit-measurement').disabled = !this.checked;
            });
            document.getElementById('bulk-edit-remark-check').addEventListener('change', function() {
                document.getElementById('bulk-edit-remark').disabled = !this.checked;
            });
            
            // Apply bulk edit
            document.getElementById('apply-bulk-edit-btn').addEventListener('click', () => {
                const selectedRows = document.querySelectorAll('.bulk-edit-row-check:checked');
                if (selectedRows.length === 0) {
                    showAlert('กรุณาเลือกแถวที่ต้องการแก้ไข', 'warning');
                    return;
                }
                
                const changes = {
                    area: document.getElementById('bulk-edit-area-check').checked ? 
                          document.getElementById('bulk-edit-area').value : null,
                    workType: document.getElementById('bulk-edit-worktype-check').checked ? 
                             document.getElementById('bulk-edit-worktype').value : null,
                    measurementType: document.getElementById('bulk-edit-measurement-check').checked ? 
                                    document.getElementById('bulk-edit-measurement').value : null,
                    remark: document.getElementById('bulk-edit-remark-check').checked ? 
                           document.getElementById('bulk-edit-remark').value : null
                };
                
                // Apply changes to selected rows
                const rows = tbody.querySelectorAll('tr:not(#no-data-row)');
                selectedRows.forEach(checkbox => {
                    const rowIndex = parseInt(checkbox.value);
                    const row = rows[rowIndex];
                    
                    if (changes.area !== null) {
                        row.querySelector('[data-field="area"]').value = changes.area;
                    }
                    if (changes.workType !== null) {
                        row.querySelector('[data-field="workType"]').value = changes.workType;
                        updateRowDisplays(row); // Update standards when work type changes
                    }
                    if (changes.measurementType !== null) {
                        row.querySelector('[data-field="measurementType"]').value = changes.measurementType;
                        updateRowDisplays(row); // Update input fields when measurement type changes
                    }
                    if (changes.remark !== null) {
                        row.querySelector('[data-field="remark"]').value = changes.remark;
                    }
                });
                
                // Immediate modal cleanup
                const modal = bootstrap.Modal.getInstance(document.getElementById('bulkEditModal'));
                if (modal) {
                    modal.hide();
                    // Immediate cleanup
                    document.body.classList.remove('modal-open');
                    const backdrop = document.querySelector('.modal-backdrop');
                    if (backdrop) backdrop.remove();
                    document.body.style.overflow = '';
                    document.body.style.paddingRight = '';
                }
                showAlert(`แก้ไข ${selectedRows.length} แถวสำเร็จ`);
                
                // Trigger auto-save
                isDataChanged = true;
                clearTimeout(autoSaveTimer);
                autoSaveTimer = setTimeout(autoSaveData, 1000);
            });
            
            // Template management
            document.getElementById('load-template-btn').addEventListener('click', async () => {
                const templateId = document.getElementById('template-selector').value;
                if (!templateId) {
                    showAlert('กรุณาเลือก Template ที่ต้องการโหลด', 'warning');
                    return;
                }
                
                try {
                    const templateResult = await firebaseManager.getDocument('measurement_templates', templateId);
                    
                    if (templateResult && templateResult.data) {
                        const template = templateResult.data;
                        
                        // Clear existing rows
                        // Using global tbody
                        tbody.innerHTML = '';
                        
                        // Add template data
                        if (template.results && template.results.length > 0) {
                            template.results.forEach(result => {
                                const row = createTableRow(result);
                                tbody.appendChild(row);
                            });
                            renumberRows();
                        } else {
                            addNoDataRowIfEmpty();
                        }
                        
                        showAlert(`โหลด Template "${template.name}" สำเร็จ`);
                    }
                } catch (error) {
                    showAlert(`เกิดข้อผิดพลาดในการโหลด Template: ${error.message}`, 'danger');
                }
            });
            
            document.getElementById('save-template-btn').addEventListener('click', async () => {
                const templateName = document.getElementById('template-name-input').value.trim();
                if (!templateName) {
                    showAlert('กรุณาใส่ชื่อ Template', 'warning');
                    return;
                }
                
                // Collect current data
                const results = [];
                const rows = tbody.querySelectorAll('tr:not(#no-data-row)');
                
                rows.forEach(row => {
                    const result = {
                        layout: row.querySelector('[data-field="layout"]').value,
                        area: row.querySelector('[data-field="area"]').value,
                        workType: row.querySelector('[data-field="workType"]').value,
                        measurementType: row.querySelector('[data-field="measurementType"]').value
                    };
                    results.push(result);
                });
                
                if (results.length === 0) {
                    showAlert('ไม่มีข้อมูลสำหรับบันทึกเป็น Template', 'warning');
                    return;
                }
                
                try {
                    const templateData = {
                        name: templateName,
                        results: results,
                        createdAt: new Date().toISOString(),
                        createdBy: firebaseManager.getCurrentUserId()
                    };
                    
                    const templatesRef = firebaseManager.getCollection('measurement_templates');
                    await addDoc(templatesRef, templateData);
                    
                    document.getElementById('template-name-input').value = '';
                    showAlert(`บันทึก Template "${templateName}" สำเร็จ`);
                } catch (error) {
                    showAlert(`เกิดข้อผิดพลาดในการบันทึก Template: ${error.message}`, 'danger');
                }
            });
            
            // Save measurement results
            document.getElementById('save-data-btn').addEventListener('click', async () => {
                if (!jobId) {
                    showAlert('ไม่พบ Job ID', 'danger');
                    return;
                }
                
                const saveBtn = document.getElementById('save-data-btn');
                const originalContent = saveBtn.innerHTML;
                saveBtn.disabled = true;
                saveBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>กำลังบันทึก...';
                
                try {
                    const results = [];
                    const rows = tbody.querySelectorAll('tr:not(#no-data-row)');
                    
                    rows.forEach(row => {
                        const result = {
                            layout: row.querySelector('[data-field="layout"]').value,
                            area: row.querySelector('[data-field="area"]').value,
                            workType: row.querySelector('[data-field="workType"]').value,
                            measurementType: row.querySelector('[data-field="measurementType"]').value,
                            standard: row.querySelector('.standard-display').textContent,
                            evaluation: row.querySelector('.result-evaluation').textContent,
                            remark: row.querySelector('[data-field="remark"]').value || ''
                        };
                        
                        // Add measurement values
                        if (result.measurementType === 'spot') {
                            const spotInput = row.querySelector('[data-field="spotValue"]');
                            result.spotValue = spotInput ? spotInput.value : null;
                        } else {
                            const avgInput = row.querySelector('[data-field="areaAvgValue"]');
                            const minInput = row.querySelector('[data-field="areaMinValue"]');
                            result.areaAvgValue = avgInput ? avgInput.value : null;
                            result.areaMinValue = minInput ? minInput.value : null;
                        }
                        
                        results.push(result);
                    });
                    
                    await firebaseManager.updateDocument('jobs', jobId, {
                        results: results,
                        lastUpdated: new Date().toISOString(),
                        status: results.length > 0 ? 'in-progress' : 'new'
                    });
                    
                    showAlert('บันทึกผลการตรวจวัดสำเร็จแล้ว');
                    
                } catch (error) {
                    showAlert(`เกิดข้อผิดพลาดในการบันทึก: ${error.message}`, 'danger');
                } finally {
                    saveBtn.disabled = false;
                    saveBtn.innerHTML = originalContent;
                }
            });
        }
        
        // Initialize global variables after DOM loads
        tbody = document.getElementById('results-table-body');
        
        // Add event listeners for recommendations fields
        document.getElementById('recommendations').addEventListener('input', () => {
            isDataChanged = true;
            clearTimeout(autoSaveTimer);
            autoSaveTimer = setTimeout(autoSaveData, 3000);
        });
        
        document.getElementById('observations').addEventListener('input', () => {
            isDataChanged = true;
            clearTimeout(autoSaveTimer);
            autoSaveTimer = setTimeout(autoSaveData, 3000);
        });
        
        main();
        
        // Global modal cleanup function - immediate cleanup
        const cleanupModalBackdrop = () => {
            // Immediate cleanup without delay
            document.body.classList.remove('modal-open');
            const backdrop = document.querySelector('.modal-backdrop');
            if (backdrop) backdrop.remove();
            document.body.style.overflow = '';
            document.body.style.paddingRight = '';
        };
        
        // Add cleanup listeners to all modals
        const modals = ['defaultValuesModal', 'createRowsModal', 'bulkEditModal'];
        modals.forEach(modalId => {
            const modalElement = document.getElementById(modalId);
            if (modalElement) {
                modalElement.addEventListener('hidden.bs.modal', cleanupModalBackdrop);
            }
        });
        
        // Sidebar toggle
        document.getElementById('sidebarToggle').addEventListener('click', () => {
            document.getElementById('wrapper').classList.toggle('sidebar-mini');
        });
    </script>
</body>
</html>