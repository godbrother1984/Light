<!-- 
  path: /report-finalizer.html
  version: 6.0 (Enhanced Tags System with TagProcessor Module)
  date: 2025-09-04
  time: 10:00:00
  description: Added new advanced tags and separated tag processing into external module
-->
<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>สร้างรายงาน PDF - Light Measurement System</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    
    <!-- TinyMCE Rich Text Editor -->
    <script src="https://cdn.tiny.cloud/1/89apconez9ynna1jgwbnp15ywm4fk8ob84ndx3rcl5ih7q69/tinymce/7/tinymce.min.js" referrerpolicy="origin"></script>
    <!-- PDF Generation Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <!-- Tag Processor Module -->
    <script src="tag-processor.js"></script>

    <style>
        :root {
            --primary-color: #0d47a1;
            --secondary-color: #1976d2;
            --background-color: #f4f7f9;
            --sidebar-width: 260px;
            --sidebar-mini-width: 80px;
            --card-shadow: 0 2px 10px rgba(0,0,0,0.05);
            --transition-speed: 0.3s;
        }
        body { font-family: 'Sarabun', sans-serif !important; background-color: var(--background-color); overflow-x: hidden; }
        #wrapper { display: flex; }
        #sidebar-wrapper { width: var(--sidebar-width); min-height: 100vh; background-color: var(--primary-color); transition: width var(--transition-speed) ease; }
        #wrapper.sidebar-mini #sidebar-wrapper { width: var(--sidebar-mini-width); }
        .sidebar-heading { padding: 1rem 1.25rem; font-size: 1.5rem; font-weight: 700; color: #fff; white-space: nowrap; }
        .sidebar-heading .logo-text { display: inline; transition: opacity var(--transition-speed) ease; }
        #wrapper.sidebar-mini .sidebar-heading .logo-text { opacity: 0; display: none; }
        .list-group-item { border: none; padding: 1rem 1.5rem; color: rgba(255,255,255,0.8); background-color: transparent; transition: background-color var(--transition-speed) ease; white-space: nowrap; display: flex; align-items: center; }
        .list-group-item i { font-size: 1.25rem; }
        .list-group-item .menu-text { opacity: 1; transition: opacity 0.2s ease; }
        #wrapper.sidebar-mini .list-group-item .menu-text { opacity: 0; display: none; }
        .list-group-item:hover, .list-group-item.active { background-color: var(--secondary-color); color: #fff; }
        #page-content-wrapper { flex-grow: 1; }
        .navbar { box-shadow: var(--card-shadow); }
        .card { box-shadow: var(--card-shadow); border: none; border-radius: .5rem; }
        .tox-tinymce { border-radius: .5rem !important; }
        
        .tag-button {
            background: linear-gradient(45deg, var(--primary-color), var(--secondary-color));
            border: none;
            color: white;
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            font-size: 0.75rem;
            cursor: pointer;
            margin: 0.125rem;
            transition: transform 0.1s ease;
        }
        
        .tag-button:hover {
            transform: scale(1.05);
            color: white;
        }
        
        .tag-category {
            border-left: 3px solid var(--primary-color);
            padding-left: 0.75rem;
            margin-bottom: 1rem;
        }
        
        .page-setup-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }
        
        .image-preview {
            max-width: 100px;
            max-height: 60px;
            border-radius: 0.25rem;
            border: 1px solid #dee2e6;
            object-fit: contain;
        }
        
        .pdf-preview {
            border: 1px solid #dee2e6;
            border-radius: 0.5rem;
            background: white;
            min-height: 400px;
            position: relative;
            overflow: auto;
        }
        
        .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
        }
    </style>
</head>
<body>
    
    <div class="d-flex" id="wrapper">

        <!-- Sidebar -->
        <div id="sidebar-wrapper">
            <div class="sidebar-heading"><i class="fas fa-lightbulb me-2"></i><span class="logo-text">Light Measuring</span></div>
            <div class="list-group list-group-flush">
                <a class="list-group-item" href="main.html"><i class="fas fa-tasks fa-fw me-3"></i><span class="menu-text">รายการงานทั้งหมด</span></a>
                <a class="list-group-item" href="master-data-manager.html"><i class="fas fa-database fa-fw me-3"></i><span class="menu-text">จัดการข้อมูลหลัก</span></a>
                <a class="list-group-item" href="template-manager.html"><i class="fas fa-file-alt fa-fw me-3"></i><span class="menu-text">จัดการ Template</span></a>
            </div>
        </div>

        <!-- Page Content -->
        <div id="page-content-wrapper">
            <nav class="navbar navbar-expand-lg navbar-light bg-white border-bottom sticky-top">
                <div class="container-fluid">
                    <button class="btn btn-outline-primary me-2" id="sidebarToggle"><i class="fas fa-bars"></i></button>
                    <ul class="navbar-nav ms-auto d-flex flex-row">
                        <li class="nav-item dropdown">
                            <a class="nav-link dropdown-toggle d-flex align-items-center" href="#" id="userDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                                <i class="fas fa-user-circle fa-2x text-muted"></i>
                            </a>
                            <ul class="dropdown-menu dropdown-menu-end">
                                <li><h6 class="dropdown-header">User Profile</h6></li>
                                <li><a class="dropdown-item" href="#"><span id="user-display">Connecting...</span></a></li>
                            </ul>
                        </li>
                    </ul>
                </div>
            </nav>

            <main class="container-fluid p-4">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h1 class="h3 mb-0">ตัวสร้างรายงาน PDF สำหรับ Job ID: <span id="job-id-display" class="text-primary">Loading...</span></h1>
                    <div class="d-flex gap-2">
                        <a href="#" id="back-to-job-btn" class="btn btn-outline-secondary">
                            <i class="fas fa-arrow-left me-2"></i>กลับไปรายละเอียดงาน
                        </a>
                    </div>
                </div>
                
                <div id="alert-placeholder"></div>

                <div class="row">
                    <!-- Editor Column -->
                    <div class="col-lg-8">
                        <div class="card mb-3">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h5 class="mb-0"><i class="fas fa-edit me-2"></i>แก้ไขเนื้อหารายงาน</h5>
                                <div class="d-flex gap-2">
                                    <select id="template-selector" class="form-select form-select-sm" style="width: auto;">
                                        <option value="">-- เลือก Template --</option>
                                    </select>
                                    <button id="load-template-btn" class="btn btn-sm btn-outline-info">
                                        <i class="fas fa-download me-1"></i>โหลด
                                    </button>
                                </div>
                            </div>
                            <div class="card-body">
                                <textarea id="report-editor"></textarea>
                            </div>
                        </div>

                        <!-- Tags/Variables Panel -->
                        <div class="card">
                            <div class="card-header">
                                <h5 class="mb-0">
                                    <i class="fas fa-tags me-2"></i>Tags สำหรับแทรกข้อมูล
                                    <small class="text-muted">(คลิกเพื่อแทรกลงในรายงาน)</small>
                                </h5>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-4">
                                        <div class="tag-category">
                                            <h6 class="fw-bold">ข้อมูลงาน</h6>
                                            <button class="tag-button" data-tag="{{JOB_ID}}">รหัสงาน</button>
                                            <button class="tag-button" data-tag="{{CUSTOMER_NAME}}">ชื่อลูกค้า</button>
                                            <button class="tag-button" data-tag="{{LOCATION}}">สถานที่</button>
                                            <button class="tag-button" data-tag="{{ADDRESS}}">ที่อยู่</button>
                                            <button class="tag-button" data-tag="{{DATE}}">วันที่ตรวจวัด</button>
                                            <button class="tag-button" data-tag="{{STATUS}}">สถานะงาน</button>
                                        </div>
                                        
                                        <div class="tag-category">
                                            <h6 class="fw-bold">บุคลากร (พื้นฐาน)</h6>
                                            <button class="tag-button" data-tag="{{INSPECTORS}}">ผู้ตรวจวัด</button>
                                            <button class="tag-button" data-tag="{{ANALYSTS}}">ผู้วิเคราะห์</button>
                                            <button class="tag-button" data-tag="{{REPORT_CREATOR}}">ผู้จัดทำรายงาน</button>
                                        </div>
                                        
                                        <div class="tag-category">
                                            <h6 class="fw-bold">🆕 บุคลากร (รายละเอียด)</h6>
                                            <button class="tag-button" data-tag="{{STAFF_CONTROLLERS}}">ผู้ควบคุมห้องปฏิบัติการ</button>
                                            <button class="tag-button" data-tag="{{STAFF_INSPECTORS}}">ผู้ตรวจวัด + ตำแหน่ง</button>
                                            <button class="tag-button" data-tag="{{STAFF_REPORTERS}}">ผู้จัดทำรายงาน + ตำแหน่ง</button>
                                            <button class="tag-button" data-tag="{{ALL_STAFF}}">บุคลากรทั้งหมด</button>
                                        </div>
                                    </div>
                                    
                                    <div class="col-md-4">
                                        <div class="tag-category">
                                            <h6 class="fw-bold">🆕 ข้อมูลบริษัท</h6>
                                            <button class="tag-button" data-tag="{{COMPANY_LICENSES}}">ใบอนุญาตทั้งหมด</button>
                                            <button class="tag-button" data-tag="{{LICENSE_FACTORY}}">เลขทะเบียน ว-๓๒๙</button>
                                            <button class="tag-button" data-tag="{{LICENSE_LIGHT}}">ใบอนุญาตแสงสว่าง</button>
                                        </div>
                                        
                                        <div class="tag-category">
                                            <h6 class="fw-bold">ผลการตรวจวัด</h6>
                                            <button class="tag-button" data-tag="{{RESULTS_TABLE}}">ตารางผลการตรวจวัด 📄</button>
                                            <button class="tag-button" data-tag="{{RESULTS_COUNT}}">จำนวนจุดตรวจวัด</button>
                                            <button class="tag-button" data-tag="{{PASS_COUNT}}">จำนวนจุดที่ผ่าน</button>
                                            <button class="tag-button" data-tag="{{FAIL_COUNT}}">จำนวนจุดที่ไม่ผ่าน</button>
                                        </div>
                                        
                                        <div class="tag-category">
                                            <h6 class="fw-bold">🆕 รายละเอียดการตรวจวัด</h6>
                                            <button class="tag-button" data-tag="{{MEASUREMENT_DETAILS_TABLE}}">ตารางรายละเอียดเต็ม</button>
                                            <button class="tag-button" data-tag="{{SPOT_COUNT}}">จำนวนจุดแบบจุด</button>
                                            <button class="tag-button" data-tag="{{AREA_COUNT}}">จำนวนจุดแบบพื้นที่</button>
                                        </div>
                                    </div>
                                    
                                    <div class="col-md-4">
                                        <div class="tag-category">
                                            <h6 class="fw-bold">วันที่และเวลา</h6>
                                            <button class="tag-button" data-tag="{{CURRENT_DATE}}">วันที่ปัจจุบัน</button>
                                            <button class="tag-button" data-tag="{{CURRENT_TIME}}">เวลาปัจจุบัน</button>
                                            <button class="tag-button" data-tag="{{THAI_DATE}}">วันที่ไทย</button>
                                        </div>
                                        
                                        <div style="background: linear-gradient(135deg, #e3f2fd, #f3e5f5); padding: 15px; border-radius: 8px; border-left: 4px solid #1976d2;">
                                            <h6 class="fw-bold text-primary">💡 วิธีใช้งาน Tags</h6>
                                            <ul class="small mb-0" style="padding-left: 1rem;">
                                                <li><strong>คลิก</strong> tag เพื่อแทรกลงในรายงาน</li>
                                                <li><strong>ตาราง</strong> จะแสดงเฉพาะที่มีข้อมูล</li>
                                                <li><strong>บุคลากร</strong> ดึงจาก Master Data</li>
                                                <li><strong>📄</strong> = แบ่งหน้าอัตโนมัติ (20 รายการ/หน้า)</li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Settings and Preview Column -->
                    <div class="col-lg-4">
                        <!-- Page Setup -->
                        <div class="card mb-3">
                            <div class="card-header">
                                <h5 class="mb-0"><i class="fas fa-file-alt me-2"></i>ตั้งค่าหน้ากระดาษ</h5>
                            </div>
                            <div class="card-body">
                                <div class="page-setup-grid">
                                    <div>
                                        <label for="page-size" class="form-label">ขนาดกระดาษ</label>
                                        <select id="page-size" class="form-select form-select-sm">
                                            <option value="a4">A4 (210×297 mm)</option>
                                            <option value="a3">A3 (297×420 mm)</option>
                                            <option value="letter">Letter (216×279 mm)</option>
                                        </select>
                                    </div>
                                    
                                    <div>
                                        <label for="page-orientation" class="form-label">การวางกระดาษ</label>
                                        <select id="page-orientation" class="form-select form-select-sm">
                                            <option value="portrait">แนวตั้ง (Portrait)</option>
                                            <option value="landscape">แนวนอน (Landscape)</option>
                                        </select>
                                    </div>
                                    
                                    <div>
                                        <label for="margin-top" class="form-label">ขอบบน (mm)</label>
                                        <input type="number" id="margin-top" class="form-control form-control-sm" value="20" min="0" max="50">
                                    </div>
                                    
                                    <div>
                                        <label for="margin-bottom" class="form-label">ขอบล่าง (mm)</label>
                                        <input type="number" id="margin-bottom" class="form-control form-control-sm" value="20" min="0" max="50">
                                    </div>
                                    
                                    <div>
                                        <label for="margin-left" class="form-label">ขอบซ้าย (mm)</label>
                                        <input type="number" id="margin-left" class="form-control form-control-sm" value="15" min="0" max="50">
                                    </div>
                                    
                                    <div>
                                        <label for="margin-right" class="form-label">ขอบขวา (mm)</label>
                                        <input type="number" id="margin-right" class="form-control form-control-sm" value="15" min="0" max="50">
                                    </div>
                                </div>
                                
                                <hr>
                                
                                <div class="mb-3">
                                    <label for="header-img" class="form-label">Header Image</label>
                                    <input class="form-control form-control-sm" type="file" id="header-img" accept="image/*">
                                    <div id="header-preview" class="mt-2"></div>
                                </div>
                                
                                <div class="mb-3">
                                    <label for="footer-img" class="form-label">Footer Image</label>
                                    <input class="form-control form-control-sm" type="file" id="footer-img" accept="image/*">
                                    <div id="footer-preview" class="mt-2"></div>
                                </div>
                                
                                <div class="mb-3">
                                    <label for="watermark-img" class="form-label">Watermark Image</label>
                                    <input class="form-control form-control-sm" type="file" id="watermark-img" accept="image/*">
                                    <div id="watermark-preview" class="mt-2"></div>
                                    <div class="mt-1">
                                        <label for="watermark-opacity" class="form-label">ความโปร่งใส (%)</label>
                                        <input type="range" class="form-range" id="watermark-opacity" min="5" max="50" value="15">
                                        <small class="text-muted"><span id="opacity-value">15</span>%</small>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Actions -->
                        <div class="card">
                            <div class="card-header">
                                <h5 class="mb-0"><i class="fas fa-cog me-2"></i>การดำเนินการ</h5>
                            </div>
                            <div class="card-body">
                                <div class="d-grid gap-2">
                                    <button id="preview-pdf-btn" class="btn btn-info">
                                        <i class="fas fa-eye me-2"></i>ดูตัวอย่าง PDF
                                    </button>
                                    <button id="save-content-btn" class="btn btn-secondary">
                                        <i class="fas fa-save me-2"></i>บันทึกเนื้อหาสำหรับงานนี้
                                    </button>
                                    <button id="save-as-template-btn" class="btn btn-success">
                                        <i class="fas fa-file-export me-2"></i>บันทึกเป็น Template ใหม่
                                    </button>
                                    <button id="generate-pdf-btn" class="btn btn-primary">
                                        <i class="fas fa-file-pdf me-2"></i>สร้างและดาวน์โหลด PDF
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- PDF Preview Modal -->
                <div class="modal fade" id="pdfPreviewModal" tabindex="-1">
                    <div class="modal-dialog modal-xl">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">
                                    <i class="fas fa-eye me-2"></i>ตัวอย่าง PDF
                                </h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <div id="pdf-preview-container" class="pdf-preview">
                                    <div class="loading-overlay">
                                        <div class="spinner-border text-primary mb-2"></div>
                                        <span>กำลังสร้างตัวอย่าง...</span>
                                    </div>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ปิด</button>
                                <button type="button" id="confirm-generate-pdf" class="btn btn-primary">
                                    <i class="fas fa-download me-2"></i>ดาวน์โหลด PDF
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="firebase-config.js"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, doc, getDoc, setDoc, addDoc, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        const { jsPDF } = window.jspdf;
        let activeEditor = null;
        let savedTemplates = [];
        let currentJobData = null;
        let currentJobId = null;
        let tagProcessor = null;
        
        const alertPlaceholder = document.getElementById('alert-placeholder');
        const jobIdDisplay = document.getElementById('job-id-display');
        const templateSelector = document.getElementById('template-selector');
        
        const showAlert = (message, type = 'info') => {
            const wrapper = document.createElement('div');
            wrapper.innerHTML = `<div class="alert alert-${type} alert-dismissible" role="alert">${message}<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button></div>`;
            alertPlaceholder.innerHTML = '';
            alertPlaceholder.append(wrapper);
        };
        
        const fileToBase64 = file => new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = () => resolve(reader.result);
            reader.onerror = error => reject(error);
        });

        // Process tags in content - UPDATED TO USE TagProcessor
        const processTags = (content, jobData, jobId) => {
            if (!tagProcessor) {
                console.warn('TagProcessor not initialized, using fallback');
                return content; // Fallback if TagProcessor not loaded
            }
            return tagProcessor.processTags(content, jobData, jobId);
        };

        // Generate PDF with settings
        async function generatePDF(preview = false) {
            if (!currentJobId) {
                showAlert('ไม่พบ Job ID', 'danger');
                return;
            }
            
            if (!currentJobData) {
                showAlert('ไม่พบข้อมูลงาน กรุณาโหลดข้อมูลงานก่อน', 'danger');
                return;
            }
            
            const generateBtn = document.getElementById('generate-pdf-btn');
            const previewBtn = document.getElementById('preview-pdf-btn');
            
            const targetBtn = preview ? previewBtn : generateBtn;
            const originalContent = targetBtn.innerHTML;
            
            targetBtn.disabled = true;
            targetBtn.innerHTML = `<span class="spinner-border spinner-border-sm"></span> ${preview ? 'กำลังสร้างตัวอย่าง...' : 'กำลังสร้าง PDF...'}`;

            try {
                // Get page settings
                const pageSize = document.getElementById('page-size').value;
                const orientation = document.getElementById('page-orientation').value;
                const margins = {
                    top: parseInt(document.getElementById('margin-top').value),
                    bottom: parseInt(document.getElementById('margin-bottom').value),
                    left: parseInt(document.getElementById('margin-left').value),
                    right: parseInt(document.getElementById('margin-right').value)
                };

                // Create PDF
                const doc = new jsPDF({
                    orientation: orientation === 'landscape' ? 'l' : 'p',
                    unit: 'mm',
                    format: pageSize
                });

                // Get images
                const headerFile = document.getElementById('header-img').files[0];
                const footerFile = document.getElementById('footer-img').files[0];
                const watermarkFile = document.getElementById('watermark-img').files[0];
                const watermarkOpacity = parseInt(document.getElementById('watermark-opacity').value) / 100;

                const headerBase64 = headerFile ? await fileToBase64(headerFile) : null;
                const footerBase64 = footerFile ? await fileToBase64(footerFile) : null;
                const watermarkBase64 = watermarkFile ? await fileToBase64(watermarkFile) : null;

                // Process content with tags
                const rawContent = activeEditor.getContent();
                const processedContent = processTags(rawContent, currentJobData, currentJobId);

                // Create temporary div for content rendering
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = processedContent;
                tempDiv.style.position = 'absolute';
                tempDiv.style.left = '-9999px';
                tempDiv.style.width = '800px';
                tempDiv.style.padding = '20px';
                tempDiv.style.fontFamily = 'Sarabun, sans-serif';
                document.body.appendChild(tempDiv);

                // Render content to canvas
                const canvas = await html2canvas(tempDiv, {
                    scale: 2,
                    useCORS: true,
                    allowTaint: true,
                    backgroundColor: '#ffffff'
                });

                document.body.removeChild(tempDiv);

                const imgData = canvas.toDataURL('image/png');
                const imgProps = doc.getImageProperties(imgData);
                const pdfWidth = doc.internal.pageSize.getWidth();
                const pdfHeight = doc.internal.pageSize.getHeight();
                
                // Calculate content area considering margins
                const contentWidth = pdfWidth - margins.left - margins.right;
                const contentHeight = pdfHeight - margins.top - margins.bottom;
                const imgHeight = (imgProps.height * contentWidth) / imgProps.width;
                
                let heightLeft = imgHeight;
                let position = 0;
                let pageNumber = 1;
                
                // Function to add page assets (header, footer, watermark)
                function addPageAssets() {
                    // Add watermark
                    if (watermarkBase64) {
                        doc.setGState(new doc.GState({opacity: watermarkOpacity}));
                        doc.addImage(watermarkBase64, 'PNG', 
                            margins.left, 
                            margins.top, 
                            contentWidth, 
                            contentHeight
                        );
                        doc.setGState(new doc.GState({opacity: 1}));
                    }
                    
                    // Add header
                    if (headerBase64) {
                        const headerHeight = 15;
                        doc.addImage(headerBase64, 'PNG', 
                            margins.left, 
                            5, 
                            contentWidth, 
                            headerHeight
                        );
                    }
                    
                    // Add footer
                    if (footerBase64) {
                        const footerHeight = 10;
                        doc.addImage(footerBase64, 'PNG', 
                            margins.left, 
                            pdfHeight - footerHeight - 5, 
                            contentWidth, 
                            footerHeight
                        );
                    }
                    
                    // Add page number
                    doc.setFontSize(10);
                    doc.text(
                        `หน้า ${pageNumber}`, 
                        pdfWidth - margins.right - 20, 
                        pdfHeight - 10
                    );
                }
                
                // Add first page
                addPageAssets();
                doc.addImage(imgData, 'PNG', margins.left, margins.top, contentWidth, Math.min(imgHeight, contentHeight));
                heightLeft -= contentHeight;
                
                // Add additional pages if needed
                while (heightLeft > 0) {
                    position = heightLeft - imgHeight;
                    doc.addPage();
                    pageNumber++;
                    addPageAssets();
                    doc.addImage(imgData, 'PNG', margins.left, margins.top + position, contentWidth, imgHeight);
                    heightLeft -= contentHeight;
                }

                if (preview) {
                    // Show preview in modal
                    const previewContainer = document.getElementById('pdf-preview-container');
                    const pdfDataUri = doc.output('datauristring');
                    previewContainer.innerHTML = `<iframe src="${pdfDataUri}" width="100%" height="600px" style="border: none;"></iframe>`;
                    
                    const modal = new bootstrap.Modal(document.getElementById('pdfPreviewModal'));
                    modal.show();
                } else {
                    // Download PDF
                    doc.save(`รายงาน-${currentJobId}-${new Date().toISOString().split('T')[0]}.pdf`);
                    showAlert('สร้าง PDF สำเร็จแล้ว!', 'success');
                }

            } catch (error) {
                console.error("PDF Generation Error:", error);
                showAlert(`เกิดข้อผิดพลาดในการสร้าง PDF: ${error.message}`, 'danger');
                
                // Clean up temp div if it exists
                const tempDiv = document.querySelector('div[style*="position: absolute"][style*="left: -9999px"]');
                if (tempDiv) {
                    document.body.removeChild(tempDiv);
                }
            } finally {
                targetBtn.disabled = false;
                targetBtn.innerHTML = originalContent;
            }
        }
        
        (async () => {
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'light-measuring-app';
            
            // Initialize TagProcessor
            tagProcessor = new window.TagProcessor();
            
            // Initialize TinyMCE with fixed plugins
            tinymce.init({
                selector: '#report-editor',
                height: 600,
                plugins: 'preview importcss searchreplace autolink autosave save directionality code visualblocks visualchars fullscreen image link media codesample table charmap pagebreak nonbreaking anchor insertdatetime advlist lists wordcount help charmap quickbars emoticons',
                menubar: 'file edit view insert format tools table help',
                toolbar: 'undo redo | bold italic underline strikethrough | fontfamily fontsize blocks | alignleft aligncenter alignright alignjustify | outdent indent | numlist bullist | forecolor backcolor removeformat | pagebreak | charmap emoticons | fullscreen preview save print | insertfile image media link anchor codesample | ltr rtl',
                autosave_ask_before_unload: true,
                content_style: 'body { font-family: "Sarabun", sans-serif; font-size: 16px; line-height: 1.6; }',
                setup: editor => { 
                    activeEditor = editor;
                }
            });

            // Get job ID and setup
            const urlParams = new URLSearchParams(window.location.search);
            currentJobId = urlParams.get('id');
            
            if (currentJobId) {
                jobIdDisplay.textContent = currentJobId;
                document.getElementById('back-to-job-btn').href = `job-details.html?id=${currentJobId}`;
            } else {
                jobIdDisplay.textContent = "ไม่พบ ID";
                showAlert("ไม่พบ Job ID ใน URL", "danger");
                return;
            }

            let finalFirebaseConfig;
            try {
                if (typeof __firebase_config !== 'undefined') finalFirebaseConfig = JSON.parse(__firebase_config);
                else if (window.firebaseConfig && window.firebaseConfig.projectId) finalFirebaseConfig = window.firebaseConfig;
            } catch(e) { console.error(e); }
            if (!finalFirebaseConfig) { showAlert('ไม่พบ Firebase Config', 'danger'); return; }

            const app = initializeApp(finalFirebaseConfig);
            const db = getFirestore(app);
            const auth = getAuth(app);
            
            try {
                if (typeof __initial_auth_token !== 'undefined') await signInWithCustomToken(auth, __initial_auth_token);
                else await signInAnonymously(auth);
                
                document.getElementById('user-display').textContent = `UID: ${auth.currentUser.uid.substring(0, 8)}...`;
                
                // Load master data for advanced tags
                await loadMasterData(db, appId);
                
                // Load job data
                const jobDocRef = doc(db, `/artifacts/${appId}/public/data/jobs`, currentJobId);
                const jobSnap = await getDoc(jobDocRef);
                
                if (jobSnap.exists()) {
                    currentJobData = jobSnap.data();
                    console.log('Loaded job data:', currentJobData);
                } else {
                    showAlert('ไม่พบข้อมูลงาน', 'danger');
                }
                
                // Load templates
                const templatesCollectionPath = `/artifacts/${appId}/public/data/report_templates`;
                onSnapshot(collection(db, templatesCollectionPath), (snapshot) => {
                    const currentVal = templateSelector.value;
                    templateSelector.innerHTML = '<option value="">-- เลือก Template --</option>';
                    savedTemplates = [];
                    
                    if (snapshot.empty) {
                        return;
                    }
                    
                    snapshot.forEach(doc => {
                        savedTemplates.push({ id: doc.id, ...doc.data() });
                        const option = document.createElement('option');
                        option.value = doc.id;
                        option.textContent = doc.data().name;
                        templateSelector.appendChild(option);
                    });
                    
                    if (currentVal) templateSelector.value = currentVal;
                    
                    // Load job content or default template
                    loadJobContent();
                });

                // Load master data function
                async function loadMasterData(db, appId) {
                    try {
                        // Load inspectors
                        const inspectorsRef = collection(db, `/artifacts/${appId}/public/data/inspectors`);
                        const inspectorsSnap = await getDocs(inspectorsRef);
                        const inspectors = inspectorsSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                        
                        // Load company info
                        const companyRef = doc(db, `/artifacts/${appId}/public/data/company_info`, 'main');
                        const companySnap = await getDoc(companyRef);
                        const companyInfo = companySnap.exists() ? companySnap.data() : null;
                        
                        // Set master data in TagProcessor
                        tagProcessor.setMasterData(inspectors, companyInfo);
                        
                        console.log('Master data loaded:', { inspectors: inspectors.length, companyInfo: !!companyInfo });
                    } catch (error) {
                        console.error('Error loading master data:', error);
                        showAlert('ไม่สามารถโหลด Master Data ได้ - Tags บางส่วนอาจไม่ทำงาน', 'warning');
                    }
                }

                async function loadJobContent() {
                    if (currentJobData && currentJobData.reportContent) {
                        activeEditor.setContent(currentJobData.reportContent);
                        showAlert("โหลดเนื้อหาที่เคยบันทึกไว้สำหรับงานนี้แล้ว", "success");
                    } else if (savedTemplates.length > 0) {
                        // Load first template as default
                        const firstTemplate = savedTemplates[0];
                        activeEditor.setContent(firstTemplate.content);
                        templateSelector.value = firstTemplate.id;
                    }
                }

                // Template loading
                document.getElementById('load-template-btn').addEventListener('click', () => {
                    const selectedId = templateSelector.value;
                    if (!selectedId) {
                        showAlert('กรุณาเลือก Template ก่อน', 'warning');
                        return;
                    }
                    
                    const template = savedTemplates.find(t => t.id === selectedId);
                    if (template && activeEditor) {
                        activeEditor.setContent(template.content);
                        showAlert(`โหลด Template "${template.name}" สำเร็จ`, 'success');
                    }
                });

                // Event listeners
                document.getElementById('save-content-btn').addEventListener('click', async () => {
                    const jobDocRef = doc(db, `/artifacts/${appId}/public/data/jobs`, currentJobId);
                    await setDoc(jobDocRef, { reportContent: activeEditor.getContent() }, { merge: true });
                    showAlert("บันทึกเนื้อหาสำหรับงานนี้สำเร็จ", "success");
                });
                
                document.getElementById('save-as-template-btn').addEventListener('click', async () => {
                    const name = prompt("กรุณาตั้งชื่อ Template ใหม่:");
                    if (name && name.trim() !== '') {
                        const templatesRef = collection(db, `/artifacts/${appId}/public/data/report_templates`);
                        await addDoc(templatesRef, {
                            name: name.trim(),
                            content: activeEditor.getContent(),
                            createdAt: new Date().toISOString(),
                            createdBy: auth.currentUser.uid
                        });
                        showAlert(`บันทึกเป็น Template ใหม่ชื่อ "${name}" สำเร็จ`, "success");
                    }
                });
                
                document.getElementById('preview-pdf-btn').addEventListener('click', () => generatePDF(true));
                document.getElementById('generate-pdf-btn').addEventListener('click', () => generatePDF(false));
                document.getElementById('confirm-generate-pdf').addEventListener('click', () => {
                    bootstrap.Modal.getInstance(document.getElementById('pdfPreviewModal')).hide();
                    generatePDF(false);
                });

                // Tags system
                document.querySelectorAll('.tag-button').forEach(button => {
                    button.addEventListener('click', () => {
                        const tag = button.dataset.tag;
                        if (activeEditor) {
                            activeEditor.insertContent(tag);
                            showAlert(`แทรก ${tag} สำเร็จ`, 'info', 2000);
                        }
                    });
                });

                // File preview handlers
                const setupFilePreview = (inputId, previewId) => {
                    document.getElementById(inputId).addEventListener('change', function(e) {
                        const file = e.target.files[0];
                        const previewDiv = document.getElementById(previewId);
                        
                        if (file) {
                            const reader = new FileReader();
                            reader.onload = function(e) {
                                previewDiv.innerHTML = `<img src="${e.target.result}" class="image-preview" alt="Preview">`;
                            };
                            reader.readAsDataURL(file);
                        } else {
                            previewDiv.innerHTML = '';
                        }
                    });
                };

                setupFilePreview('header-img', 'header-preview');
                setupFilePreview('footer-img', 'footer-preview');
                setupFilePreview('watermark-img', 'watermark-preview');

                // Watermark opacity slider
                document.getElementById('watermark-opacity').addEventListener('input', function(e) {
                    document.getElementById('opacity-value').textContent = e.target.value;
                });

            } catch (error) { 
                showAlert(`เกิดข้อผิดพลาดในการเชื่อมต่อ: ${error.message}`, 'danger'); 
            }
        })();

        // Sidebar toggle
        document.getElementById('sidebarToggle').addEventListener('click', () => {
            document.getElementById('wrapper').classList.toggle('sidebar-mini');
        });
    </script>
</body>
</html>