<!-- 
  path: /ui/job-details.html
  version: 3.6
  date: 2025-09-02
  time: 19:01:00
-->
<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>รายละเอียดงาน - Light Measurement System</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/choices.js/public/assets/styles/choices.min.css"/>

    <style>
        :root {
            --primary-color: #003366;
            --secondary-color: #4a6fa5;
            --background-color: #f8f9fa;
            --success-color: #198754;
            --card-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        body { font-family: 'Sarabun', sans-serif; background-color: var(--background-color); }
        .navbar { background-color: var(--primary-color); }
        .navbar-brand { color: #fff !important; font-weight: 700; }
        .main-header { background-color: #ffffff; padding: 1.5rem 2rem; border-radius: 0.5rem; box-shadow: var(--card-shadow); margin-bottom: 2rem; }
        .main-header h1 { color: var(--primary-color); font-weight: 700; margin: 0; }
        .breadcrumb-item a { color: var(--secondary-color); text-decoration: none; }
        .card { border: none; border-radius: 0.5rem; box-shadow: var(--card-shadow); }
        .info-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1.5rem; }
        .info-item h6 { color: var(--secondary-color); font-weight: 400; margin-bottom: 0.25rem; }
        .info-item p { font-weight: 500; margin-bottom: 0; }
        .table thead { background-color: var(--secondary-color); color: #fff; }
        .table-hover tbody tr:hover { background-color: #e9ecef; }
        .form-control-sm, .form-select-sm { height: calc(1.5em + 0.5rem + 2px); padding: 0.25rem 0.5rem; font-size: .875rem; }
        .result-pass { color: var(--success-color); font-weight: bold; }
        .result-fail { color: #dc3545; font-weight: bold; }
        .action-icon { cursor: pointer; color: var(--secondary-color); }
        .choices__inner { font-size: .875rem; min-height: auto; }
        .choices__list--dropdown { font-size: .875rem; }
        #measurement-table-body tr.choices-active { z-index: 10; }
        .table-responsive.dropdown-open { overflow: visible; }
        .result-input-group { display: flex; gap: 4px; }
        #save-feedback { display: none; color: var(--success-color); font-weight: 500; }
    </style>
</head>
<body>

    <!-- Navigation Bar -->
    <nav class="navbar navbar-expand-lg navbar-dark sticky-top">
        <div class="container-fluid">
            <a class="navbar-brand" href="main.html"><i class="fas fa-lightbulb me-2"></i>Light Measurement System</a>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="container-fluid p-4">
        <div class="main-header">
            <nav><ol class="breadcrumb"><li class="breadcrumb-item"><a href="main.html">รายการงาน</a></li><li class="breadcrumb-item active">รายละเอียดงาน</li></ol></nav>
            <h1 class="mt-2"><i class="fas fa-clipboard-list me-3"></i><span id="jobIdDisplay">กำลังโหลด...</span></h1>
        </div>
        <div class="card mb-4"><div class="card-body p-4"><div class="info-grid">
            <div class="info-item"><h6><i class="fas fa-building me-2"></i>ลูกค้า</h6><p id="customerNameDisplay">...</p></div>
            <div class="info-item"><h6><i class="fas fa-map-marker-alt me-2"></i>สาขา</h6><p id="locationNameDisplay">...</p></div>
            <div class="info-item"><h6><i class="fas fa-calendar-alt me-2"></i>วันที่ตรวจวัด</h6><p id="jobDateDisplay">...</p></div>
        </div></div></div>

        <div class="card">
            <div class="card-body p-4">
                <div class="d-flex flex-wrap justify-content-between align-items-center mb-3 gap-2">
                    <h4 class="text-primary mb-0">บันทึกผลการตรวจวัด</h4>
                    <div class="d-flex align-items-center gap-2">
                        <span id="save-feedback" class="me-2"><i class="fas fa-check-circle"></i> บันทึกข้อมูลแล้ว!</span>
                        <div class="btn-group">
                            <button type="button" class="btn btn-outline-secondary btn-sm dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false"><i class="fas fa-cogs me-2"></i>จัดการ Template</button>
                            <ul class="dropdown-menu">
                                <li><a class="dropdown-item" href="#" data-bs-toggle="modal" data-bs-target="#loadTemplateModal"><i class="fas fa-download me-2"></i>เรียกใช้ Template</a></li>
                                <li><a class="dropdown-item" href="#" data-bs-toggle="modal" data-bs-target="#saveTemplateModal"><i class="fas fa-save me-2"></i>บันทึกเป็น Template</a></li>
                            </ul>
                        </div>
                        <button id="saveDataBtn" class="btn btn-primary btn-sm"><i class="fas fa-save me-2"></i>บันทึกข้อมูล (Firestore)</button>
                        <button class="btn btn-success btn-sm" onclick="window.location.href='report-generation.html'"><i class="fas fa-file-word me-2"></i>สร้างรายงาน</button>
                    </div>
                </div>
                 <div class="bg-light p-2 rounded border mb-3 d-flex align-items-center gap-2">
                    <label class="form-label mb-0 small">เครื่องมือช่วย:</label>
                    <input type="number" id="numRowsToAdd" class="form-control form-control-sm" style="width: 80px;" value="10" min="1">
                    <button id="bulkAddBtn" type="button" class="btn btn-outline-primary btn-sm" data-bs-toggle="modal" data-bs-target="#bulkAddModal"><i class="fas fa-plus-square me-2"></i>เพิ่มแถวเปล่า</button>
                </div>
                
                <div class="table-responsive">
                    <table class="table table-bordered table-hover align-middle">
                        <thead class="text-center">
                            <tr>
                                <th style="width: 5%;">ลำดับ</th>
                                <th style="width: 15%;">Lay Out</th>
                                <th style="width: 20%;">พื้นที่ตรวจวัด</th>
                                <th style="width: 15%;">ลักษณะงาน</th>
                                <th style="width: 10%;">ประเภท</th>
                                <th style="width: 10%;">ค่ามาตรฐาน</th>
                                <th style="width: 15%;">ผลที่วัดได้ (LUX)</th>
                                <th style="width: 5%;">ผล</th>
                                <th style="width: 5%;">ลบ</th>
                            </tr>
                        </thead>
                        <tbody id="measurement-table-body">
                           <tr><td colspan="9" class="text-center p-4">กำลังโหลดข้อมูล...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modals -->
    <div class="modal fade" id="bulkAddModal" tabindex="-1"><div class="modal-dialog"><div class="modal-content">
        <div class="modal-header"><h5 class="modal-title"><i class="fas fa-cogs me-2"></i>ตั้งค่าเริ่มต้น</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
        <div class="modal-body">
            <div class="mb-3"><label for="layoutPattern" class="form-label">รูปแบบ Lay Out</label><input type="text" class="form-control" id="layoutPattern" value="Lay Out จุดที่ {x}"><div class="form-text">ใช้ <strong>{x}</strong> แทน Running Number</div></div>
            <div class="mb-3"><label for="layoutStartIndex" class="form-label">เริ่มนับที่</label><input type="number" class="form-control" id="layoutStartIndex" value="1" min="1"></div>
            <div class="mb-3"><label for="defaultArea" class="form-label">พื้นที่ตรวจวัด (เริ่มต้น)</label><input type="text" class="form-control" id="defaultArea"></div>
            <div class="mb-3"><label for="defaultWorkType" class="form-label">ลักษณะงาน (เริ่มต้น)</label><select id="defaultWorkType"></select></div>
        </div>
        <div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ยกเลิก</button><button type="button" class="btn btn-primary" id="applyBulkAddBtn">ยืนยัน</button></div>
    </div></div></div>
    <div class="modal fade" id="saveTemplateModal" tabindex="-1"><div class="modal-dialog"><div class="modal-content">
        <div class="modal-header"><h5 class="modal-title"><i class="fas fa-save me-2"></i>บันทึกเป็น Template</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
        <div class="modal-body"><p>บันทึก <span id="save-item-count">0</span> รายการ เป็น Template ใหม่</p><div class="mb-3"><label for="templateName" class="form-label">ชื่อ Template</label><input type="text" class="form-control" id="templateName"></div></div>
        <div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ยกเลิก</button><button type="button" class="btn btn-primary" id="saveTemplateConfirmBtn">บันทึก</button></div>
    </div></div></div>
    <div class="modal fade" id="loadTemplateModal" tabindex="-1"><div class="modal-dialog modal-lg"><div class="modal-content">
        <div class="modal-header"><h5 class="modal-title"><i class="fas fa-download me-2"></i>เรียกใช้ Template</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
        <div class="modal-body">
            <div class="input-group mb-3"><span class="input-group-text"><i class="fas fa-search"></i></span><input type="text" class="form-control" placeholder="ค้นหา..." id="templateSearchInput"></div>
            <div id="template-list-container" class="list-group" style="max-height: 400px; overflow-y: auto;"></div>
        </div>
        <div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ปิด</button></div>
    </div></div></div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/choices.js/public/assets/scripts/choices.min.js"></script>
    
    <!-- Firebase Configuration -->
    <script src="firebase-config.js"></script>
    
    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, updateDoc, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        (async () => {
            const tableBody = document.getElementById('measurement-table-body');
            
            // --- Configuration ---
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'light-measurement-app';
            let finalFirebaseConfig;
            
            try {
                const envConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
                if (envConfig && envConfig.projectId) {
                    finalFirebaseConfig = envConfig;
                } else if (window.firebaseConfig && window.firebaseConfig.projectId) {
                    finalFirebaseConfig = window.firebaseConfig;
                }
            } catch (e) {
                 console.error("Could not parse Firebase config:", e);
            }

            if (!finalFirebaseConfig || !finalFirebaseConfig.projectId) {
                console.error("Firebase config is missing projectId. Cannot proceed.");
                document.getElementById('jobIdDisplay').textContent = "Config Error";
                if(tableBody) tableBody.innerHTML = `<tr><td colspan="9" class="text-center p-4 text-danger"><strong>Error:</strong> ไม่สามารถเชื่อมต่อฐานข้อมูลได้เนื่องจากค่า "projectId" ไม่ถูกต้อง. กรุณาตั้งค่าในไฟล์ firebase-config.js</td></tr>`;
                return;
            }

            // --- Initialize Firebase ---
            const app = initializeApp(finalFirebaseConfig);
            const db = getFirestore(app);
            const auth = getAuth(app);
            setLogLevel('debug');

            // --- DOM Elements & Data ---
            const workTypeData = [
                { value: 'งานเอกสาร-คอมพิวเตอร์', label: 'งานเอกสาร-คอมพิวเตอร์', stdSpot: '400-500', stdAreaAvg: '450', stdAreaMin: '300' },
                { value: 'งานเอกสาร', label: 'งานเอกสาร', stdSpot: '400-500', stdAreaAvg: '450', stdAreaMin: '300' }
            ];
             const mockTemplates = [
                { id: 1, name: "สาขาขนาดเล็ก (15 จุด)", itemCount: 15, items: [ { layout: "จุดที่ {x}", area: "พื้นที่บริการ", workType: "งานเอกสาร-คอมพิวเตอร์" }] },
                { id: 2, name: "สาขาขนาดกลาง (30 จุด)", itemCount: 30, items: [ { layout: "จุดที่ {x}", area: "พื้นที่บริการ", workType: "งานเอกสาร-คอมพิวเตอร์" }] },
            ];


            // --- Core UI Functions ---
            const choicesConfig = { searchEnabled: true, itemSelectText: 'กดเพื่อเลือก', allowHTML: false, shouldSort: false };
            const createTableRow = (defaults = {}) => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td class="text-center"></td>
                    <td><input type="text" class="form-control form-control-sm" value="${defaults.layout || ''}" data-field="layout"></td>
                    <td><input type="text" class="form-control form-control-sm" value="${defaults.area || ''}" data-field="area"></td>
                    <td><select class="work-type-select" data-field="workType"></select></td>
                    <td><select class="form-select form-select-sm measurement-type" data-field="measurementType">
                        <option value="spot" ${defaults.measurementType === 'spot' ? 'selected' : ''}>จุด</option>
                        <option value="area" ${defaults.measurementType === 'area' ? 'selected' : ''}>พื้นที่</option>
                    </select></td>
                    <td class="text-center standard-value" data-field="standard"></td>
                    <td class="result-input-cell"></td>
                    <td class="text-center evaluation-result" data-field="evaluation"></td>
                    <td class="text-center"><i class="fas fa-trash-alt action-icon action-icon-delete delete-row"></i></td>
                `;
                const workTypeSelectEl = tr.querySelector('.work-type-select');
                const choices = new Choices(workTypeSelectEl, choicesConfig);
                choices.setChoices([{ value: '', label: 'เลือกลักษณะงาน', disabled: true}, ...workTypeData], 'value', 'label', false);
                if (defaults.workType) choices.setValue([defaults.workType]);
                updateRowState(tr);
                if(defaults.measurementType === 'spot' && defaults.spotValue) tr.querySelector('[data-field="spotValue"]').value = defaults.spotValue;
                if(defaults.measurementType === 'area' && defaults.areaAvgValue) tr.querySelector('[data-field="areaAvgValue"]').value = defaults.areaAvgValue;
                if(defaults.measurementType === 'area' && defaults.areaMinValue) tr.querySelector('[data-field="areaMinValue"]').value = defaults.areaMinValue;
                evaluateResult(tr);
                return tr;
            };
            const updateRowNumbers = () => tableBody.querySelectorAll('tr').forEach((row, i) => row.querySelector('td:first-child').textContent = i + 1);
            const addRow = (defaults) => tableBody.appendChild(createTableRow(defaults));
            function updateRowState(tr) { 
                const workType = tr.querySelector('.work-type-select').value;
                const measurementType = tr.querySelector('.measurement-type').value;
                const workTypeInfo = workTypeData.find(w => w.value === workType);
                const standardCell = tr.querySelector('.standard-value');
                const resultInputCell = tr.querySelector('.result-input-cell');
                let stdText = '-';
                if (workTypeInfo) {
                    if (measurementType === 'spot') {
                        stdText = workTypeInfo.stdSpot;
                        resultInputCell.innerHTML = `<input type="number" class="form-control form-control-sm text-center measured-value spot-value" placeholder="LUX" data-field="spotValue">`;
                    } else {
                        stdText = `Avg≥${workTypeInfo.stdAreaAvg} Min≥${workTypeInfo.stdAreaMin}`;
                        resultInputCell.innerHTML = `<div class="result-input-group"><input type="number" class="form-control form-control-sm text-center measured-value area-avg-value" placeholder="เฉลี่ย" data-field="areaAvgValue"><input type="number" class="form-control form-control-sm text-center measured-value area-min-value" placeholder="ต่ำสุด" data-field="areaMinValue"></div>`;
                    }
                } else { resultInputCell.innerHTML = ''; }
                standardCell.innerHTML = stdText.replace(/</g, "&lt;").replace(/>/g, "&gt;");
            }
            function evaluateResult(tr) {
                const workType = tr.querySelector('.work-type-select').value;
                const measurementType = tr.querySelector('.measurement-type').value;
                const workTypeInfo = workTypeData.find(w => w.value === workType);
                const resultCell = tr.querySelector('.evaluation-result');
                resultCell.textContent = '';
                resultCell.className = 'text-center evaluation-result';
                if (!workTypeInfo) return;
                let pass = false;
                if (measurementType === 'spot') {
                    const measuredValue = parseFloat(tr.querySelector('.spot-value')?.value);
                    if (!isNaN(measuredValue)) { const [min, max] = workTypeInfo.stdSpot.split('-').map(Number); pass = measuredValue >= min && measuredValue <= max; }
                } else {
                    const avgVal = parseFloat(tr.querySelector('.area-avg-value')?.value);
                    const minVal = parseFloat(tr.querySelector('.area-min-value')?.value);
                    if (!isNaN(avgVal) && !isNaN(minVal)) { pass = avgVal >= workTypeInfo.stdAreaAvg && minVal >= workTypeInfo.stdAreaMin; }
                }
                if (tr.querySelector('.measured-value')?.value) {
                    resultCell.textContent = pass ? 'ผ่าน' : 'ไม่ผ่าน';
                    resultCell.classList.add(pass ? 'result-pass' : 'result-fail');
                }
            }
            
            // --- Event Listeners ---
            tableBody.addEventListener('change', (e) => {
                if (e.target.classList.contains('work-type-select') || e.target.classList.contains('measurement-type')) {
                    const tr = e.target.closest('tr');
                    if (tr) {
                        updateRowState(tr);
                    }
                }
            });
            tableBody.addEventListener('input', (e) => { if(e.target.closest('tr')) evaluateResult(e.target.closest('tr'))});
            tableBody.addEventListener('click', (e) => { if (e.target.classList.contains('delete-row')) { e.target.closest('tr').remove(); updateRowNumbers(); }});

            // --- Modal & Template Logic ---
            const bulkAddModalEl = document.getElementById('bulkAddModal');
            const bulkAddModal = new bootstrap.Modal(bulkAddModalEl);
            const applyBulkAddBtn = document.getElementById('applyBulkAddBtn');
            const numRowsToAddInput = document.getElementById('numRowsToAdd');
            const defaultWorkTypeSelect = new Choices('#defaultWorkType', choicesConfig);
            defaultWorkTypeSelect.setChoices([{ value: '', label: 'ไม่ต้องกำหนด', selected: true }, ...workTypeData], 'value', 'label', false);
            applyBulkAddBtn.addEventListener('click', () => {
                const placeholderRow = tableBody.querySelector('td[colspan="9"]');
                if (placeholderRow) {
                    tableBody.innerHTML = '';
                }
                const count = parseInt(numRowsToAddInput.value, 10) || 0;
                const pattern = document.getElementById('layoutPattern').value;
                const startIndex = parseInt(document.getElementById('layoutStartIndex').value, 10) || 1;
                const area = document.getElementById('defaultArea').value;
                const workType = defaultWorkTypeSelect.getValue(true);
                for (let i = 0; i < count; i++) {
                    const newRow = createTableRow({ layout: pattern.replace('{x}', startIndex + i), area: area, workType: workType });
                    tableBody.appendChild(newRow);
                }
                updateRowNumbers();
                bulkAddModal.hide();
            });
            bulkAddModalEl.addEventListener('show.bs.modal', () => document.getElementById('layoutStartIndex').value = tableBody.rows.length + 1);
            
            const saveTemplateModalEl = document.getElementById('saveTemplateModal');
            saveTemplateModalEl.addEventListener('show.bs.modal', () => {
                document.getElementById('save-item-count').textContent = tableBody.rows.length;
                const customer = document.getElementById('customerNameDisplay')?.textContent || '';
                const location = document.getElementById('locationNameDisplay')?.textContent || '';
                if (customer && location) document.getElementById('templateName').value = `${customer} - ${location}`;
            });
            document.getElementById('saveTemplateConfirmBtn').addEventListener('click', () => {
                 const name = document.getElementById('templateName').value;
                 if(!name) { alert('กรุณาใส่ชื่อ Template'); return; }
                 alert(`Template "${name}" บันทึกสำเร็จ (จำลอง)`);
                 bootstrap.Modal.getInstance(saveTemplateModalEl).hide();
            });
            
            const loadTemplateModalEl = document.getElementById('loadTemplateModal');
            const loadTemplateModal = new bootstrap.Modal(loadTemplateModalEl);
            const templateListContainer = document.getElementById('template-list-container');
            const templateSearchInput = document.getElementById('templateSearchInput');
            const renderTemplateList = (filter = '') => {
                templateListContainer.innerHTML = '';
                mockTemplates.filter(t => t.name.toLowerCase().includes(filter.toLowerCase())).forEach(template => {
                    const item = document.createElement('a');
                    item.href = '#';
                    item.className = 'list-group-item list-group-item-action';
                    item.innerHTML = `<div class="d-flex w-100 justify-content-between"><h6 class="mb-1">${template.name}</h6><small>${template.itemCount} จุด</small></div><p class="mb-1 small">ตัวอย่าง: ${template.items[0].area} - ${template.items[0].workType}</p>`;
                    item.addEventListener('click', (e) => {
                        e.preventDefault();
                        if (confirm(`คุณต้องการล้างข้อมูลปัจจุบันและใช้ Template "${template.name}" หรือไม่?`)) {
                            tableBody.innerHTML = '';
                            for(let i = 0; i < template.itemCount; i++) {
                                const newRow = createTableRow({ layout: template.items[0].layout.replace('{x}', i + 1), area: template.items[0].area, workType: template.items[0].workType });
                                tableBody.appendChild(newRow);
                            }
                            updateRowNumbers();
                            loadTemplateModal.hide();
                        }
                    });
                    templateListContainer.appendChild(item);
                });
            };
            loadTemplateModalEl.addEventListener('show.bs.modal', () => renderTemplateList());
            templateSearchInput.addEventListener('input', (e) => renderTemplateList(e.target.value));


            // --- Firestore Logic ---
            async function loadJobData(jobDocId) {
                try {
                    const docRef = doc(db, `/artifacts/${appId}/public/data/jobs`, jobDocId);
                    const docSnap = await getDoc(docRef);

                    if (docSnap.exists()) {
                        const jobData = docSnap.data();
                        document.getElementById('jobIdDisplay').textContent = jobData.jobId;
                        document.getElementById('customerNameDisplay').textContent = jobData.customer;
                        document.getElementById('locationNameDisplay').textContent = jobData.location;
                        document.getElementById('jobDateDisplay').textContent = jobData.date;
                        
                        tableBody.innerHTML = ''; // Clear loading message
                        if (jobData.results && jobData.results.length > 0) {
                            jobData.results.forEach(result => addRow(result));
                            updateRowNumbers();
                        } else {
                             tableBody.innerHTML = '<tr><td colspan="9" class="text-center p-4">ยังไม่มีการบันทึกผล กด "เพิ่มแถว" เพื่อเริ่ม</td></tr>';
                        }
                    } else {
                        console.log("No such document!");
                        document.getElementById('jobIdDisplay').textContent = "ไม่พบข้อมูล";
                        tableBody.innerHTML = '<tr><td colspan="9" class="text-center p-4">ไม่พบข้อมูลสำหรับงานนี้</td></tr>';
                    }
                } catch (error) {
                    console.error("Error loading document:", error);
                    tableBody.innerHTML = `<tr><td colspan="9" class="text-center p-4 text-danger">เกิดข้อผิดพลาดในการโหลดข้อมูล: ${error.message}</td></tr>`;
                }
            }

            document.getElementById('saveDataBtn').addEventListener('click', async () => {
                const jobDocId = new URLSearchParams(window.location.search).get('id');
                if (!jobDocId) {
                    alert("ไม่พบ ID ของงาน ไม่สามารถบันทึกได้");
                    return;
                }

                const resultsData = [];
                tableBody.querySelectorAll('tr').forEach((tr, index) => {
                     resultsData.push({
                        seq: index + 1,
                        layout: tr.querySelector('[data-field="layout"]').value,
                        area: tr.querySelector('[data-field="area"]').value,
                        workType: tr.querySelector('[data-field="workType"]').value,
                        measurementType: tr.querySelector('[data-field="measurementType"]').value,
                        standard: tr.querySelector('[data-field="standard"]').textContent,
                        spotValue: tr.querySelector('[data-field="spotValue"]') ? tr.querySelector('[data-field="spotValue"]').value : null,
                        areaAvgValue: tr.querySelector('[data-field="areaAvgValue"]') ? tr.querySelector('[data-field="areaAvgValue"]').value : null,
                        areaMinValue: tr.querySelector('[data-field="areaMinValue"]') ? tr.querySelector('[data-field="areaMinValue"]').value : null,
                        evaluation: tr.querySelector('[data-field="evaluation"]').textContent
                    });
                });
                
                const dataToSaveForReport = {
                    jobId: document.getElementById('jobIdDisplay').textContent,
                    customer: document.getElementById('customerNameDisplay').textContent,
                    location: document.getElementById('locationNameDisplay').textContent,
                    date: document.getElementById('jobDateDisplay').textContent,
                    results: resultsData
                };
                localStorage.setItem('currentJobData', JSON.stringify(dataToSaveForReport));

                const docRef = doc(db, `/artifacts/${appId}/public/data/jobs`, jobDocId);
                try {
                    await updateDoc(docRef, { results: resultsData });
                    const feedback = document.getElementById('save-feedback');
                    feedback.style.display = 'inline';
                    setTimeout(() => { feedback.style.display = 'none'; }, 2000);
                } catch (error) {
                    console.error("Error updating document: ", error);
                    alert("เกิดข้อผิดพลาดในการบันทึกข้อมูล!");
                }
            });

            // --- Initial Load Logic ---
            try {
                if (typeof __initial_auth_token !== 'undefined') {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
                console.log("Authenticated successfully.");

                const jobIdFromUrl = new URLSearchParams(window.location.search).get('id');
                if (!jobIdFromUrl) {
                    console.error("No 'id' parameter found in URL.");
                    document.getElementById('jobIdDisplay').textContent = "ไม่ได้เลือกงาน";
                    document.querySelector('.card.mb-4').style.display = 'none';
                    tableBody.innerHTML = `<tr><td colspan="9" class="text-center p-4">
                        <h5 class="text-danger">ไม่พบ ID ของงาน</h5>
                        <p>กรุณากลับไปที่<a href="main.html">หน้ารายการหลัก</a> แล้วเลือกงานที่ต้องการดูรายละเอียด</p>
                    </td></tr>`;
                    document.getElementById('saveDataBtn').disabled = true;
                } else {
                    loadJobData(jobIdFromUrl);
                }

            } catch (error) {
                console.error("Authentication or data loading failed:", error);
                 tableBody.innerHTML = `<tr><td colspan="9" class="text-center p-4 text-danger">เกิดข้อผิดพลาดในการยืนยันตัวตน: ${error.message}</td></tr>`;
            }
        })();
    </script>
</body>
</html>

