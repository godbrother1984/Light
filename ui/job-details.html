<!-- 
  path: /ui/job-details.html
  version: 7.3 (Merged Original Logic with Modern UI & Bug Fixes)
  date: 2025-09-03
  time: 16:30:00
-->
<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>รายละเอียดงาน - Light Measurement System</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/choices.js/public/assets/styles/choices.min.css"/>

    <style>
        :root {
            --primary-color: #0d47a1;
            --secondary-color: #1976d2;
            --background-color: #f4f7f9;
            --sidebar-width: 260px;
            --sidebar-mini-width: 80px;
            --card-shadow: 0 2px 10px rgba(0,0,0,0.05);
            --transition-speed: 0.3s;
            --success-color: #198754;
            --danger-color: #dc3545;
        }
        body { font-family: 'Sarabun', sans-serif !important; background-color: var(--background-color); overflow-x: hidden; }
        #wrapper { display: flex; }
        #sidebar-wrapper { width: var(--sidebar-width); min-height: 100vh; background-color: var(--primary-color); transition: width var(--transition-speed) ease; }
        #wrapper.sidebar-mini #sidebar-wrapper { width: var(--sidebar-mini-width); }
        .sidebar-heading { padding: 1rem 1.25rem; font-size: 1.5rem; font-weight: 700; color: #fff; white-space: nowrap; }
        .sidebar-heading .logo-text { display: inline; transition: opacity var(--transition-speed) ease; }
        #wrapper.sidebar-mini .sidebar-heading .logo-text { opacity: 0; display: none; }
        .list-group-item { border: none; padding: 1rem 1.5rem; color: rgba(255,255,255,0.8); background-color: transparent; transition: background-color var(--transition-speed) ease; white-space: nowrap; display: flex; align-items: center; }
        .list-group-item i { font-size: 1.25rem; }
        .list-group-item .menu-text { opacity: 1; transition: opacity 0.2s ease; }
        #wrapper.sidebar-mini .list-group-item .menu-text { opacity: 0; display: none; }
        .list-group-item:hover, .list-group-item.active { background-color: var(--secondary-color); color: #fff; }
        #page-content-wrapper { flex-grow: 1; }
        .navbar { box-shadow: var(--card-shadow); }
        .card { box-shadow: var(--card-shadow); border: none; border-radius: .5rem; }
        .form-control:focus, .form-select:focus, .choices__input:focus { box-shadow: 0 0 0 .25rem rgba(13, 71, 161, .25); border-color: var(--secondary-color); }
        .table-responsive .form-control-sm, .table-responsive .form-select-sm { min-width: 120px; }
        .badge.bg-success, .result-pass { color: var(--success-color) !important; font-weight: bold; }
        .badge.bg-danger, .result-fail { color: var(--danger-color) !important; font-weight: bold; }
        .personnel-list { list-style: none; padding-left: 0; }
        .result-input-group { display: flex; gap: 4px; }
        .choices__inner { font-size: .875rem; min-height: auto; padding: 0.25rem 0.5rem;}
        .choices__list--dropdown { font-size: .875rem; }
        .action-icon { cursor: pointer; color: var(--secondary-color); }
    </style>
</head>
<body>
    
    <div class="d-flex" id="wrapper">
        <!-- Sidebar -->
        <div id="sidebar-wrapper">
            <div class="sidebar-heading"><i class="fas fa-lightbulb me-2"></i><span class="logo-text">Light Measuring</span></div>
            <div class="list-group list-group-flush">
                <a class="list-group-item active" href="main.html"><i class="fas fa-tasks fa-fw me-3"></i><span class="menu-text">รายการงานทั้งหมด</span></a>
                <a class="list-group-item" href="master-data-manager.html"><i class="fas fa-database fa-fw me-3"></i><span class="menu-text">จัดการข้อมูลหลัก</span></a>
                <a class="list-group-item" href="template-manager.html"><i class="fas fa-file-alt fa-fw me-3"></i><span class="menu-text">จัดการ Template</span></a>
            </div>
        </div>

        <!-- Page Content -->
        <div id="page-content-wrapper">
            <nav class="navbar navbar-expand-lg navbar-light bg-white border-bottom sticky-top">
                <div class="container-fluid">
                    <button class="btn btn-outline-primary me-2" id="sidebarToggle"><i class="fas fa-bars"></i></button>
                    <ul class="navbar-nav ms-auto d-flex flex-row">
                        <li class="nav-item dropdown">
                            <a class="nav-link dropdown-toggle d-flex align-items-center" href="#" id="userDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                                <i class="fas fa-user-circle fa-2x text-muted"></i>
                            </a>
                            <ul class="dropdown-menu dropdown-menu-end">
                                <li><h6 class="dropdown-header">User Profile</h6></li>
                                <li><a class="dropdown-item" href="#"><span id="user-display">Connecting...</span></a></li>
                            </ul>
                        </li>
                    </ul>
                </div>
            </nav>

            <main class="container-fluid p-4">
                <div id="alert-placeholder"></div>
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h1 class="h3 mb-0">รายละเอียดงาน: <span id="jobIdDisplay" class="text-primary">Loading...</span></h1>
                    <div>
                        <a href="main.html" class="btn btn-outline-secondary"><i class="fas fa-arrow-left me-2"></i>กลับหน้ารายการ</a>
                        <button id="saveDataBtn" class="btn btn-success"><i class="fas fa-save me-2"></i>บันทึกข้อมูล</button>
                    </div>
                </div>

                <div class="card mb-4">
                    <div class="card-body" id="job-details-container"><p class="text-center text-muted">Loading job details...</p></div>
                </div>

                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0"><i class="fas fa-ruler-combined me-2"></i>บันทึกผลการตรวจวัด</h5>
                        <div>
                            <button id="addRowSpotBtn" class="btn btn-primary btn-sm"><i class="fas fa-plus me-2"></i>เพิ่มแถว (จุด)</button>
                            <button id="addRowAreaBtn" class="btn btn-primary btn-sm"><i class="fas fa-plus me-2"></i>เพิ่มแถว (พื้นที่)</button>
                            <button id="advancedAddBtn" class="btn btn-info btn-sm"><i class="fas fa-magic me-2"></i>เครื่องมือช่วย</button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                             <table class="table table-bordered table-hover align-middle">
                                <thead class="table-light">
                                    <tr class="text-center">
                                        <th style="width: 5%;">ลำดับ</th>
                                        <th style="width: 15%;">Lay Out</th>
                                        <th style="width: 20%;">พื้นที่ตรวจวัด</th>
                                        <th style="width: 20%;">ลักษณะงาน</th>
                                        <th style="width: 8%;">ประเภท</th>
                                        <th style="width: 12%;">ค่ามาตรฐาน</th>
                                        <th style="width: 15%;">ผลที่วัดได้ (LUX)</th>
                                        <th style="width: 5%;">ผล</th>
                                        <th style="width: 5%;">ลบ</th>
                                    </tr>
                                </thead>
                                <tbody id="results-table-body"></tbody>
                             </table>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>
    
    <!-- Modals -->
    <div class="modal fade" id="advancedAddModal" tabindex="-1"><div class="modal-dialog"><div class="modal-content">
        <div class="modal-header"><h5 class="modal-title">เครื่องมือช่วยสร้างแถว</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
        <div class="modal-body">
            <form id="advancedAddForm">
                <div class="mb-3"><label for="rowCount" class="form-label">จำนวนแถวที่ต้องการสร้าง</label><input type="number" id="rowCount" class="form-control" value="10" min="1"></div>
                <div class="mb-3"><label for="layoutPattern" class="form-label">รูปแบบ Lay Out</label><input type="text" class="form-control" id="layoutPattern" value="Lay Out จุดที่ {x}"><div class="form-text">ใช้ <strong>{x}</strong> แทน Running Number</div></div>
                <div class="mb-3"><label for="layoutStartIndex" class="form-label">เริ่มนับที่</label><input type="number" class="form-control" id="layoutStartIndex" value="1" min="1"></div>
                <div class="mb-3"><label for="defaultArea" class="form-label">พื้นที่ตรวจวัด (เริ่มต้น)</label><input type="text" class="form-control" id="defaultArea"></div>
                <div class="mb-3"><label for="defaultWorkType" class="form-label">ลักษณะงาน (เริ่มต้น)</label><select id="defaultWorkType" class="form-select"></select></div>
            </form>
        </div>
        <div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ยกเลิก</button><button type="button" id="executeAdvancedAdd" class="btn btn-primary">สร้างแถว</button></div>
    </div></div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/choices.js/public/assets/scripts/choices.min.js"></script>
    <script src="firebase-config.js"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, updateDoc, onSnapshot, collection } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const appId = typeof __app_id !== 'undefined' ? __app_id : 'light-measuring-app';
        let db, auth, workTypes = [];
        const choicesInstances = new Map();

        const advancedAddModal = new bootstrap.Modal(document.getElementById('advancedAddModal'));
        const showAlert = (message, type = 'success', duration=4000) => { const alertPlaceholder = document.getElementById('alert-placeholder'); const wrapper = document.createElement('div'); wrapper.innerHTML = `<div class="alert alert-${type} alert-dismissible" role="alert">${message}<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button></div>`; alertPlaceholder.innerHTML = ''; alertPlaceholder.append(wrapper); setTimeout(() => wrapper.remove(), duration); };
        
        const renderJobDetails = (data) => {
            const container = document.getElementById('job-details-container');
            container.innerHTML = `<div class="row g-3"><div class="col-md-4"><h6><i class="fas fa-building me-2"></i>ลูกค้า</h6><p class="form-control-plaintext">${data.customerName || ''}</p></div><div class="col-md-4"><h6><i class="fas fa-map-marker-alt me-2"></i>สถานที่</h6><p class="form-control-plaintext">${data.location || ''}</p></div><div class="col-md-4"><h6><i class="fas fa-calendar-alt me-2"></i>วันที่ตรวจวัด</h6><input type="date" class="form-control" id="measurementDate" value="${data.date || ''}"></div><hr class="my-3"><div class="col-md-4"><h6><i class="fas fa-user-friends me-2"></i>ผู้ตรวจวัด</h6><ul class="personnel-list">${(data.inspectors || []).map(name => `<li>${name}</li>`).join('') || '<li>N/A</li>'}</ul></div><div class="col-md-4"><h6><i class="fas fa-user-cog me-2"></i>ผู้วิเคราะห์</h6><ul class="personnel-list">${(data.analysts || []).map(name => `<li>${name}</li>`).join('') || '<li>N/A</li>'}</ul></div><div class="col-md-4"><h6><i class="fas fa-user-edit me-2"></i>ผู้จัดทำรายงาน</h6><p class="form-control-plaintext">${data.reportCreator || 'N/A'}</p></div></div>`;
        };
        
        const createTableRow = (data = {}) => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td class="text-center"></td>
                <td><input type="text" class="form-control form-control-sm" data-field="layout" value="${data.layout || ''}"></td>
                <td><input type="text" class="form-control form-control-sm" data-field="area" value="${data.area || ''}"></td>
                <td><select class="work-type-select" data-field="workType"></select></td>
                <td><select class="form-select form-select-sm" data-field="measurementType"><option value="spot">จุด</option><option value="area">พื้นที่</option></select></td>
                <td class="text-center standard-cell" data-field="standard">-</td>
                <td class="result-input-cell"></td>
                <td class="text-center evaluation-cell" data-field="evaluation"></td>
                <td class="text-center"><i class="fas fa-trash-alt action-icon delete-row-btn"></i></td>
            `;

            const workTypeSelect = tr.querySelector('.work-type-select');
            const choices = new Choices(workTypeSelect, { searchEnabled: true, itemSelectText: 'เลือก', allowHTML: false, shouldSort: false });
            choices.setChoices([{value: '', label: 'เลือก...'}, ...workTypes.map(w => ({ value: w.name, label: w.name }))], 'value', 'label', false);
            if (data.workType) choices.setChoiceByValue(data.workType);
            choicesInstances.set(tr, choices);

            const measurementTypeSelect = tr.querySelector('[data-field="measurementType"]');
            if (data.measurementType) measurementTypeSelect.value = data.measurementType;

            updateRowState(tr, data);
            return tr;
        };

        const updateRowState = (tr, data = {}) => {
            const workType = tr.querySelector('[data-field="workType"]').value;
            const measurementType = tr.querySelector('[data-field="measurementType"]').value;
            const typeData = workTypes.find(w => w.name === workType);
            const standardCell = tr.querySelector('.standard-cell');
            const resultCell = tr.querySelector('.result-input-cell');
            let stdText = '-';

            if(typeData) {
                if(measurementType === 'spot') {
                    stdText = `${typeData.stdSpotMin || 'N/A'}-${typeData.stdSpotMax || 'N/A'}`;
                    resultCell.innerHTML = `<input type="number" class="form-control form-control-sm text-center" data-field="spotValue" value="${data.spotValue || ''}" placeholder="LUX">`;
                } else {
                    stdText = `Avg≥${typeData.stdAreaAvg || 'N/A'}, Min≥${typeData.stdAreaMin || 'N/A'}`;
                    resultCell.innerHTML = `<div class="result-input-group"><input type="number" class="form-control form-control-sm text-center" data-field="areaAvgValue" value="${data.areaAvgValue || ''}" placeholder="เฉลี่ย"><input type="number" class="form-control form-control-sm text-center" data-field="areaMinValue" value="${data.areaMinValue || ''}" placeholder="ต่ำสุด"></div>`;
                }
            } else {
                resultCell.innerHTML = '';
            }
            standardCell.textContent = stdText;
            evaluateResult(tr);
        };

        const evaluateResult = (tr) => {
            const workType = tr.querySelector('[data-field="workType"]').value;
            const measurementType = tr.querySelector('[data-field="measurementType"]').value;
            const typeData = workTypes.find(w => w.name === workType);
            const evaluationCell = tr.querySelector('.evaluation-cell');
            evaluationCell.innerHTML = '';
            if(!typeData) return;

            let pass = false;
            let hasValue = false;
            if(measurementType === 'spot') {
                const spotInput = tr.querySelector('[data-field="spotValue"]');
                if (spotInput && spotInput.value) {
                    const val = parseFloat(spotInput.value);
                    hasValue = true;
                    pass = val >= (typeData.stdSpotMin || -Infinity) && val <= (typeData.stdSpotMax || Infinity);
                }
            } else {
                const avgInput = tr.querySelector('[data-field="areaAvgValue"]');
                const minInput = tr.querySelector('[data-field="areaMinValue"]');
                if(avgInput && avgInput.value && minInput && minInput.value) {
                    const avgVal = parseFloat(avgInput.value);
                    const minVal = parseFloat(minInput.value);
                    hasValue = true;
                    pass = avgVal >= (typeData.stdAreaAvg || -Infinity) && minVal >= (typeData.stdAreaMin || -Infinity);
                }
            }
            if(hasValue) evaluationCell.innerHTML = pass ? '<span class="result-pass">ผ่าน</span>' : '<span class="result-fail">ไม่ผ่าน</span>';
        };

        const renumberRows = () => {
            const dataRows = document.querySelectorAll('#results-table-body tr:not(.no-data-row)');
            dataRows.forEach((row, index) => {
                row.cells[0].textContent = index + 1;
            });
        };

        async function main() {
            let finalFirebaseConfig;
            try { if (typeof __firebase_config !== 'undefined') finalFirebaseConfig = JSON.parse(__firebase_config); else if (window.firebaseConfig && window.firebaseConfig.projectId) finalFirebaseConfig = window.firebaseConfig; } catch(e) { console.error(e); }
            if (!finalFirebaseConfig) { showAlert('ไม่พบ Firebase Config', 'danger'); return; }

            const app = initializeApp(finalFirebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            
            try {
                if (typeof __initial_auth_token !== 'undefined') await signInWithCustomToken(auth, __initial_auth_token);
                else await signInAnonymously(auth);
                document.getElementById('user-display').textContent = `UID: ${auth.currentUser.uid.substring(0, 8)}...`;
                
                const workTypesCollection = collection(db, `/artifacts/${appId}/public/data/work_types`);
                onSnapshot(workTypesCollection, (snapshot) => { 
                    workTypes = snapshot.docs.map(doc => ({id: doc.id, ...doc.data(), name: doc.data().workTypeName}));
                    document.getElementById('defaultWorkType').innerHTML = '<option value="">-- ไม่กำหนด --</option>' + workTypes.map(w => `<option value="${w.name}">${w.name}</option>`).join('');
                });
                
                const jobId = new URLSearchParams(window.location.search).get('id');
                if (!jobId) { document.getElementById('jobIdDisplay').textContent = "ไม่ได้เลือกงาน"; showAlert('ไม่พบ ID ของงาน', 'danger'); return; }
                document.getElementById('jobIdDisplay').textContent = jobId;
                
                const jobDocRef = doc(db, `/artifacts/${appId}/public/data/jobs`, jobId);
                const docSnap = await getDoc(jobDocRef);
                if (docSnap.exists()) { 
                    const jobData = docSnap.data();
                    renderJobDetails(jobData);
                    const tableBody = document.getElementById('results-table-body');
                    tableBody.innerHTML = '';
                    if (jobData.results && jobData.results.length > 0) {
                        jobData.results.forEach(res => tableBody.appendChild(createTableRow(res)));
                    } else {
                        tableBody.innerHTML = `<tr class="no-data-row"><td colspan="9" class="text-center p-4">ยังไม่มีข้อมูลการตรวจวัด</td></tr>`;
                    }
                    renumberRows();
                } else { showAlert('ไม่พบข้อมูลสำหรับงานนี้', 'danger'); }

            } catch (error) { showAlert(`เกิดข้อผิดพลาด: ${error.message}`, 'danger'); }

            const tableBody = document.getElementById('results-table-body');
            const clearPlaceholder = () => {
                const placeholder = tableBody.querySelector('.no-data-row');
                if(placeholder) placeholder.remove();
            }
            
            document.getElementById('addRowSpotBtn').addEventListener('click', () => { clearPlaceholder(); tableBody.appendChild(createTableRow({ measurementType: 'spot' })); renumberRows(); });
            document.getElementById('addRowAreaBtn').addEventListener('click', () => { clearPlaceholder(); tableBody.appendChild(createTableRow({ measurementType: 'area' })); renumberRows(); });
            
            document.getElementById('advancedAddBtn').addEventListener('click', () => { 
                const currentCount = tableBody.querySelectorAll('tr:not(.no-data-row)').length;
                document.getElementById('layoutStartIndex').value = currentCount + 1; 
                advancedAddModal.show(); 
            });

            document.getElementById('executeAdvancedAdd').addEventListener('click', () => {
                clearPlaceholder();
                const count = parseInt(document.getElementById('rowCount').value, 10);
                const pattern = document.getElementById('layoutPattern').value;
                const startIndex = parseInt(document.getElementById('layoutStartIndex').value, 10);
                const area = document.getElementById('defaultArea').value;
                const workType = document.getElementById('defaultWorkType').value;
                
                for(let i=0; i < count; i++) {
                    tableBody.appendChild(createTableRow({ layout: pattern.replace('{x}', startIndex + i), area: area, workType: workType, measurementType: 'spot' }));
                }
                renumberRows();
                advancedAddModal.hide();
            });

            tableBody.addEventListener('change', e => {
                const tr = e.target.closest('tr');
                if(!tr) return;
                if (e.target.matches('[data-field="workType"], [data-field="measurementType"]')) {
                    updateRowState(tr);
                }
                evaluateResult(tr);
            });
            tableBody.addEventListener('input', e => { if (e.target.closest('tr')) evaluateResult(e.target.closest('tr')); });
            tableBody.addEventListener('click', e => { if (e.target.closest('.delete-row-btn')) { const row = e.target.closest('tr'); choicesInstances.get(row)?.destroy(); choicesInstances.delete(row); row.remove(); renumberRows(); } });

            document.getElementById('saveDataBtn').addEventListener('click', async () => {
                const button = document.getElementById('saveDataBtn');
                button.disabled = true; button.innerHTML = `<span class="spinner-border spinner-border-sm"></span> กำลังบันทึก...`;
                const jobId = document.getElementById('jobIdDisplay').textContent;
                const jobDocRef = doc(db, `/artifacts/${appId}/public/data/jobs`, jobId);
                const results = [];
                document.querySelectorAll('#results-table-body tr:not(.no-data-row)').forEach(tr => {
                    results.push({
                        layout: tr.querySelector('[data-field="layout"]').value,
                        area: tr.querySelector('[data-field="area"]').value,
                        workType: tr.querySelector('[data-field="workType"]').value,
                        measurementType: tr.querySelector('[data-field="measurementType"]').value,
                        standard: tr.querySelector('[data-field="standard"]').textContent,
                        spotValue: tr.querySelector('[data-field="spotValue"]')?.value || null,
                        areaAvgValue: tr.querySelector('[data-field="areaAvgValue"]')?.value || null,
                        areaMinValue: tr.querySelector('[data-field="areaMinValue"]')?.value || null,
                        evaluation: tr.querySelector('[data-field="evaluation"]').textContent,
                    });
                });
                try { await updateDoc(jobDocRef, { date: document.getElementById('measurementDate').value, results: results }); showAlert('บันทึกข้อมูลสำเร็จแล้ว'); } 
                catch(err) { showAlert(`เกิดข้อผิดพลาดในการบันทึก: ${err.message}`, 'danger'); } 
                finally { button.disabled = false; button.innerHTML = `<i class="fas fa-save me-2"></i>บันทึกข้อมูล`; }
            });
        }
        main();
        
        document.getElementById('sidebarToggle').addEventListener('click', () => {
            document.getElementById('wrapper').classList.toggle('sidebar-mini');
        });
    </script>
</body>
</html>

