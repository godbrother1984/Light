<!-- 
  path: /ui/report-template-editor.html
  version: 1.5
  date: 2025-09-02
  time: 19:32:00
-->
<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ตัวแก้ไข Template รายงาน - Light Measurement System</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    
    <!-- TinyMCE Rich Text Editor with your API key -->
    <script src="https://cdn.tiny.cloud/1/89apconez9ynna1jgwbnp15ywm4fk8ob84ndx3rcl5ih7q69/tinymce/7/tinymce.min.js" referrerpolicy="origin"></script>

    <style>
        :root {
            --primary-color: #003366;
            --secondary-color: #4a6fa5;
            --background-color: #f8f9fa;
            --card-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        body { font-family: 'Sarabun', sans-serif; background-color: var(--background-color); }
        .main-header { background-color: #ffffff; padding: 1.5rem 2rem; border-radius: 0.5rem; box-shadow: var(--card-shadow); margin-bottom: 2rem; }
        .main-header h1 { color: var(--primary-color); font-weight: 700; margin: 0; }
        .card { border: none; border-radius: 0.5rem; box-shadow: var(--card-shadow); }
        .tag { cursor: pointer; background-color: #e9ecef; border: 1px solid #ced4da; border-radius: 0.25rem; padding: 0.2rem 0.5rem; font-family: monospace; font-size: 0.9em; transition: background-color 0.2s; }
        .tag:hover { background-color: #d1d5db; }
        .tag-group { display: flex; flex-wrap: wrap; gap: 0.5rem; }
        #save-feedback { display: none; position: fixed; bottom: 20px; right: 20px; z-index: 1050; }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark sticky-top" style="background-color: var(--primary-color);">
        <div class="container-fluid"><a class="navbar-brand fw-bold" href="main.html"><i class="fas fa-lightbulb me-2"></i>Light Measurement System</a></div>
    </nav>

    <div class="container-fluid p-4">
        <div class="main-header">
            <h1 class="mt-2"><i class="fas fa-file-invoice me-3"></i>ตัวแก้ไข Template รายงาน</h1>
        </div>

        <div class="row">
            <div class="col-lg-8">
                <div class="card">
                    <div class="card-body p-4">
                        <div class="mb-3">
                            <label for="templateSelector" class="form-label fw-bold">เลือก Template ที่ต้องการแก้ไข:</label>
                            <select class="form-select" id="templateSelector">
                                <option value="full_report">เล่มรายงานฉบับสมบูรณ์</option>
                                <option value="certification">หนังสือรับรอง</option>
                            </select>
                        </div>
                        <hr>
                        <textarea id="report-editor"></textarea>
                        <div class="mt-3 text-end">
                            <button id="saveContentBtn" class="btn btn-primary"><i class="fas fa-save me-2"></i>บันทึกเนื้อหา Template</button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-lg-4">
                 <div class="card sticky-top" style="top: 20px;">
                    <div class="card-body">
                        <h5 class="card-title"><i class="fas fa-tags me-2"></i>Tag ที่ใช้งานได้</h5>
                        <p class="card-text small text-muted">คลิกที่ Tag เพื่อแทรกลงใน Editor</p>
                        <hr>
                        <h6>ข้อมูลทั่วไป</h6>
                        <div class="tag-group" id="tags-general"></div>
                        <h6 class="mt-3">ข้อมูลสรุปผล</h6>
                        <div class="tag-group" id="tags-summary"></div>
                        <h6 class="mt-3">ตารางข้อมูล (สำหรับ .docx)</h6>
                        <div class="tag-group" id="tags-tables"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div id="save-feedback" class="alert alert-success" role="alert">
        <i class="fas fa-check-circle me-2"></i>บันทึก Template สำเร็จ!
    </div>

    <script>
        let activeEditor;

        const allTags = {
            general: ['{jobId}', '{customer}', '{location}', '{date}'],
            summary: ['{spot_pass_count}', '{spot_fail_count}', '{area_pass_count}', '{area_fail_count}'],
            tables: ['{@results_spot}', '{@results_area}'] // These are for loops in docx
        };

        const templateDefaultContent = {
            full_report: `
                <h3>บทนำ</h3>
                <p>บริษัท ห้องปฏิบัติการไทย จำกัด เป็นผู้ดำเนินการติดตามตรวจสอบสภาวะการทำงานเกี่ยวกับระดับความเข้มของแสงสว่าง ของ <strong>{customer} สาขา {location}</strong> (วันที่ {date})</p>
                <hr />
                <h3>สรุปผลการตรวจวัด</h3>
                <ul>
                    <li>ความเข้มแสง (แบบจุด): ผ่าน <strong>{spot_pass_count}</strong> จุด / ไม่ผ่าน <strong>{spot_fail_count}</strong> จุด</li>
                    <li>ความเข้มแสง (แบบพื้นที่): ผ่าน <strong>{area_pass_count}</strong> จุด / ไม่ผ่าน <strong>{area_fail_count}</strong> จุด</li>
                </ul>
                <p>&nbsp;</p>
                <h3>ตารางผลการตรวจวัด (แนบท้าย)</h3>
                <p><em>(ส่วนของตารางจะถูกสร้างขึ้นโดยอัตโนมัติตาม Layout Template .docx ที่คุณอัปโหลด)</em></p>
            `,
            certification: `
                <p>บริษัท ห้องปฏิบัติการไทย จำกัด ได้รับมอบหมายเข้าดำเนินการตรวจวัดและวิเคราะห์คุณภาพสิ่งแวดล้อมของ <strong>{customer} สาขา {location}</strong> เมื่อวันที่ <strong>{date}</strong> โดยผู้ดำเนินการที่ได้การขึ้นทะเบียนตามกรมโรงงานอุตสาหกรรมและกรมสวัสดิการและคุ้มครองแรงงานกำหนด</p>
            `
        };

        const createTagButton = (tag) => {
            const button = document.createElement('button');
            button.className = 'tag btn btn-sm';
            button.textContent = tag;
            button.title = 'คลิกเพื่อแทรก';
            button.addEventListener('click', () => {
                if (activeEditor) {
                    activeEditor.execCommand('mceInsertContent', false, tag);
                }
            });
            return button;
        };

        const loadTemplateContent = (templateKey) => {
            const savedData = localStorage.getItem('reportTemplateContent');
            const contentData = savedData ? JSON.parse(savedData) : {};
            const content = contentData[templateKey] || templateDefaultContent[templateKey];
            if(activeEditor) {
                activeEditor.setContent(content);
            }
        };
        
        tinymce.init({
            selector: '#report-editor',
            plugins: 'lists link image table code help wordcount',
            toolbar: 'undo redo | blocks | bold italic | alignleft aligncenter alignright | bullist numlist | code | help',
            menubar: false,
            setup: (editor) => {
                editor.on('init', () => {
                    activeEditor = editor;
                    loadTemplateContent(document.getElementById('templateSelector').value);
                });
            }
        });

        document.getElementById('tags-general').append(...allTags.general.map(createTagButton));
        document.getElementById('tags-summary').append(...allTags.summary.map(createTagButton));
        document.getElementById('tags-tables').append(...allTags.tables.map(createTagButton));

        document.getElementById('templateSelector').addEventListener('change', (e) => {
            loadTemplateContent(e.target.value);
        });

        document.getElementById('saveContentBtn').addEventListener('click', () => {
            if (!activeEditor) return;
            const templateKey = document.getElementById('templateSelector').value;
            const content = activeEditor.getContent();
            const savedData = localStorage.getItem('reportTemplateContent');
            const contentData = savedData ? JSON.parse(savedData) : {};
            contentData[templateKey] = content;
            localStorage.setItem('reportTemplateContent', JSON.stringify(contentData));

            const feedback = document.getElementById('save-feedback');
            feedback.style.display = 'block';
            setTimeout(() => { feedback.style.display = 'none'; }, 2000);
        });
    </script>
</body>
</html>

