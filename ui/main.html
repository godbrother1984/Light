<!-- 
  path: /ui/main.html
  version: 6.0 (Module System Optimized + Enhanced Navigation)
  date: 2025-09-05
  time: 19:00:00
  description: Fully optimized with clickable rows, proper navigation, and module system
-->
<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏ß‡∏±‡∏î‡πÅ‡∏™‡∏á - Light Measurement System</title>
    
    <!-- External CSS Libraries -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    
    <!-- Custom CSS Modules -->
    <link rel="stylesheet" href="assets/css/main-styles.css">
    <link rel="stylesheet" href="assets/css/sidebar.css">
    <link rel="stylesheet" href="assets/css/components.css">
</head>
<body>
    <div id="wrapper">
        <!-- Sidebar -->
        <div id="sidebar-wrapper">
            <div class="sidebar-heading">
                <div class="sidebar-brand-icon">
                    <i class="fas fa-lightbulb"></i>
                </div>
                <div class="sidebar-brand-text logo-text">
                    <div>Light Meter</div>
                    <small style="font-size: 0.7rem; opacity: 0.8;">System</small>
                </div>
            </div>
            
            <div class="list-group list-group-flush">
                <a href="main.html" class="list-group-item list-group-item-action active">
                    <i class="fas fa-home fa-fw me-3"></i>
                    <span class="menu-text">‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å</span>
                </a>
                <a href="new-job.html" class="list-group-item list-group-item-action">
                    <i class="fas fa-plus-circle fa-fw me-3"></i>
                    <span class="menu-text">‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà</span>
                </a>
                <a href="master-data-manager.html" class="list-group-item list-group-item-action">
                    <i class="fas fa-database fa-fw me-3"></i>
                    <span class="menu-text">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏•‡∏±‡∏Å</span>
                </a>
                <a href="template-manager.html" class="list-group-item list-group-item-action">
                    <i class="fas fa-file-alt fa-fw me-3"></i>
                    <span class="menu-text">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ Template</span>
                </a>
            </div>
        </div>

        <!-- Page Content -->
        <div id="page-content-wrapper">
            <nav class="navbar navbar-expand-lg navbar-light bg-white border-bottom sticky-top">
                <div class="container-fluid">
                    <button class="btn btn-outline-primary me-2" id="sidebarToggle">
                        <i class="fas fa-bars"></i>
                    </button>
                    
                    <ul class="navbar-nav ms-auto d-flex flex-row">
                        <li class="nav-item dropdown">
                            <a class="nav-link dropdown-toggle d-flex align-items-center" href="#" id="userDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                                <i class="fas fa-user-circle fa-2x text-muted"></i>
                            </a>
                            <ul class="dropdown-menu dropdown-menu-end">
                                <li><h6 class="dropdown-header">User Profile</h6></li>
                                <li><a class="dropdown-item" href="#"><span id="user-display">‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠...</span></a></li>
                                <li><hr class="dropdown-divider"></li>
                                <li><a class="dropdown-item" href="#"><small id="debug-info" class="text-muted">‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô...</small></a></li>
                            </ul>
                        </li>
                    </ul>
                </div>
            </nav>

            <main class="container-fluid p-4">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <div>
                        <h1 class="h3 mb-1 text-gradient">‡∏£‡∏∞‡∏ö‡∏ö‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏ß‡∏±‡∏î‡πÅ‡∏™‡∏á</h1>
                        <p class="text-muted mb-0">Light Measurement Recording System üöÄ</p>
                    </div>
                    <div class="d-flex gap-2">
                        <button class="btn btn-primary" onclick="location.href='new-job.html'">
                            <i class="fas fa-plus me-2"></i>‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà
                        </button>
                        <button class="btn btn-outline-primary" onclick="refreshJobList()">
                            <i class="fas fa-sync-alt me-2"></i>‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä
                        </button>
                    </div>
                </div>

                <!-- Alert Placeholder -->
                <div id="alert-placeholder"></div>

                <!-- Stats Cards -->
                <div class="row mb-4">
                    <div class="col-md-3 mb-3">
                        <div class="info-card">
                            <div class="info-card-icon">
                                <i class="fas fa-clipboard-list"></i>
                            </div>
                            <div class="info-card-title">‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div>
                            <div class="info-card-text" id="total-jobs">0 ‡∏á‡∏≤‡∏ô</div>
                        </div>
                    </div>
                    <div class="col-md-3 mb-3">
                        <div class="info-card">
                            <div class="info-card-icon">
                                <i class="fas fa-clock"></i>
                            </div>
                            <div class="info-card-title">‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</div>
                            <div class="info-card-text" id="pending-jobs">0 ‡∏á‡∏≤‡∏ô</div>
                        </div>
                    </div>
                    <div class="col-md-3 mb-3">
                        <div class="info-card">
                            <div class="info-card-icon">
                                <i class="fas fa-check-circle"></i>
                            </div>
                            <div class="info-card-title">‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß</div>
                            <div class="info-card-text" id="completed-jobs">0 ‡∏á‡∏≤‡∏ô</div>
                        </div>
                    </div>
                    <div class="col-md-3 mb-3">
                        <div class="info-card">
                            <div class="info-card-icon">
                                <i class="fas fa-calendar-day"></i>
                            </div>
                            <div class="info-card-title">‡∏á‡∏≤‡∏ô‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</div>
                            <div class="info-card-text" id="today-jobs">0 ‡∏á‡∏≤‡∏ô</div>
                        </div>
                    </div>
                </div>

                <!-- Job List -->
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <i class="fas fa-list me-2"></i>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
                            <small class="text-muted ms-2 fw-normal">(‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ó‡∏µ‡πà‡πÅ‡∏ñ‡∏ß‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î)</small>
                        </h5>
                        <div class="d-flex gap-2">
                            <input type="text" class="form-control form-control-sm" id="search-input" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏á‡∏≤‡∏ô..." style="width: 200px;">
                            <select class="form-select form-select-sm" id="filter-status" style="width: 150px;">
                                <option value="">‡∏ó‡∏∏‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</option>
                                <option value="draft">‡∏£‡πà‡∏≤‡∏á</option>
                                <option value="in-progress">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</option>
                                <option value="completed">‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="card-body p-0">
                        <div class="data-grid">
                            <div class="data-grid-body" id="jobs-container">
                                <div id="loading-state" class="d-flex align-items-center justify-content-center p-5">
                                    <div class="spinner-border text-primary me-3" role="status">
                                        <span class="visually-hidden">Loading...</span>
                                    </div>
                                    <span>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- External JS Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Firebase Config (Load First) -->
    <script src="firebase-config.js"></script>
    
    <!-- Custom JS Modules -->
    <script type="module">
        import { firebaseManager } from './assets/js/firebase-init.js';
        import { showAlert, formatDate, debounce } from './assets/js/ui-helpers.js';

        // Global variables
        let allJobs = [];
        let filteredJobs = [];

        // Update debug info
        function updateDebugInfo(message) {
            const debugElement = document.getElementById('debug-info');
            if (debugElement) {
                debugElement.textContent = `${new Date().toLocaleTimeString()} - ${message}`;
            }
        }

        // Update user display
        function updateUserDisplay() {
            const { auth } = firebaseManager.getInstances();
            const userElement = document.getElementById('user-display');
            
            if (auth && auth.currentUser) {
                const uid = auth.currentUser.uid;
                userElement.textContent = `UID: ${uid.substring(0, 8)}...`;
            } else {
                userElement.textContent = '‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠';
            }
        }

        // Helper function to safely convert Firebase timestamp to Date
        function safeTimestampToDate(timestamp) {
            try {
                if (!timestamp) return null;
                
                if (timestamp.toDate && typeof timestamp.toDate === 'function') {
                    return timestamp.toDate();
                } else if (timestamp.seconds) {
                    return new Date(timestamp.seconds * 1000);
                } else if (timestamp instanceof Date) {
                    return timestamp;
                } else if (typeof timestamp === 'string') {
                    return new Date(timestamp);
                } else if (typeof timestamp === 'number') {
                    return new Date(timestamp);
                }
                
                return null;
            } catch (error) {
                console.warn('Error converting timestamp:', error);
                return null;
            }
        }

        // Render jobs list - SAFE VERSION
        function renderJobs() {
            console.log('üé® Starting renderJobs function...');
            updateDebugInfo(`Rendering ${filteredJobs.length} jobs`);
            
            const container = document.getElementById('jobs-container');
            if (!container) {
                console.error('‚ùå Jobs container not found!');
                return;
            }
            
            if (filteredJobs.length === 0) {
                container.innerHTML = `
                    <div class="empty-state p-5 text-center">
                        <div class="mb-4">
                            <i class="fas fa-inbox fa-4x text-muted"></i>
                        </div>
                        <h4 class="text-muted">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏á‡∏≤‡∏ô</h4>
                        <p class="text-muted">‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÇ‡∏î‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà</p>
                        <button class="btn btn-primary" onclick="location.href='new-job.html'">
                            <i class="fas fa-plus me-2"></i>‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏á‡∏≤‡∏ô‡πÅ‡∏£‡∏Å
                        </button>
                    </div>
                `;
                console.log('üìù Rendered empty state');
                return;
            }
            
            try {
                const jobsHtml = filteredJobs.map(job => {
                    try {
                        return createJobCard(job);
                    } catch (cardError) {
                        console.error('Error creating card for job:', job.id, cardError);
                        return `<div class="alert alert-warning m-2">Error rendering job: ${job.id}</div>`;
                    }
                }).join('');
                
                container.innerHTML = jobsHtml;
                console.log(`‚úÖ Successfully rendered ${filteredJobs.length} jobs`);
                updateDebugInfo(`‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ ${filteredJobs.length} ‡∏á‡∏≤‡∏ô`);
                
            } catch (error) {
                console.error('‚ùå Error rendering jobs:', error);
                container.innerHTML = `
                    <div class="alert alert-danger m-3">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏á‡∏≤‡∏ô: ${error.message}
                    </div>
                `;
                updateDebugInfo(`Error: ${error.message}`);
            }
        }

        // Create job card HTML
        function createJobCard(job) {
            const statusBadge = getStatusBadge(job.status);
            
            let createdDate = '‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö';
            const jobDate = safeTimestampToDate(job.createdAt);
            if (jobDate) {
                createdDate = formatDate(jobDate);
            }
            
            const customerName = job.customerName || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤';
            const location = job.location || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà';
            
            return `
                <div class="data-grid-row clickable-row" onclick="location.href='job-details.html?id=${job.id}'" title="‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î">
                    <div class="row align-items-center">
                        <div class="col-md-3">
                            <div class="fw-bold text-primary">
                                <i class="fas fa-eye me-2"></i>${job.id}
                            </div>
                            <small class="text-muted">${createdDate}</small>
                        </div>
                        <div class="col-md-3">
                            <div class="fw-semibold">${customerName}</div>
                            <small class="text-muted"><i class="fas fa-map-marker-alt me-1"></i>${location}</small>
                        </div>
                        <div class="col-md-2">
                            ${statusBadge}
                        </div>
                        <div class="col-md-2">
                            <div class="small text-muted">
                                ‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à: ${job.results?.length || 0} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
                            </div>
                        </div>
                        <div class="col-md-2 text-end">
                            <div class="btn-group btn-group-sm">
                                <button class="btn btn-outline-primary btn-sm" onclick="event.stopPropagation(); editJob('${job.id}')" title="‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn btn-outline-success btn-sm" onclick="event.stopPropagation(); generateReport('${job.id}')" title="‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô">
                                    <i class="fas fa-file-pdf"></i>
                                </button>
                                <button class="btn btn-outline-danger btn-sm" onclick="event.stopPropagation(); deleteJob('${job.id}')" title="‡∏•‡∏ö">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        // Get status badge
        function getStatusBadge(status) {
            const badges = {
                'draft': '<span class="badge bg-secondary">‡∏£‡πà‡∏≤‡∏á</span>',
                'in-progress': '<span class="badge bg-warning">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</span>',
                'completed': '<span class="badge bg-success">‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô</span>'
            };
            return badges[status] || '<span class="badge bg-light text-dark">‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</span>';
        }

        // Update statistics
        function updateStats() {
            document.getElementById('total-jobs').textContent = `${allJobs.length} ‡∏á‡∏≤‡∏ô`;
            
            const pendingJobs = allJobs.filter(job => job.status === 'draft' || job.status === 'in-progress');
            document.getElementById('pending-jobs').textContent = `${pendingJobs.length} ‡∏á‡∏≤‡∏ô`;
            
            const completedJobs = allJobs.filter(job => job.status === 'completed');
            document.getElementById('completed-jobs').textContent = `${completedJobs.length} ‡∏á‡∏≤‡∏ô`;
            
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            const todayJobs = allJobs.filter(job => {
                const jobDate = safeTimestampToDate(job.createdAt);
                if (!jobDate) return false;
                
                const jobDateOnly = new Date(jobDate);
                jobDateOnly.setHours(0, 0, 0, 0);
                return jobDateOnly.getTime() === today.getTime();
            });
            
            document.getElementById('today-jobs').textContent = `${todayJobs.length} ‡∏á‡∏≤‡∏ô`;
        }

        // Initialize application
        async function initializeApp() {
            try {
                console.log('üöÄ Starting application initialization...');
                updateDebugInfo('‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö...');
                
                const success = await firebaseManager.initialize();
                if (!success) {
                    showAlert('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ', 'danger');
                    updateDebugInfo('‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß');
                    return;
                }

                // Update user display after Firebase init
                updateUserDisplay();

                setupEventListeners();
                await loadJobs();
                
                updateDebugInfo('‡∏£‡∏∞‡∏ö‡∏ö‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô');
                
            } catch (error) {
                console.error('App initialization error:', error);
                showAlert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö', 'danger');
                updateDebugInfo(`Error: ${error.message}`);
            }
        }

        // Setup event listeners
        function setupEventListeners() {
            document.getElementById('sidebarToggle').addEventListener('click', () => {
                document.getElementById('wrapper').classList.toggle('sidebar-mini');
            });
            
            const searchInput = document.getElementById('search-input');
            searchInput.addEventListener('input', debounce(handleSearch, 300));
            
            const filterStatus = document.getElementById('filter-status');
            filterStatus.addEventListener('change', handleSearch);
            
            window.refreshJobList = loadJobs;
        }

        // Load jobs from Firebase
        async function loadJobs() {
            try {
                console.log('üìä Loading jobs from Firebase...');
                updateDebugInfo('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏á‡∏≤‡∏ô...');

                const unsubscribe = firebaseManager.listenToCollection(
                    'jobs',
                    (snapshot) => {
                        console.log(`üì¶ Received ${snapshot.size} jobs from Firebase`);
                        updateDebugInfo(`‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ${snapshot.size} ‡∏á‡∏≤‡∏ô`);
                        
                        allJobs = [];
                        snapshot.forEach((doc) => {
                            const jobData = doc.data();
                            allJobs.push({
                                id: doc.id,
                                ...jobData
                            });
                        });
                        
                        allJobs.sort((a, b) => {
                            const dateA = safeTimestampToDate(a.createdAt) || new Date(0);
                            const dateB = safeTimestampToDate(b.createdAt) || new Date(0);
                            return dateB.getTime() - dateA.getTime();
                        });
                        
                        console.log(`‚úÖ Successfully processed ${allJobs.length} jobs`);
                        
                        filteredJobs = [...allJobs];
                        renderJobs();
                        updateStats();
                    }
                );

                window.jobsUnsubscribe = unsubscribe;
                
            } catch (error) {
                console.error('Error loading jobs:', error);
                showAlert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•', 'danger');
                updateDebugInfo(`Error: ${error.message}`);
            }
        }

        // Handle search and filter
        function handleSearch() {
            const searchTerm = document.getElementById('search-input').value.toLowerCase();
            const statusFilter = document.getElementById('filter-status').value;
            
            filteredJobs = allJobs.filter(job => {
                const matchesSearch = !searchTerm || 
                    job.id.toLowerCase().includes(searchTerm) ||
                    (job.customerName || '').toLowerCase().includes(searchTerm) ||
                    (job.location || '').toLowerCase().includes(searchTerm);
                
                const matchesStatus = !statusFilter || job.status === statusFilter;
                
                return matchesSearch && matchesStatus;
            });
            
            renderJobs();
        }

        // Global functions for job actions
        window.editJob = (jobId) => location.href = `new-job.html?id=${jobId}&from=main`;
        window.generateReport = (jobId) => location.href = `report-finalizer.html?id=${jobId}`;
        window.deleteJob = async (jobId) => {
            if (!confirm('‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏á‡∏≤‡∏ô‡∏ô‡∏µ‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')) return;
            
            try {
                await firebaseManager.deleteDocument('jobs', jobId);
                showAlert('‡∏•‡∏ö‡∏á‡∏≤‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß', 'success');
            } catch (error) {
                console.error('Delete job error:', error);
                showAlert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏á‡∏≤‡∏ô', 'danger');
            }
        };

        // Initialize app when DOM is loaded
        document.addEventListener('DOMContentLoaded', initializeApp);

        // Cleanup on page unload
        window.addEventListener('beforeunload', () => {
            if (window.jobsUnsubscribe) {
                window.jobsUnsubscribe();
            }
        });
    </script>
</body>
</html>