<!-- 
  path: /ui/main.html
  version: 4.2 (Restored Full Functionality)
  date: 2025-09-03
  time: 11:31:00
-->
<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ระบบบันทึกผลการตรวจวัดแสง - Light Measurement System</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">

    <style>
        :root {
            --primary-color: #0d47a1;
            --secondary-color: #1976d2;
            --background-color: #f4f7f9;
            --sidebar-width: 260px;
            --sidebar-mini-width: 80px;
            --card-shadow: 0 2px 10px rgba(0,0,0,0.05);
            --transition-speed: 0.3s;
        }
        *, *::before, *::after { box-sizing: border-box; }
        body { font-family: 'Sarabun', sans-serif !important; background-color: var(--background-color); overflow-x: hidden; }
        #wrapper { display: flex; }
        #sidebar-wrapper { width: var(--sidebar-width); min-height: 100vh; background-color: var(--primary-color); transition: width var(--transition-speed) ease; }
        #wrapper.sidebar-mini #sidebar-wrapper { width: var(--sidebar-mini-width); }
        .sidebar-heading { padding: 1rem 1.25rem; font-size: 1.5rem; font-weight: 700; color: #fff; white-space: nowrap; }
        .sidebar-heading .logo-text { display: inline; transition: opacity var(--transition-speed) ease; }
        #wrapper.sidebar-mini .sidebar-heading .logo-text { opacity: 0; display: none; }
        .list-group-item { border: none; padding: 1rem 1.5rem; color: rgba(255,255,255,0.8); background-color: transparent; transition: background-color var(--transition-speed) ease; white-space: nowrap; display: flex; align-items: center; }
        .list-group-item i { font-size: 1.25rem; }
        .list-group-item .menu-text { opacity: 1; transition: opacity 0.2s ease; }
        #wrapper.sidebar-mini .list-group-item .menu-text { opacity: 0; display: none; }
        .list-group-item:hover, .list-group-item.active { background-color: var(--secondary-color); color: #fff; }
        #page-content-wrapper { flex-grow: 1; transition: margin-left var(--transition-speed) ease; padding-left: 0; }
        .navbar { box-shadow: var(--card-shadow); }
        .navbar-nav .nav-link { color: #555; }
        .navbar-nav .nav-link:hover { color: var(--primary-color); }
        .dropdown-item:active { background-color: var(--primary-color); }
        .search-form { width: 300px; }
        .card { box-shadow: var(--card-shadow); border: none; border-radius: .5rem; }
        .btn-primary { background-color: var(--primary-color); border-color: var(--primary-color); }
    </style>
</head>
<body>
    
    <div class="d-flex" id="wrapper">

        <!-- Sidebar -->
        <div id="sidebar-wrapper">
            <div class="sidebar-heading"><i class="fas fa-lightbulb me-2"></i><span class="logo-text">Light Measuring</span></div>
            <div class="list-group list-group-flush">
                <a class="list-group-item active" href="main.html"><i class="fas fa-tasks fa-fw me-3"></i><span class="menu-text">รายการงานทั้งหมด</span></a>
                <a class="list-group-item" href="master-data-manager.html"><i class="fas fa-database fa-fw me-3"></i><span class="menu-text">จัดการข้อมูลหลัก</span></a>
                <a class="list-group-item" href="template-manager.html"><i class="fas fa-file-alt fa-fw me-3"></i><span class="menu-text">จัดการ Template</span></a>
            </div>
        </div>

        <!-- Page Content Wrapper -->
        <div id="page-content-wrapper">
            <nav class="navbar navbar-expand-lg navbar-light bg-white border-bottom sticky-top">
                <div class="container-fluid">
                    <button class="btn btn-outline-primary me-2" id="sidebarToggle"><i class="fas fa-bars"></i></button>
                    <form class="d-none d-md-flex input-group w-auto my-auto search-form">
                      <input autocomplete="off" type="search" id="searchInput" class="form-control rounded" placeholder="ค้นหางาน..."/>
                      <span class="input-group-text border-0"><i class="fas fa-search"></i></span>
                    </form>
                    <ul class="navbar-nav ms-auto d-flex flex-row">
                        <li class="nav-item dropdown">
                            <a class="nav-link dropdown-toggle d-flex align-items-center" href="#" id="userDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                                <i class="fas fa-user-circle fa-2x text-muted"></i>
                            </a>
                            <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="userDropdown">
                                <li><h6 class="dropdown-header">User Profile</h6></li>
                                <li><a class="dropdown-item" href="#"><span id="user-display">Connecting...</span></a></li>
                            </ul>
                        </li>
                    </ul>
                </div>
            </nav>

            <main class="container-fluid p-4">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h1 class="h3">รายการงานตรวจวัดทั้งหมด (All Jobs)</h1>
                    <a href="new-job.html" class="btn btn-primary">
                        <i class="fas fa-plus-circle me-2"></i> สร้างงานใหม่
                    </a>
                </div>
                <div class="card">
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover align-middle">
                                <thead class="table-light">
                                    <tr>
                                        <th>Job ID</th><th>ชื่อลูกค้า</th><th>สถานที่</th><th>วันที่ตรวจวัด</th><th>สถานะ</th><th class="text-center">การดำเนินการ</th>
                                    </tr>
                                </thead>
                                <tbody id="job-list-table">
                                    <tr><td colspan="6" class="text-center p-5"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div></td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="firebase-config.js"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        let allJobs = [];

        const renderJobs = (jobs) => {
            const jobTableBody = document.getElementById('job-list-table');
            if (jobs.length === 0) {
                jobTableBody.innerHTML = '<tr><td colspan="6" class="text-center p-4">ยังไม่มีงานในระบบ</td></tr>';
                return;
            }

            jobTableBody.innerHTML = jobs.map(job => {
                const jobData = job.data();
                let statusBadge;
                switch (jobData.status) {
                    case 'completed': statusBadge = `<span class="badge bg-success">เสร็จสิ้น</span>`; break;
                    case 'in-progress': statusBadge = `<span class="badge bg-warning text-dark">กำลังดำเนินการ</span>`; break;
                    default: statusBadge = `<span class="badge bg-secondary">ใหม่</span>`;
                }
                return `
                    <tr>
                        <td><span class="badge bg-dark">${job.id}</span></td>
                        <td>${jobData.customer || ''}</td>
                        <td>${jobData.location || ''}</td>
                        <td>${jobData.date || ''}</td>
                        <td>${statusBadge}</td>
                        <td class="text-center">
                            <a href="job-details.html?id=${job.id}" class="btn btn-sm btn-outline-secondary"><i class="fas fa-pencil-alt me-1"></i>ดู/แก้ไข</a>
                            <a href="report-finalizer.html?id=${job.id}" class="btn btn-sm btn-outline-primary"><i class="fas fa-file-pdf me-1"></i>สร้างรายงาน</a>
                        </td>
                    </tr>
                `;
            }).join('');
        };

        const filterJobs = () => {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            if (!searchTerm) {
                renderJobs(allJobs);
                return;
            }
            const filtered = allJobs.filter(job => {
                const data = job.data();
                return job.id.toLowerCase().includes(searchTerm) ||
                       (data.customer && data.customer.toLowerCase().includes(searchTerm)) ||
                       (data.location && data.location.toLowerCase().includes(searchTerm));
            });
            renderJobs(filtered);
        };
        
        async function main() {
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'light-measuring-app';
            const userDisplay = document.getElementById('user-display');
            const jobTableBody = document.getElementById('job-list-table');

            let finalFirebaseConfig;
            try {
                if (typeof __firebase_config !== 'undefined') finalFirebaseConfig = JSON.parse(__firebase_config);
                else if (window.firebaseConfig && window.firebaseConfig.projectId) finalFirebaseConfig = window.firebaseConfig;
            } catch(e) { console.error(e); }

            if (!finalFirebaseConfig) {
                jobTableBody.innerHTML = '<tr><td colspan="6" class="text-center text-danger">ไม่พบ Firebase Config</td></tr>';
                return;
            }

            try {
                const app = initializeApp(finalFirebaseConfig);
                const db = getFirestore(app);
                const auth = getAuth(app);

                if (typeof __initial_auth_token !== 'undefined') await signInWithCustomToken(auth, __initial_auth_token);
                else await signInAnonymously(auth);
                
                userDisplay.textContent = `UID: ${auth.currentUser.uid.substring(0, 8)}...`;
                
                const jobsCollectionRef = collection(db, `/artifacts/${appId}/public/data/jobs`);
                
                onSnapshot(jobsCollectionRef, 
                    (snapshot) => {
                        allJobs = snapshot.docs;
                        filterJobs(); // Initial render
                    },
                    (error) => {
                        console.error("Firestore error: ", error);
                        jobTableBody.innerHTML = `<tr><td colspan="6" class="text-center text-danger">เกิดข้อผิดพลาดในการดึงข้อมูล: ${error.message}</td></tr>`;
                    }
                );
                
                document.getElementById('searchInput').addEventListener('keyup', filterJobs);

            } catch (error) {
                console.error("Initialization error:", error);
                userDisplay.textContent = 'การเชื่อมต่อล้มเหลว';
                jobTableBody.innerHTML = `<tr><td colspan="6" class="text-center text-danger">การเชื่อมต่อ Firebase ล้มเหลว: ${error.message}</td></tr>`;
            }
        }
        
        main();
    </script>
    <script>
        document.getElementById('sidebarToggle').addEventListener('click', () => {
            document.getElementById('wrapper').classList.toggle('sidebar-mini');
        });
    </script>
</body>
</html>

