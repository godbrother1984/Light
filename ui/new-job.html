<!DOCTYPE html>
<!-- 
  path: /ui/new-job.html
  version: 3.0 (Complete Refactored - Final Working Version)
  date: 2025-09-04
  time: 22:15:00
  description: New job creation page - Fully refactored with module system and working Firebase integration
-->
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>สร้างงานใหม่ | ระบบบันทึกผลการตรวจวัดแสง</title>
    
    <!-- External CSS Libraries -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    
    <!-- Custom CSS Modules -->
    <link rel="stylesheet" href="assets/css/main-styles.css">
    <link rel="stylesheet" href="assets/css/sidebar.css">
    <link rel="stylesheet" href="assets/css/components.css">
</head>
<body>
    <div id="wrapper">
        <!-- Sidebar -->
        <div id="sidebar-wrapper">
            <div class="sidebar-heading">
                <div class="sidebar-brand-icon">
                    <i class="fas fa-lightbulb"></i>
                </div>
                <div class="sidebar-brand-text logo-text">
                    <div>Light Meter</div>
                    <small style="font-size: 0.7rem; opacity: 0.8;">System</small>
                </div>
            </div>
            
            <div class="list-group list-group-flush">
                <a href="main.html" class="list-group-item list-group-item-action">
                    <i class="fas fa-home fa-fw me-3"></i>
                    <span class="menu-text">หน้าแรก</span>
                </a>
                <a href="new-job.html" class="list-group-item list-group-item-action active">
                    <i class="fas fa-plus-circle fa-fw me-3"></i>
                    <span class="menu-text">สร้างงานใหม่</span>
                </a>
                <a href="master-data-manager.html" class="list-group-item list-group-item-action">
                    <i class="fas fa-database fa-fw me-3"></i>
                    <span class="menu-text">จัดการข้อมูลหลัก</span>
                </a>
                <a href="template-manager.html" class="list-group-item list-group-item-action">
                    <i class="fas fa-file-alt fa-fw me-3"></i>
                    <span class="menu-text">จัดการ Template</span>
                </a>
            </div>
        </div>

        <!-- Page Content -->
        <div id="page-content-wrapper">
            <!-- Navigation -->
            <nav class="navbar navbar-expand-lg navbar-light bg-white border-bottom">
                <div class="container-fluid">
                    <button class="btn btn-outline-secondary me-3" id="sidebarToggle">
                        <i class="fas fa-bars"></i>
                    </button>

                    <h1 class="h4 mb-0 me-auto" id="page-title">สร้างงานใหม่</h1>

                    <ul class="navbar-nav ms-auto">
                        <li class="nav-item dropdown">
                            <a class="nav-link dropdown-toggle" href="#" id="userDropdown" role="button" data-bs-toggle="dropdown">
                                <i class="fas fa-user-circle fa-2x"></i>
                            </a>
                            <ul class="dropdown-menu dropdown-menu-end">
                                <li><h6 class="dropdown-header">User Profile</h6></li>
                                <li><span class="dropdown-item-text" id="user-display">Connecting...</span></li>
                            </ul>
                        </li>
                    </ul>
                </div>
            </nav>

            <!-- Main Content -->
            <div class="container-fluid p-4">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <div>
                        <h1 class="h3 mb-1">สร้างงานใหม่</h1>
                        <p class="text-muted mb-0">กรอกข้อมูลเพื่อสร้างงานตรวจวัดใหม่</p>
                    </div>
                    <a href="main.html" class="btn btn-outline-secondary">
                        <i class="fas fa-arrow-left me-2"></i>กลับหน้าหลัก
                    </a>
                </div>

                <!-- Alert Placeholder -->
                <div id="alert-placeholder"></div>

                <!-- Form -->
                <form id="newJobForm">
                    <input type="hidden" id="edit-job-id" value="">
                    
                    <!-- Customer Information -->
                    <div class="card mb-4 shadow-sm">
                        <div class="card-header bg-primary text-white">
                            <h5 class="mb-0">
                                <i class="fas fa-building me-2"></i>ข้อมูลลูกค้า
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label for="customer-select" class="form-label fw-bold">ชื่อลูกค้า <span class="text-danger">*</span></label>
                                    <select id="customer-select" class="form-select" required>
                                        <option value="">-- เลือกลูกค้า --</option>
                                    </select>
                                </div>
                                <div class="col-md-6">
                                    <label for="branch-select" class="form-label fw-bold">สาขา / สถานที่ <span class="text-danger">*</span></label>
                                    <select id="branch-select" class="form-select" required>
                                        <option value="">-- เลือกสาขา --</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div class="row g-3 mt-2">
                                <div class="col-12">
                                    <label for="address" class="form-label fw-bold">ที่อยู่ <span class="text-danger">*</span></label>
                                    <textarea id="address" class="form-control" rows="3" required placeholder="กรอกที่อยู่สำหรับการตรวจวัด..."></textarea>
                                </div>
                            </div>
                            
                            <div class="row g-3 mt-2">
                                <div class="col-md-6">
                                    <label for="contact-person" class="form-label fw-bold">ผู้ติดต่อ</label>
                                    <input type="text" id="contact-person" class="form-control" placeholder="ชื่อผู้ติดต่อ">
                                </div>
                                <div class="col-md-6">
                                    <label for="phone" class="form-label fw-bold">เบอร์โทรศัพท์</label>
                                    <input type="tel" id="phone" class="form-control" placeholder="หมายเลขโทรศัพท์">
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Job Details -->
                    <div class="card mb-4 shadow-sm">
                        <div class="card-header bg-success text-white">
                            <h5 class="mb-0">
                                <i class="fas fa-calendar-alt me-2"></i>รายละเอียดงาน
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label for="inspection-date" class="form-label fw-bold">วันที่ตรวจวัด <span class="text-danger">*</span></label>
                                    <input type="date" id="inspection-date" class="form-control" required>
                                </div>
                                <div class="col-md-6">
                                    <label for="inspection-time" class="form-label fw-bold">เวลาตรวจวัด</label>
                                    <input type="time" id="inspection-time" class="form-control">
                                </div>
                            </div>
                            
                            <div class="row g-3 mt-2">
                                <div class="col-12">
                                    <label for="work-description" class="form-label fw-bold">รายละเอียดงาน</label>
                                    <textarea id="work-description" class="form-control" rows="3" placeholder="ระบุรายละเอียดงานการตรวจวัด เช่น ประเภทการตรวจวัด, พื้นที่ที่ต้องตรวจ, ข้อกำหนดพิเศษ..."></textarea>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Team Information -->
                    <div class="card mb-4 shadow-sm">
                        <div class="card-header bg-info text-white">
                            <h5 class="mb-0">
                                <i class="fas fa-users me-2"></i>ทีมงาน
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label for="inspector-select" class="form-label fw-bold">ผู้ตรวจวัด <span class="text-danger">*</span></label>
                                    <select id="inspector-select" class="form-select" required>
                                        <option value="">-- เลือกผู้ตรวจวัด --</option>
                                    </select>
                                </div>
                                <div class="col-md-6">
                                    <label for="supervisor-select" class="form-label fw-bold">ผู้ควบคุม</label>
                                    <select id="supervisor-select" class="form-select">
                                        <option value="">-- เลือกผู้ควบคุม --</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Equipment Information -->
                    <div class="card mb-4 shadow-sm">
                        <div class="card-header bg-warning text-white">
                            <h5 class="mb-0">
                                <i class="fas fa-tools me-2"></i>เครื่องมือ
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="row g-3">
                                <div class="col-md-8">
                                    <label for="instrument-select" class="form-label fw-bold">เครื่องมือตรวจวัด <span class="text-danger">*</span></label>
                                    <select id="instrument-select" class="form-select" required>
                                        <option value="">-- เลือกเครื่องมือ --</option>
                                    </select>
                                </div>
                                <div class="col-md-4">
                                    <label for="calibration-date" class="form-label fw-bold">วันที่สอบเทียบล่าสุด</label>
                                    <input type="date" id="calibration-date" class="form-control" readonly style="background-color: #f8f9fa;">
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Notes -->
                    <div class="card mb-4 shadow-sm">
                        <div class="card-header bg-secondary text-white">
                            <h5 class="mb-0">
                                <i class="fas fa-sticky-note me-2"></i>หมายเหตุ
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="row g-3">
                                <div class="col-12">
                                    <textarea id="notes" class="form-control" rows="3" placeholder="หมายเหตุเพิ่มเติม เช่น ข้อมูลสำคัญ, เงื่อนไขพิเศษ, ข้อควรระวัง..."></textarea>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Action Buttons -->
                    <div class="d-flex justify-content-end gap-3">
                        <button type="button" class="btn btn-outline-secondary btn-lg" id="clear-form-btn">
                            <i class="fas fa-eraser me-2"></i>ล้างข้อมูล
                        </button>
                        <button type="submit" class="btn btn-success btn-lg" id="save-job-btn">
                            <i class="fas fa-save me-2"></i>บันทึกงาน
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Loading Modal -->
    <div class="modal fade" id="loadingModal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-body text-center p-5">
                    <div class="spinner-border text-primary mb-3" style="width: 3rem; height: 3rem;" role="status">
                        <span class="visually-hidden">กำลังประมวลผล...</span>
                    </div>
                    <h5 class="modal-title mb-2">กำลังบันทึกข้อมูล</h5>
                    <p class="text-muted mb-0">กรุณารอสักครู่...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Success Modal -->
    <div class="modal fade" id="successModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-body text-center p-5">
                    <div class="text-success mb-3">
                        <i class="fas fa-check-circle" style="font-size: 4rem;"></i>
                    </div>
                    <h4 class="text-success mb-3">สำเร็จ!</h4>
                    <p id="success-message" class="mb-4">บันทึกข้อมูลงานสำเร็จ</p>
                    <button type="button" class="btn btn-success" id="redirect-btn">
                        <i class="fas fa-arrow-right me-2"></i>ไปหน้ารายละเอียดงาน
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Firebase Config -->
    <script src="firebase-config.js"></script>
    
    <!-- Main Application Script -->
    <script type="module">
        import { firebaseManager } from './assets/js/firebase-init.js';
        import { showAlert } from './assets/js/ui-helpers.js';

        // Global variables
        let isInitialized = false;
        const editJobId = new URLSearchParams(window.location.search).get('edit');

        // Simple alert function with better styling
        function displayAlert(message, type = 'info', duration = 5000) {
            const alertPlaceholder = document.getElementById('alert-placeholder');
            if (!alertPlaceholder) return;

            const iconMap = {
                success: 'fas fa-check-circle',
                danger: 'fas fa-exclamation-circle',
                warning: 'fas fa-exclamation-triangle',
                info: 'fas fa-info-circle'
            };

            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type} alert-dismissible fade show shadow-sm`;
            alertDiv.innerHTML = `
                <div class="d-flex align-items-center">
                    <i class="${iconMap[type] || iconMap.info} me-2"></i>
                    <span>${message}</span>
                </div>
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            
            alertPlaceholder.appendChild(alertDiv);
            
            if (duration > 0) {
                setTimeout(() => {
                    if (alertDiv && alertDiv.parentNode) {
                        alertDiv.classList.remove('show');
                        setTimeout(() => alertDiv.remove(), 150);
                    }
                }, duration);
            }
        }

        // Initialize Firebase and application
        async function initializeApplication() {
            try {
                displayAlert('กำลังเชื่อมต่อระบบ...', 'info', 3000);
                
                await firebaseManager.initialize();
                document.getElementById('user-display').textContent = 'เชื่อมต่อสำเร็จ';
                
                setupUI();
                await loadMasterData();
                setupFormHandlers();
                
                if (editJobId) {
                    await loadExistingJobData();
                    document.getElementById('page-title').textContent = 'แก้ไขงาน';
                    document.getElementById('save-job-btn').innerHTML = '<i class="fas fa-save me-2"></i>อัปเดตงาน';
                }
                
                isInitialized = true;
                displayAlert('เชื่อมต่อระบบสำเร็จ', 'success', 3000);
                
            } catch (error) {
                console.error('Application initialization failed:', error);
                displayAlert('เกิดข้อผิดพลาดในการเชื่อมต่อระบบ', 'danger');
            }
        }

        // Setup UI components
        function setupUI() {
            // Set default date to today
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('inspection-date').value = today;

            // Setup sidebar toggle
            const sidebarToggle = document.getElementById('sidebarToggle');
            const wrapper = document.getElementById('wrapper');

            if (sidebarToggle) {
                sidebarToggle.addEventListener('click', () => {
                    if (window.innerWidth <= 768) {
                        wrapper.classList.toggle('sidebar-toggled');
                    } else {
                        wrapper.classList.toggle('sidebar-mini');
                    }
                });
            }
        }

        // Load master data from Firebase
        async function loadMasterData() {
            try {
                displayAlert('กำลังโหลดข้อมูล...', 'info', 2000);

                // Load all master data concurrently
                const [customersData, inspectorsData, instrumentsData] = await Promise.all([
                    firebaseManager.getDocuments('customers'),
                    firebaseManager.getDocuments('inspectors'), 
                    firebaseManager.getDocuments('instruments')
                ]);

                populateCustomerSelect(customersData);
                populateInspectorSelects(inspectorsData);
                populateInstrumentSelect(instrumentsData);

                displayAlert('โหลดข้อมูลสำเร็จ', 'success', 2000);

            } catch (error) {
                console.error('Error loading master data:', error);
                displayAlert('เกิดข้อผิดพลาดในการโหลดข้อมูล', 'warning');
            }
        }

        // Populate customer dropdown
        function populateCustomerSelect(customers) {
            const customerSelect = document.getElementById('customer-select');
            customerSelect.innerHTML = '<option value="">-- เลือกลูกค้า --</option>';
            
            customers.forEach(customer => {
                const customerData = customer.data;
                const option = document.createElement('option');
                option.value = customer.id;
                option.textContent = customerData.customerName || customerData.name || 'ไม่ระบุชื่อ';
                option.dataset.customerData = JSON.stringify(customerData);
                customerSelect.appendChild(option);
            });

            // Handle customer selection change
            customerSelect.addEventListener('change', function() {
                const selectedOption = this.options[this.selectedIndex];
                if (selectedOption.value && selectedOption.dataset.customerData) {
                    const customerData = JSON.parse(selectedOption.dataset.customerData);
                    populateBranchSelect(customerData.branches || []);
                } else {
                    populateBranchSelect([]);
                }
            });
        }

        // Populate branch dropdown
        function populateBranchSelect(branches) {
            const branchSelect = document.getElementById('branch-select');
            branchSelect.innerHTML = '<option value="">-- เลือกสาขา --</option>';
            
            branches.forEach(branch => {
                const option = document.createElement('option');
                option.value = branch.branchCode || branch.name;
                option.textContent = branch.branchName || branch.name;
                option.dataset.branchData = JSON.stringify(branch);
                branchSelect.appendChild(option);
            });

            // Handle branch selection change
            branchSelect.addEventListener('change', function() {
                const selectedOption = this.options[this.selectedIndex];
                if (selectedOption.value && selectedOption.dataset.branchData) {
                    const branchData = JSON.parse(selectedOption.dataset.branchData);
                    // Auto-fill address and phone
                    document.getElementById('address').value = branchData.address || '';
                    document.getElementById('phone').value = branchData.phone || '';
                }
            });
        }

        // Populate inspector dropdowns
        function populateInspectorSelects(inspectors) {
            const inspectorSelect = document.getElementById('inspector-select');
            const supervisorSelect = document.getElementById('supervisor-select');
            
            // Clear existing options
            inspectorSelect.innerHTML = '<option value="">-- เลือกผู้ตรวจวัด --</option>';
            supervisorSelect.innerHTML = '<option value="">-- เลือกผู้ควบคุม --</option>';
            
            inspectors.forEach(inspector => {
                const inspectorData = inspector.data;
                const displayName = `${inspectorData.inspectorName || inspectorData.name} - ${inspectorData.inspectorTitle || inspectorData.title || ''}`;
                
                // Add to inspector select
                const option1 = document.createElement('option');
                option1.value = inspectorData.inspectorName || inspectorData.name;
                option1.textContent = displayName;
                inspectorSelect.appendChild(option1);

                // Add to supervisor select
                const option2 = document.createElement('option');
                option2.value = inspectorData.inspectorName || inspectorData.name;
                option2.textContent = displayName;
                supervisorSelect.appendChild(option2);
            });
        }

        // Populate instrument dropdown
        function populateInstrumentSelect(instruments) {
            const instrumentSelect = document.getElementById('instrument-select');
            const calibrationDate = document.getElementById('calibration-date');
            
            instrumentSelect.innerHTML = '<option value="">-- เลือกเครื่องมือ --</option>';
            
            instruments.forEach(instrument => {
                const instrumentData = instrument.data;
                const option = document.createElement('option');
                option.value = instrumentData.instrumentName || instrumentData.name;
                option.textContent = `${instrumentData.instrumentName || instrumentData.name} (S/N: ${instrumentData.serialNo || 'N/A'})`;
                option.dataset.calibrationDate = instrumentData.calibrationDueDate || '';
                instrumentSelect.appendChild(option);
            });

            // Handle instrument selection change
            instrumentSelect.addEventListener('change', function() {
                const selectedOption = this.options[this.selectedIndex];
                calibrationDate.value = selectedOption.dataset.calibrationDate || '';
            });
        }

        // Setup form event handlers
        function setupFormHandlers() {
            const form = document.getElementById('newJobForm');
            const clearBtn = document.getElementById('clear-form-btn');

            // Form submission handler
            form.addEventListener('submit', async function(e) {
                e.preventDefault();
                if (!isInitialized) {
                    displayAlert('ระบบยังไม่พร้อม กรุณารอสักครู่', 'warning');
                    return;
                }
                await handleFormSubmission();
            });

            // Clear form handler
            clearBtn.addEventListener('click', function() {
                if (confirm('คุณต้องการล้างข้อมูลทั้งหมดหรือไม่?')) {
                    form.reset();
                    document.getElementById('branch-select').innerHTML = '<option value="">-- เลือกสาขา --</option>';
                    document.getElementById('calibration-date').value = '';
                    document.getElementById('inspection-date').value = new Date().toISOString().split('T')[0];
                    displayAlert('ล้างข้อมูลสำเร็จ', 'info', 2000);
                }
            });
        }

        // Load existing job data for editing
        async function loadExistingJobData() {
            try {
                displayAlert('กำลังโหลดข้อมูลงาน...', 'info');
                
                const jobData = await firebaseManager.getDocument('jobs', editJobId);
                
                if (jobData && jobData.data) {
                    const data = jobData.data;
                    
                    // Fill form with existing data
                    document.getElementById('customer-select').value = data.customerId || '';
                    document.getElementById('customer-select').dispatchEvent(new Event('change'));
                    
                    // Delay to allow branch dropdown to populate
                    setTimeout(() => {
                        document.getElementById('branch-select').value = data.branchCode || '';
                        document.getElementById('address').value = data.address || '';
                        document.getElementById('contact-person').value = data.contactPerson || '';
                        document.getElementById('phone').value = data.phone || '';
                        document.getElementById('inspection-date').value = data.date || '';
                        document.getElementById('inspection-time').value = data.time || '';
                        document.getElementById('work-description').value = data.description || '';
                        document.getElementById('inspector-select').value = data.inspector || '';
                        document.getElementById('supervisor-select').value = data.supervisor || '';
                        document.getElementById('instrument-select').value = data.instrument || '';
                        document.getElementById('notes').value = data.notes || '';
                        
                        // Trigger instrument change to set calibration date
                        document.getElementById('instrument-select').dispatchEvent(new Event('change'));
                    }, 800);
                    
                    displayAlert('โหลดข้อมูลงานสำเร็จ', 'success', 3000);
                } else {
                    displayAlert('ไม่พบข้อมูลงานที่ต้องการแก้ไข', 'warning');
                }
            } catch (error) {
                console.error('Error loading job data:', error);
                displayAlert('เกิดข้อผิดพลาดในการโหลดข้อมูลงาน', 'danger');
            }
        }

        // Handle form submission
        async function handleFormSubmission() {
            try {
                // Show loading modal
                const loadingModal = new bootstrap.Modal(document.getElementById('loadingModal'));
                loadingModal.show();

                // Collect and validate form data
                const formData = collectFormData();
                if (!validateFormData(formData)) {
                    loadingModal.hide();
                    return;
                }

                // Save job data
                let jobId;
                if (editJobId) {
                    await firebaseManager.updateDocument('jobs', editJobId, formData);
                    jobId = editJobId;
                } else {
                    jobId = await firebaseManager.addDocument('jobs', formData);
                }

                // Hide loading modal
                loadingModal.hide();

                // Show success modal
                const successModal = new bootstrap.Modal(document.getElementById('successModal'));
                const successMessage = document.getElementById('success-message');
                successMessage.textContent = editJobId ? 'อัปเดตข้อมูลงานสำเร็จ!' : 'สร้างงานใหม่สำเร็จ!';
                
                // Setup redirect button
                const redirectBtn = document.getElementById('redirect-btn');
                redirectBtn.onclick = () => {
                    window.location.href = `job-details.html?id=${jobId}`;
                };
                
                successModal.show();

                // Auto redirect after 3 seconds
                setTimeout(() => {
                    window.location.href = `job-details.html?id=${jobId}`;
                }, 3000);

            } catch (error) {
                console.error('Error saving job:', error);
                
                // Hide loading modal
                const loadingModal = bootstrap.Modal.getInstance(document.getElementById('loadingModal'));
                if (loadingModal) loadingModal.hide();
                
                displayAlert('เกิดข้อผิดพลาดในการบันทึกข้อมูล: ' + error.message, 'danger');
            }
        }

        // Collect form data
        function collectFormData() {
            const customerSelect = document.getElementById('customer-select');
            const branchSelect = document.getElementById('branch-select');
            
            return {
                customerId: customerSelect.value,
                customerName: customerSelect.options[customerSelect.selectedIndex].textContent,
                branchCode: branchSelect.value,
                branchName: branchSelect.options[branchSelect.selectedIndex].textContent,
                address: document.getElementById('address').value,
                contactPerson: document.getElementById('contact-person').value,
                phone: document.getElementById('phone').value,
                date: document.getElementById('inspection-date').value,
                time: document.getElementById('inspection-time').value,
                description: document.getElementById('work-description').value,
                inspector: document.getElementById('inspector-select').value,
                supervisor: document.getElementById('supervisor-select').value,
                instrument: document.getElementById('instrument-select').value,
                notes: document.getElementById('notes').value,
                status: 'รอดำเนินการ',
                results: [] // Initialize empty results array
            };
        }

        // Validate form data
        function validateFormData(formData) {
            const requiredFields = [
                { field: 'customerId', name: 'ลูกค้า' },
                { field: 'branchCode', name: 'สาขา' },
                { field: 'address', name: 'ที่อยู่' },
                { field: 'date', name: 'วันที่ตรวจวัด' },
                { field: 'inspector', name: 'ผู้ตรวจวัด' },
                { field: 'instrument', name: 'เครื่องมือตรวจวัด' }
            ];

            for (const { field, name } of requiredFields) {
                if (!formData[field] || formData[field].trim() === '') {
                    displayAlert(`กรุณากรอก${name}`, 'warning');
                    document.getElementById(field === 'customerId' ? 'customer-select' : 
                                          field === 'branchCode' ? 'branch-select' :
                                          field === 'date' ? 'inspection-date' :
                                          field === 'inspector' ? 'inspector-select' :
                                          field === 'instrument' ? 'instrument-select' : field).focus();
                    return false;
                }
            }

            // Validate date (not in the past)
            const selectedDate = new Date(formData.date);
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            if (selectedDate < today) {
                displayAlert('วันที่ตรวจวัดไม่สามารถเป็นวันที่ผ่านมาแล้วได้', 'warning');
                document.getElementById('inspection-date').focus();
                return false;
            }

            return true;
        }

        // Initialize application when DOM is loaded
        document.addEventListener('DOMContentLoaded', initializeApplication);

        // Handle page visibility change to reconnect if needed
        document.addEventListener('visibilitychange', function() {
            if (!document.hidden && !isInitialized) {
                console.log('Page became visible, attempting to reinitialize...');
                initializeApplication();
            }
        });

        // Global error handler
        window.addEventListener('error', function(e) {
            console.error('Global error:', e.error);
            displayAlert('เกิดข้อผิดพลาดในระบบ กรุณาลองใหม่อีกครั้ง', 'danger');
        });

        // Prevent form submission on Enter key in select elements
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && (e.target.tagName === 'SELECT' || e.target.tagName === 'INPUT')) {
                e.preventDefault();
            }
        });
    </script>

    <!-- Minimal page-specific styles only -->
    <style>
        .card:hover {
            transform: translateY(-1px);
            transition: all 0.2s ease;
        }
        
        .form-label.fw-bold {
            color: #495057;
            font-size: 0.85rem;
            margin-bottom: 0.25rem;
        }
        
        .btn {
            padding: 0.5rem 1rem;
            font-weight: 500;
        }
        
        .text-danger {
            font-weight: 600;
        }
        
        .card-header {
            padding: 0.5rem 1rem;
        }
        
        .card-body {
            padding: 1rem;
        }

        /* Compact form controls */
        .form-control-sm, .form-select-sm {
            padding: 0.375rem 0.5rem;
            font-size: 0.9rem;
        }

        /* Smaller gaps */
        .row.g-2 > * {
            padding-left: 0.5rem;
            padding-right: 0.5rem;
        }
    </style>
</body>
</html>