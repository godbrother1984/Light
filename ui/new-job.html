<!-- 
  path: /ui/new-job.html
  version: 1.5
  date: 2025-09-02
  time: 19:10:00
-->
<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>สร้างงานใหม่ - Light Measurement System</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/choices.js/public/assets/styles/choices.min.css"/>

    <style>
        :root {
            --primary-color: #003366;
            --secondary-color: #4a6fa5;
            --background-color: #f8f9fa;
            --text-color: #333;
            --header-text-color: #ffffff;
            --card-shadow: 0 4px 8px rgba(0,0,0,0.1);
            --border-color: #dee2e6;
        }

        body {
            font-family: 'Sarabun', sans-serif;
            background-color: var(--background-color);
            color: var(--text-color);
        }

        .navbar {
            background-color: var(--primary-color);
        }

        .navbar-brand {
            color: var(--header-text-color) !important;
            font-weight: 700;
        }

        .main-header {
            background-color: #ffffff;
            padding: 1.5rem 2rem;
            border-radius: 0.5rem;
            box-shadow: var(--card-shadow);
            margin-bottom: 2rem;
        }
        
        .main-header h1 {
            color: var(--primary-color);
            font-weight: 700;
            margin: 0;
        }
        
        .breadcrumb-item a {
            color: var(--secondary-color);
            text-decoration: none;
        }

        .card {
            border: none;
            border-radius: 0.5rem;
            box-shadow: var(--card-shadow);
        }
        
        .form-label {
            font-weight: 500;
        }
    </style>
</head>
<body>

    <!-- Navigation Bar -->
    <nav class="navbar navbar-expand-lg navbar-dark sticky-top">
        <div class="container-fluid">
            <a class="navbar-brand" href="main.html">
                <i class="fas fa-lightbulb me-2"></i>
                Light Measurement System
            </a>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="container-fluid p-4">
        
        <div class="main-header">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="main.html">รายการงานตรวจวัดแสง</a></li>
                    <li class="breadcrumb-item active" aria-current="page">สร้างงานใหม่</li>
                </ol>
            </nav>
            <h1 class="mt-2"><i class="fas fa-plus-circle me-3"></i>สร้างงานตรวจวัดใหม่</h1>
        </div>

        <div class="card">
            <div class="card-body p-4">
                <div id="alert-container"></div>
                <form id="new-job-form">
                    <div class="row g-4">
                        <!-- Customer Information -->
                        <div class="col-12">
                            <h5 class="text-primary border-bottom pb-2 mb-3"><i class="fas fa-building me-2"></i>ข้อมูลลูกค้า</h5>
                        </div>
                        <div class="col-md-6">
                            <label for="customerName" class="form-label">ชื่อลูกค้า</label>
                            <select id="customerName" placeholder="ค้นหาหรือเลือกชื่อลูกค้า..."></select>
                        </div>
                        <div class="col-md-6">
                            <label for="customerBranch" class="form-label">สาขา / สถานที่</label>
                            <select id="customerBranch" placeholder="เลือกสาขา..."></select>
                        </div>
                        <div class="col-12">
                            <label for="customerAddress" class="form-label">ที่อยู่</label>
                            <textarea class="form-control" id="customerAddress" rows="3" placeholder="ที่อยู่จะแสดงอัตโนมัติเมื่อเลือกสาขา" readonly></textarea>
                        </div>
                        <div class="col-md-6">
                            <label for="contactPerson" class="form-label">ผู้ประสานงาน</label>
                            <input type="text" class="form-control" id="contactPerson" placeholder="ชื่อผู้ประสานงาน" readonly>
                        </div>
                         <div class="col-md-6">
                            <label for="contactPhone" class="form-label">เบอร์โทรศัพท์ติดต่อ</label>
                            <input type="tel" class="form-control" id="contactPhone" placeholder="เบอร์โทรศัพท์" readonly>
                        </div>

                        <!-- Job Details -->
                        <div class="col-12 mt-5">
                            <h5 class="text-primary border-bottom pb-2 mb-3"><i class="fas fa-info-circle me-2"></i>รายละเอียดงาน</h5>
                        </div>
                        <div class="col-md-6">
                            <label for="measurementDate" class="form-label">วันที่กำหนดตรวจวัด</label>
                            <input type="date" class="form-control" id="measurementDate" required>
                        </div>
                        <div class="col-md-6">
                            <label for="assignedPerson" class="form-label">ผู้รับผิดชอบการตรวจวัด</label>
                            <select id="assignedPerson" placeholder="เลือกผู้รับผิดชอบ..."></select>
                        </div>
                        <div class="col-md-6">
                            <label for="referenceStandard" class="form-label">มาตรฐานอ้างอิง</label>
                            <select id="referenceStandard" placeholder="เลือกมาตรฐาน..."></select>
                        </div>
                        <div class="col-12">
                            <label for="jobNotes" class="form-label">หมายเหตุเพิ่มเติม</label>
                            <textarea class="form-control" id="jobNotes" rows="3" placeholder="ระบุรายละเอียดเพิ่มเติม (ถ้ามี)"></textarea>
                        </div>
                    </div>

                    <div class="mt-4 pt-3 border-top text-end">
                        <button type="button" class="btn btn-secondary" onclick="window.location.href='main.html'">
                            <i class="fas fa-times-circle me-2"></i>ยกเลิก
                        </button>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save me-2"></i>บันทึกและสร้างงาน
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/choices.js/public/assets/scripts/choices.min.js"></script>
    
    <!-- Firebase Configuration -->
    <script src="firebase-config.js"></script>

    <!-- Firebase SDK and Form Logic -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        (async () => {
             // --- UI Elements ---
            const form = document.getElementById('new-job-form');
            const alertContainer = document.getElementById('alert-container');
            const choicesConfig = { searchEnabled: true, itemSelectText: 'กดเพื่อเลือก' };

            const showAlert = (message, type = 'danger') => {
                const wrapper = document.createElement('div');
                wrapper.innerHTML = [
                    `<div class="alert alert-${type} alert-dismissible fade show" role="alert">`,
                    `   <div>${message}</div>`,
                    '   <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>',
                    '</div>'
                ].join('');
                alertContainer.innerHTML = ''; // Clear previous alerts
                alertContainer.append(wrapper);
            };
            
            // --- Mock Data ---
            const customersData = [
                { id: 1, name: 'ธนาคารกรุงเทพ จำกัด (มหาชน)' },
                { id: 2, name: 'บริษัท ABC Manufacturing จำกัด' },
            ];
            const branchesData = {
                1: [ { id: 101, name: 'สาขาฉะเชิงเทรา', address: '191/74 ถ.มหาจักรพรรดิ์ ต.หน้าเมือง อ.เมือง จ.ฉะเชิงเทรา 24000', contact: 'คุณสมหญิง จริงใจ', phone: '038-514982' } ],
                2: [ { id: 201, name: 'โรงงานสมุทรปราการ', address: '123/4 หมู่ 5 ต.บางปูใหม่ อ.เมือง จ.สมุทรปราการ 10280', contact: 'คุณวิชัย มีมานะ', phone: '02-324-0000' } ]
            };
            const assignedPersonData = [ 'นายณัฐวัฒน์ สินอนันต์', 'นางสาวดุษฎี วรรณหาร', 'นางสาวสุกานดา คำก๋อง'];
            const standardData = [ 'กฎกระทรวงฯ พ.ศ. 2559', 'มาตรฐาน IESNA' ];

            // --- Initialize Choices.js ---
            const customerSelect = new Choices('#customerName', choicesConfig);
            const branchSelect = new Choices('#customerBranch', choicesConfig);
            const personSelect = new Choices('#assignedPerson', choicesConfig);
            const standardSelect = new Choices('#referenceStandard', choicesConfig);

            customerSelect.setChoices(customersData.map(c => ({ value: c.id, label: c.name })), 'value', 'label', false);
            personSelect.setChoices(assignedPersonData.map(p => ({ value: p, label: p })), 'value', 'label', false);
            standardSelect.setChoices(standardData.map(s => ({ value: s, label: s })), 'value', 'label', false);
            branchSelect.disable();

            // --- Dynamic Dropdown Logic ---
            document.getElementById('customerName').addEventListener('change', function(event) {
                const customerId = event.detail.value;
                branchSelect.clearStore();
                const branches = branchesData[customerId] || [];
                if (branches.length > 0) {
                     branchSelect.setChoices(branches.map(b => ({ value: b.id, label: b.name, customProperties: b })), 'value', 'label', false);
                    branchSelect.enable();
                } else { branchSelect.disable(); }
                document.getElementById('customerAddress').value = '';
                document.getElementById('contactPerson').value = '';
                document.getElementById('contactPhone').value = '';
            });

            document.getElementById('customerBranch').addEventListener('change', function(event) {
                const selectedChoice = branchSelect.getValue(); // Get the full choice object
                if (selectedChoice && selectedChoice.customProperties) {
                     const branchDetails = selectedChoice.customProperties;
                     document.getElementById('customerAddress').value = branchDetails.address || '';
                     document.getElementById('contactPerson').value = branchDetails.contact || '';
                     document.getElementById('contactPhone').value = branchDetails.phone || '';
                }
            });
            document.getElementById('measurementDate').valueAsDate = new Date();

            // --- Firebase Initialization ---
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'light-measurement-app';
            let finalFirebaseConfig;
            try {
                const envConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
                if (envConfig && envConfig.projectId) finalFirebaseConfig = envConfig;
                else if (window.firebaseConfig && window.firebaseConfig.projectId) finalFirebaseConfig = window.firebaseConfig;
            } catch (e) { console.error("Config Error", e); }
            if (!finalFirebaseConfig) {
                showAlert("Firebase config not found. Cannot save data.");
                return;
            }
            const app = initializeApp(finalFirebaseConfig);
            const db = getFirestore(app);
            const auth = getAuth(app);
            setLogLevel('debug');

            // --- Form Submission Logic ---
            form.addEventListener('submit', async (e) => {
                e.preventDefault();
                const submitButton = e.submitter;
                submitButton.disabled = true;
                submitButton.innerHTML = `<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> กำลังบันทึก...`;

                try {
                    // Authenticate first
                    if (!auth.currentUser) {
                         if (typeof __initial_auth_token !== 'undefined') {
                            await signInWithCustomToken(auth, __initial_auth_token);
                        } else {
                            await signInAnonymously(auth);
                        }
                    }

                    // Generate a new Job ID
                    const year = new Date().getFullYear() + 543;
                    const timestamp = Date.now().toString().slice(-5);
                    const jobId = `JOB-${year}-${timestamp}`;

                    const newJobData = {
                        jobId: jobId,
                        customer: customerSelect.getValue(true) ? customersData.find(c => c.id == customerSelect.getValue(true))?.name : '',
                        location: branchSelect.getValue(true) ? (branchesData[customerSelect.getValue(true)] || []).find(b => b.id == branchSelect.getValue(true))?.name : '',
                        address: document.getElementById('customerAddress').value,
                        contactPerson: document.getElementById('contactPerson').value,
                        contactPhone: document.getElementById('contactPhone').value,
                        date: document.getElementById('measurementDate').value,
                        assignedPerson: personSelect.getValue(true) || '',
                        standard: standardSelect.getValue(true) || '',
                        notes: document.getElementById('jobNotes').value,
                        status: 'new',
                        results: []
                    };
                    
                    // Save to Firestore using the generated jobId as document ID
                    const jobsCollectionPath = `/artifacts/${appId}/public/data/jobs`;
                    await setDoc(doc(db, jobsCollectionPath, jobId), newJobData);

                    // Redirect to the new job's detail page
                    window.location.href = `job-details.html?id=${jobId}`;

                } catch (error) {
                    console.error("Error creating new job:", error);
                    showAlert(`เกิดข้อผิดพลาดในการสร้างงาน: ${error.message}`);
                    submitButton.disabled = false;
                    submitButton.innerHTML = `<i class="fas fa-save me-2"></i>บันทึกและสร้างงาน`;
                }
            });

        })();
    </script>
</body>
</html>

