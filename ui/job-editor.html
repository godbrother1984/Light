<!-- 
  path: /ui/job-editor.html
  version: 3.1 (Fixed: Use Firebase Modular SDK v9+)
  date: 2025-09-03
  time: 20:45:00
-->
<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="pageTitle">สร้างงานใหม่ - Light Measurement System</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/choices.js/public/assets/styles/choices.min.css"/>

    <style>
        :root {
            --primary-color: #0d47a1;
            --secondary-color: #1976d2;
            --background-color: #f4f7f9;
            --sidebar-width: 260px;
            --sidebar-mini-width: 80px;
            --card-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            --font-family: 'Sarabun', sans-serif;
        }
        body {
            font-family: var(--font-family);
            background-color: var(--background-color);
            color: #333;
        }
        #wrapper { display: flex; }
        #sidebar-wrapper {
            width: var(--sidebar-width);
            background: linear-gradient(180deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            color: white;
            transition: width 0.3s ease;
            display: flex;
            flex-direction: column;
            height: 100vh;
            position: sticky;
            top: 0;
        }
        #sidebar-wrapper .sidebar-heading {
            padding: 1.5rem 1.25rem;
            font-size: 1.5rem;
            font-weight: 700;
            text-align: center;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        #sidebar-wrapper .sidebar-heading .logo { font-size: 2rem; }
        #sidebar-wrapper .list-group {
            flex-grow: 1;
            width: 100%;
            overflow-y: auto;
        }
        .list-group-item {
            background-color: transparent;
            color: rgba(255, 255, 255, 0.8);
            border: none;
            padding: 1rem 1.5rem;
            font-size: 1.05rem;
            transition: all 0.2s ease-in-out;
        }
        .list-group-item i {
            margin-right: 15px;
            font-size: 1.2rem;
            width: 25px;
            text-align: center;
        }
        .list-group-item:hover, .list-group-item.active {
            background-color: rgba(255, 255, 255, 0.15);
            color: white;
            border-left: 5px solid #ffc107;
            padding-left: calc(1.5rem - 5px);
        }
        .sidebar-footer { padding: 1rem; text-align: center; font-size: 0.8rem; color: rgba(255, 255, 255, 0.6); }
        #page-content-wrapper { width: 100%; transition: margin-left 0.3s ease; }
        .navbar {
            box-shadow: 0 2px 4px rgba(0,0,0,.08);
            background-color: #fff;
        }
        .card {
            border: none;
            border-radius: 0.75rem;
            box-shadow: var(--card-shadow);
            overflow: hidden;
        }
        .card-header {
            background-color: #fff;
            padding: 1.25rem 1.5rem;
            font-weight: 600;
            font-size: 1.2rem;
            border-bottom: 1px solid #e9ecef;
        }
        .form-label { font-weight: 500; }
        .choices__inner { border-radius: 0.375rem; }
        .choices[data-type*="select-one"] .choices__inner { padding-bottom: 0.5rem; }
        .btn-primary { background-color: var(--primary-color); border: none; }
        .btn-primary:hover { background-color: #0b3a82; }
        #wrapper.sidebar-mini #sidebar-wrapper { width: var(--sidebar-mini-width); }
        #wrapper.sidebar-mini .sidebar-heading .text-logo,
        #wrapper.sidebar-mini .list-group-item .item-text,
        #wrapper.sidebar-mini .sidebar-footer { display: none; }
        #wrapper.sidebar-mini .sidebar-heading { padding-left: 0; padding-right: 0; }
        #wrapper.sidebar-mini .list-group-item i { margin-right: 0; }
        #wrapper.sidebar-mini #page-content-wrapper { margin-left: 0; }
    </style>
</head>
<body>
    <div id="wrapper">
        <!-- Sidebar -->
        <div id="sidebar-wrapper">
            <div class="sidebar-heading">
                <i class="fas fa-lightbulb logo"></i>
                <span class="text-logo">Light System</span>
            </div>
            <div class="list-group list-group-flush">
                <a href="main.html" class="list-group-item"><i class="fas fa-home"></i><span class="item-text">หน้าหลัก</span></a>
                <a href="job-editor.html" class="list-group-item active"><i class="fas fa-plus-circle"></i><span class="item-text">สร้าง/แก้ไขงาน</span></a>
                <a href="master-data-manager.html" class="list-group-item"><i class="fas fa-database"></i><span class="item-text">จัดการข้อมูลหลัก</span></a>
                <a href="template-manager.html" class="list-group-item"><i class="fas fa-file-alt"></i><span class="item-text">จัดการ Template</span></a>
                 <a href="report-finalizer.html" class="list-group-item"><i class="fas fa-file-pdf"></i><span class="item-text">สร้างรายงาน PDF</span></a>
            </div>
            <div class="sidebar-footer">
                <small>Version 1.0.0</small>
            </div>
        </div>
        <!-- /#sidebar-wrapper -->

        <!-- Page Content -->
        <div id="page-content-wrapper">
            <nav class="navbar navbar-expand-lg navbar-light bg-white border-bottom">
                <div class="container-fluid">
                    <button class="btn btn-sm btn-outline-secondary" id="sidebarToggle"><i class="fas fa-bars"></i></button>
                    <div class="ms-auto" id="userDisplay">กำลังเชื่อมต่อ...</div>
                </div>
            </nav>

            <main class="container-fluid p-4">
                <div class="row">
                    <div class="col-12">
                        <h1 class="h3 mb-4" id="mainHeader">สร้างงานใหม่</h1>
                    </div>
                </div>
                <div class="row">
                    <div class="col-lg-12">
                        <div class="card">
                            <div class="card-header" id="cardHeader">กรอกรายละเอียดข้อมูลงาน</div>
                            <div class="card-body p-4">
                                <form id="jobForm">
                                    <div class="row mb-3">
                                        <div class="col-md-6">
                                            <label for="jobId" class="form-label">Job ID (รหัสงาน)</label>
                                            <input type="text" class="form-control" id="jobId" required>
                                            <div class="form-text">เช่น J2568-001 (หากเว้นว่าง ระบบจะสร้างให้)</div>
                                        </div>
                                        <div class="col-md-6">
                                            <label for="measurementDate" class="form-label">วันที่เข้าตรวจวัด</label>
                                            <input type="date" class="form-control" id="measurementDate" required>
                                        </div>
                                    </div>
                                    <div class="row mb-3">
                                        <div class="col-md-6">
                                            <label for="customer" class="form-label">ลูกค้า</label>
                                            <select id="customer" class="form-select" required></select>
                                        </div>
                                        <div class="col-md-6">
                                            <label for="location" class="form-label">สาขา/พื้นที่</label>
                                            <select id="location" class="form-select" required></select>
                                        </div>
                                    </div>
                                    <div class="row mb-3">
                                        <div class="col-md-4">
                                            <label for="inspectors" class="form-label">ผู้ตรวจวัด</label>
                                            <select id="inspectors" class="form-select" multiple></select>
                                        </div>
                                        <div class="col-md-4">
                                            <label for="analysts" class="form-label">ผู้วิเคราะห์</label>
                                            <select id="analysts" class="form-select" multiple></select>
                                        </div>
                                        <div class="col-md-4">
                                            <label for="reportCreator" class="form-label">ผู้จัดทำรายงาน</label>
                                            <select id="reportCreator" class="form-select"></select>
                                        </div>
                                    </div>
                                    <div class="row mb-4">
                                        <div class="col-12">
                                            <label for="jobNotes" class="form-label">หมายเหตุ (ถ้ามี)</label>
                                            <textarea class="form-control" id="jobNotes" rows="3"></textarea>
                                        </div>
                                    </div>
                                    <div id="alert-container" class="mb-3"></div>
                                    <div class="d-flex justify-content-end">
                                        <button type="submit" id="submitButton" class="btn btn-primary btn-lg px-5">
                                            <i class="fas fa-save me-2"></i><span id="submitButtonText">บันทึกและสร้างงาน</span>
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/choices.js/public/assets/scripts/choices.min.js"></script>
    
    <!-- Firebase Modular SDK -->
    <script src="firebase-config.js"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, onAuthStateChanged, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, getDoc, updateDoc, getDocs, query, where } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        
        const app = initializeApp(window.firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        const userDisplay = document.getElementById('userDisplay');
        const form = document.getElementById('jobForm');
        
        let customerSelect, locationSelect, inspectorSelect, analystSelect, reportCreatorSelect;
        let customersData = [];
        let locationsData = [];
        let editMode = false;
        let currentJobDocId = null;

        function showAlert(message, type = 'danger') {
            const alertContainer = document.getElementById('alert-container');
            alertContainer.innerHTML = `<div class="alert alert-${type}" role="alert">${message}</div>`;
        }
        
        async function loadMasterData() {
            try {
                const customersSnapshot = await getDocs(collection(db, "customers"));
                customersData = customersSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                customerSelect.setChoices(customersData.map(c => ({ value: c.id, label: c.name })), 'value', 'label', true);

                const locationsSnapshot = await getDocs(collection(db, "locations"));
                locationsData = locationsSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                const inspectorsSnapshot = await getDocs(collection(db, "inspectors"));
                const inspectors = inspectorsSnapshot.docs.map(doc => ({ value: doc.data().name, label: `${doc.data().name} (${doc.data().title})` }));
                inspectorSelect.setChoices(inspectors, 'value', 'label', true);
                analystSelect.setChoices(inspectors, 'value', 'label', true);
                reportCreatorSelect.setChoices(inspectors, 'value', 'label', true);
                
                return true;
            } catch (error) {
                showAlert('เกิดข้อผิดพลาดในการโหลด Master Data: ' + error.message);
                return false;
            }
        }
        
        async function loadJobData(jobId) {
            try {
                const jobDocRef = doc(db, "jobs", jobId);
                const jobDocSnap = await getDoc(jobDocRef);

                if (!jobDocSnap.exists()) {
                    showAlert('ไม่พบข้อมูลงานที่ต้องการแก้ไข');
                    return;
                }
                const jobData = jobDocSnap.data();
                
                document.getElementById('jobId').value = jobId;
                document.getElementById('measurementDate').value = jobData.date;
                document.getElementById('jobNotes').value = jobData.notes || '';
                
                customerSelect.setValue(jobData.customer.id);
                
                if (jobData.inspectors) inspectorSelect.setValue(jobData.inspectors);
                if (jobData.analysts) analystSelect.setValue(jobData.analysts);
                if (jobData.reportCreator) reportCreatorSelect.setValue(jobData.reportCreator);

                setTimeout(() => {
                    locationSelect.setValue(jobData.location.id);
                }, 500); 

            } catch (error) {
                showAlert('เกิดข้อผิดพลาดในการโหลดข้อมูลงาน: ' + error.message);
            }
        }

        function setupEventListeners() {
            document.getElementById('customer').addEventListener('change', (event) => {
                const customerId = event.detail.value;
                const relatedLocations = locationsData
                    .filter(l => l.customerId === customerId)
                    .map(l => ({ value: l.id, label: l.name }));
                locationSelect.clearStore();
                locationSelect.setChoices(relatedLocations, 'value', 'label', true);
            });

            form.addEventListener('submit', async (e) => {
                e.preventDefault();
                const submitButton = document.getElementById('submitButton');
                submitButton.disabled = true;
                submitButton.innerHTML = `<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> กำลังบันทึก...`;
                
                try {
                    const selectedCustomerId = customerSelect.getValue(true);
                    const selectedLocationId = locationSelect.getValue(true);
                    const customerDetails = customersData.find(c => c.id === selectedCustomerId);
                    const locationDetails = locationsData.find(l => l.id === selectedLocationId);
                    
                    const jobData = {
                        customer: { id: selectedCustomerId, name: customerDetails.name },
                        location: { id: selectedLocationId, name: locationDetails.name },
                        date: document.getElementById('measurementDate').value,
                        inspectors: inspectorSelect.getValue(true) || [],
                        analysts: analystSelect.getValue(true) || [],
                        reportCreator: reportCreatorSelect.getValue(true) || '',
                        notes: document.getElementById('jobNotes').value
                    };

                    if (editMode) {
                        jobData.updatedBy = auth.currentUser.uid;
                        jobData.updatedAt = new Date().toISOString();
                        const jobDocRef = doc(db, "jobs", currentJobDocId);
                        await updateDoc(jobDocRef, jobData);
                        window.location.href = `job-details.html?id=${currentJobDocId}`;
                    } else {
                        let jobId = document.getElementById('jobId').value.trim();
                        if (!jobId) {
                            const date = new Date(jobData.date);
                            const yearBE = date.getFullYear() + 543;
                            const prefix = `J${yearBE.toString().slice(-2)}`;
                            const q = query(collection(db, "jobs"), where("__name__", ">=", prefix), where("__name__", "<", `${prefix}Z`));
                            const jobsThisYearSnapshot = await getDocs(q);
                            const nextNumber = (jobsThisYearSnapshot.size + 1).toString().padStart(3, '0');
                            jobId = `${prefix}-${nextNumber}`;
                        }
                        
                        jobData.status = 'new';
                        jobData.createdBy = auth.currentUser.uid;
                        jobData.createdAt = new Date().toISOString();
                        jobData.results = [];
                        const jobDocRef = doc(db, "jobs", jobId);
                        await setDoc(jobDocRef, jobData);
                        window.location.href = `job-details.html?id=${jobId}`;
                    }

                } catch (error) {
                    showAlert(`เกิดข้อผิดพลาดในการบันทึกงาน: ${error.message}`);
                    submitButton.disabled = false;
                    submitButton.innerHTML = `<i class="fas fa-save me-2"></i><span id="submitButtonText">${editMode ? 'บันทึกการแก้ไข' : 'บันทึกและสร้างงาน'}</span>`;
                }
            });
        }
        
        async function initializePage() {
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    userDisplay.textContent = `User: ${user.email || user.uid.substring(0,8)}`;
                    
                    const choiceConfig = { searchEnabled: true, removeItemButton: true, shouldSort: false };
                    customerSelect = new Choices('#customer', choice-config);
                    locationSelect = new Choices('#location', choiceConfig);
                    inspectorSelect = new Choices('#inspectors', { ...choiceConfig, maxItemCount: 5 });
                    analystSelect = new Choices('#analysts', { ...choiceConfig, maxItemCount: 5 });
                    reportCreatorSelect = new Choices('#reportCreator', { ...choiceConfig, removeItemButton: false, searchEnabled: true });
                    
                    await loadMasterData();
                    setupEventListeners();
                    
                    const params = new URLSearchParams(window.location.search);
                    currentJobDocId = params.get('id');

                    if (currentJobDocId) {
                        editMode = true;
                        document.getElementById('pageTitle').textContent = 'แก้ไขข้อมูลงาน - Light Measurement System';
                        document.getElementById('mainHeader').textContent = 'แก้ไขข้อมูลงาน';
                        document.getElementById('cardHeader').textContent = `แก้ไขรายละเอียดงาน: ${currentJobDocId}`;
                        document.getElementById('jobId').readOnly = true;
                        document.getElementById('submitButtonText').textContent = 'บันทึกการแก้ไข';
                        await loadJobData(currentJobDocId);
                    } else {
                        document.getElementById('measurementDate').valueAsDate = new Date();
                    }

                } else {
                    await signInAnonymously(auth);
                }
            });
        }
        
        initializePage();
        
        document.getElementById('sidebarToggle').addEventListener('click', () => {
            document.getElementById('wrapper').classList.toggle('sidebar-mini');
        });
    </script>
</body>
</html>